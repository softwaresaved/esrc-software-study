---
title: "Economic and Social Research Council (ESRC) Data"
author: "**Author**: Mario Antonioletti.<br/>"
date: "**Last updated**: `r format(Sys.Date(), '%d/%m/%y')`."
output: 
  github_document:
      toc: true
      number_sections: false
      toc_depth: 4
---

```{r setup, include=FALSE}

# Global knitr options
knitr::opts_chunk$set(echo = TRUE)

# Load packages to be used
library(readr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(stringr)
library(knitr)
library(kableExtra)
library(tidytext)
library(RColorBrewer)
library(leaflet)

# Do not use scientific notation
options(scipen=999)

# Columns to read
input_cols <- cols(
                    FundingOrgName = col_character(),
                    ProjectReference = col_character(),
                    LeadROName = col_character(),
                    Department = col_character(),
                    ProjectCategory = col_character(),
                    PISurname = col_character(),
                    PIFirstName = col_character(),
                    PIOtherNames = col_character(),
                    `PI ORCID iD` = col_character(),
                    StudentSurname = col_character(),
                    StudentFirstName = col_character(),
                    StudentOtherNames = col_character(),
                    `Student ORCID iD` = col_character(),
                    Title = col_character(),
                    StartDate = col_date(format="%d/%m/%Y"),
                    EndDate = col_date(format="%d/%m/%Y"),
                    AwardPounds = col_double(),
                    ExpenditurePounds = col_double(),
                    Region = col_character(),
                    Status = col_character(),
                    GTRProjectUrl = col_character(),
                    ProjectId = col_character(),
                    FundingOrgId = col_character(),
                    LeadROId = col_character(),
                    PIId = col_character()
)

# Read the Gateway to Research data snapshot.
# Data snapshot from 24th February 2022.
gtrdat <- read_csv("../Data/projectsearch-1646403729132.csv.gz",
                   col_types = input_cols)

# Remove EndDate >= 2050 or is an NAs - removes 49 values
# nrow(gtrdat[!is.na(gtrdat$EndDate) & year(gtrdat$EndDate) >= 2050,])
gtrdat <- gtrdat[!is.na(gtrdat$EndDate) & year(gtrdat$EndDate) < 2050,]

# Filter ESRC data - 10834 rows (about 8.9% of the data)
esrcdat <- gtrdat %>% filter(FundingOrgName == "ESRC")


```

# Introduction

The aim of this document is to provide an overview of the awards provided by the [United Kingdom Research and Innovation](https://www.ukri.org/)'s (UKRI) [Economics and Social Sciences Research Council](https://esrc.ukri.org/) (ESRC) as determined from a [Gateway to Research](https://gtr.ukri.org/) (GtR) data snapshot update from the the 24th February 2022 - these data snapshots update come out roughly every month. The data is made available under an [Open Government Licence](https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/), and covers the period from `r format(min(gtrdat$StartDate),"%d/%m/%y")` to `r format(max(gtrdat$EndDate, na.rm = TRUE),"%d/%m/%y")`. 

The R markdown that generated this analysis is available at: 

* https://github.com/softwaresaved/esrc-software-study/blob/main/Src/ESRC.Rmd

The entire data set consists of `r format(nrow(gtrdat), big.mark = ",")` rows for all research councils, where each row corresponds to a record of an award. Within this data set `r format(nrow(gtrdat[gtrdat$FundingOrgName == "ESRC",]), big.mark = ",")` rows (`r scales::percent(nrow(gtrdat[gtrdat$FundingOrgName == "ESRC",])/nrow(gtrdat))`) correspond to ESRC awards.

UK Research Councils were formed in different years (source: [wikipedia](https://en.wikipedia.org/wiki/UK_Research_and_Innovation)) as shown in the table below which has an impact in the interpretation of the data.

| Research Council | Formation |
|----------------- | ----------|
| Arts and Humanities Research Council (AHRC)                       | 2005  |
| Biotechnology and Biological Sciences Research Council (BBSRC)    | 1994  |
| Engineering and Physical Sciences Research Council (EPSRC)        | 1994  |
| Economic and Social Research Council (ESRC)                       | 1965  |
| Medical Research Council	(MRC)                                   | 1913  |
| National Centre for the Replacement, Refinement and Reduction of Animals in Research (NC3RS)  | 2004 |
| Natural Environment Research Council (NERC)                       | 1965  |
| Science and Technology Facilities Council (STFC)                  | 2007  |
| Innovate UK                                                       | 2007  |
| Research England                                                  | 2018  |
| UKRI                                                              | 2018  |

Although, strictly speaking, it was the *Social Science Research Council* (SSRC) that
came into being in 1965, it was not until 1983 that the SSRC was renamed the Economic and Social Research Council (ESRC).

# Overall expenditure

We start by doing a brief overview of all the data obtained from the Gateway to 
Research before we go on to focus on the ESRC data.

## Expenditure for all UKRI projects

Expenditure for the whole period under consideration is shown in the graph below. Awards that do not have an awards value defined have been removed.

```{r funding_ByOrg, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data."}

gtrdat %>% filter(!is.na(AwardPounds))                                   %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6))     %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding organisation") + 
           ylab("Expenditure (million £s)") +
           theme_bw() + scale_y_log10()
          
```

The same information in tabular format:

```{r funding_ByOrgTable, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data in tabular format."}

gtrdat %>% filter(!is.na(AwardPounds))                                     %>% 
           select(FundingOrgName, AwardPounds)                             %>% 
           group_by(FundingOrgName)                                        %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6))       %>% 
           filter(!is.na(TotalExpenditure))                                %>% 
           arrange(desc(TotalExpenditure))                                 %>% 
           mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>%
           kbl(format="pipe", align = c("l","r"), 
               col.names = c("Funding org", "Total awarded (Million £s)"))          
          
```

The number of awards given by each council over the whole data period:

```{r NumberOfAwards_ByOrg, echo = FALSE, fig.alt = "Number of awards across each UKRI councils from the available data."}

gtrdat %>% filter(!is.na(AwardPounds))                                   %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           mutate(N = n())                                               %>% 
           ggplot(aes(x = FundingOrgName, y = N/1e6)) + 
           geom_col(colour="red") +
           xlab("Funding organisation") + 
           ylab("Number of awards (millions)") +
           theme_bw() 
          
```

The average award given by funding council:

```{r AvgAwardPerFundCouncilPlot, echo = FALSE, fig.alt = "Average award size given in pounds per funding council."}

gtrdat %>% filter(!is.na(AwardPounds))                                       %>% 
           select(FundingOrgName, AwardPounds)                               %>% 
           group_by(FundingOrgName)                                          %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)),
                  TotalAwards = n())                                         %>%
           mutate(AvgAward = 
                    as.numeric(round(TotalExpenditure/TotalAwards)))         %>% 
           ggplot(aes(x = FundingOrgName, y = AvgAward)) + 
           geom_col(fill="red", colour = "black") +
           xlab("Funding organisation") + 
           ylab("Average award given (£)") +
           theme_bw() 
```

Average award per founding council ordered by the average award in tabular form:

```{r AvgAwardPerFundCouncil, echo = FALSE, fig.alt = "Average award size per organisation."}

gtrdat %>% filter(!is.na(AwardPounds))                                              %>% 
           select(FundingOrgName, AwardPounds)                                      %>% 
           group_by(FundingOrgName)                                                 %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)),
                  TotalAwards = n())                                                %>%
           mutate(AvgAward = 
                    as.numeric(round(TotalExpenditure/TotalAwards)))                %>% 
           select(FundingOrgName, TotalAwards, TotalExpenditure, AvgAward)          %>% 
           arrange(desc(as.numeric(AvgAward)))                                      %>% 
           mutate(across(where(is.numeric), ~ format(., big.mark = ",")))           %>%
           kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Funding org", "Number of awards",
                                "Total awarded (£)","Average award (£)"))
```

The distribution of awards by research council.

```{r AwardDistrPerFundCouncil, echo = FALSE, fig.alt = "Distribution of award size by research council."}

gtrdat %>% filter(!is.na(AwardPounds) & AwardPounds > 0)                             %>% 
           select(FundingOrgName, AwardPounds)                                       %>% 
           ggplot(aes(x = AwardPounds, fill = FundingOrgName)) + 
           geom_density(alpha = 0.1, na.rm = TRUE) +
           xlab("Size of award (£)") + 
           ylab("Distribution of awards") +
           scale_x_log10() + labs(fill = "Funding Org") +
           theme_bw() 
```

The graph with the values for each research council normalised:

```{r AwardDistrPerFundCouncilScaled, echo = FALSE, fig.alt = "Distribution of award size by research council with the graphs scaled."}

gtrdat %>% filter(!is.na(AwardPounds) & AwardPounds > 0)                             %>% 
           select(FundingOrgName, AwardPounds)                                       %>% 
          group_by(FundingOrgName) %>% 
          mutate(n = n()) %>% 
           ggplot(aes(x = AwardPounds, ..scaled.., fill = FundingOrgName)) + 
           geom_density(alpha = 0.08, na.rm = TRUE) +
           xlab("Size of award (£)") + 
           ylab("Distribution of awards") +
           scale_x_log10() + labs(fill = "Funding Org") +
           theme_bw() 
```

Expenditure by year using the starting year of the award for funds allocated that year per research council:

```{r funding_ByOrgByYear, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data by year."}

gtrdat %>% filter(!is.na(AwardPounds)  & !is.na(StartDate))              %>% 
           select(FundingOrgName, AwardPounds, StartDate)                %>% 
           mutate(year = year(StartDate))                                %>% 
           group_by(year, FundingOrgName)                                %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                   %>% 
           filter(!is.na(TotalExpenditure) & TotalExpenditure > 0)       %>% 
           ggplot(aes(x = year, y = TotalExpenditure, fill = FundingOrgName)) + 
           geom_col(colour="black", na.rm = TRUE) +
           xlab("Year") + labs(fill = "Funding Org") +
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

The same information by percent expenditure for each year.

```{r funding_ByOrgByYearPer, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data by year."}

gtrdat %>% filter(!is.na(AwardPounds)  & !is.na(StartDate))              %>% 
           select(FundingOrgName, AwardPounds, StartDate)                %>% 
           mutate(year = year(StartDate))                                %>% 
           group_by(year, FundingOrgName)                                %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                   %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = year, y = TotalExpenditure, fill = FundingOrgName)) + 
           geom_col(colour="black", position = "fill") +
           xlab("Year") + labs(fill = "Funding Org") +
           ylab("% Expenditure") +
           theme_bw() + scale_y_continuous(labels = scales::percent)

          
```

Although there seems to be historical data for the MRC, ESRC and STFC it seems to make more sense
to start looking at the data from 2008 (this will be applied later).

### Summary

* Over the time covered by the data, EPSRC has been allocated the most money but they also give the most awards so on average they do not give the highest award.
* The MRC have been given the third highest amount but, other than UKRI, they give the second highest average award.
* Of interest to this particular study the ESRC comes in fifth in the total amount awarded and they give the fourth highest number of awards so their average over the research councils comes third.
* At a later point only data from 2008 and onwards will be considered.

## Expenditure for active UKRI projects only 

The graph below only contains values for currently active projects, i.e. whose end date extends beyond
the date at which the GtR data snapshot was produced:

```{r Activefunding_ByOrg_active, echo = FALSE, fig.alt = "Expenditure across all UKRI councils for active projects from the available data."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))              %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6))     %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding Organisation") + 
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

The same information in tabular format:

```{r funding_ByOrgTableActProj, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data in tabular format for active projects."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))                %>% 
           select(FundingOrgName, AwardPounds)                             %>% 
           group_by(FundingOrgName)                                        %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6))       %>% 
           filter(!is.na(TotalExpenditure))                                %>% 
           arrange(desc(TotalExpenditure))                                 %>% 
           mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>%
           kbl(format="pipe", align = c("l","r"), 
               col.names = c("Funding org", "Total awarded (Million £s)"))          
          
```

The number of awards given by each council for active projects:

```{r ActiveNumberOfAwards_ByOrg, echo = FALSE, fig.alt = "Number of awards across each UKRI councils for active projects from the available data."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))              %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           mutate(N = n())                                               %>% 
           ggplot(aes(x = FundingOrgName, y = N/1e6)) + 
           geom_col(colour="red") +
           xlab("Funding organisation") + 
           ylab("Number of awards (millions)") +
           theme_bw() 
          
```

The average award given by funding council for active projects:

```{r AvgAwardPerFundCouncilActProjPlot, echo = FALSE, fig.alt = "Average award size given in pounds per funding council for active projects."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))                  %>% 
           select(FundingOrgName, AwardPounds)                               %>% 
           group_by(FundingOrgName)                                          %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)),
                  TotalAwards = n())                                         %>%
           mutate(AvgAward = 
                    as.numeric(round(TotalExpenditure/TotalAwards)))         %>% 
           ggplot(aes(x = FundingOrgName, y = AvgAward)) + 
           geom_col(fill="red", colour = "black") +
           xlab("Funding organisation") + 
           ylab("Average award given (£)") +
           theme_bw() 
```

Average award per founding council for active projects ordered by the average award:

```{r ActiveAvgAwardPerFundCouncil, echo = FALSE, fig.alt = "Average award size per organisation for active projects."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))                         %>% 
           select(FundingOrgName, AwardPounds)                                      %>% 
           group_by(FundingOrgName)                                                 %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)),
                  TotalAwards = n())                                                %>%
           mutate(AvgAward = 
                    as.numeric(round(TotalExpenditure/TotalAwards)))                %>% 
           select(FundingOrgName, TotalAwards, TotalExpenditure, AvgAward)          %>% 
           arrange(desc(as.numeric(AvgAward)))                                      %>% 
           mutate(across(where(is.numeric), ~ format(., big.mark = ",")))           %>%
           kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Funding org", "Number of awards",
                                "Total awarded (£)","Average award (£)"))
```

The distribution of awards by research council for active projects.

```{r ActiveAwardDistrPerFundCouncil, echo = FALSE, fig.alt = "Distribution of award size by research council for active projects."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds) & AwardPounds > 0)        %>% 
           select(FundingOrgName, AwardPounds)                                       %>% 
           ggplot(aes(x = AwardPounds, fill = FundingOrgName)) + 
           geom_density( alpha = 0.1, na.rm = TRUE) +
           xlab("Size of award (£)") + 
           ylab("Distribution of awards") +
           scale_x_log10() + labs(fill = "Funding Org") +
           theme_bw() 
```

With the densities normalised for each research council:

```{r ActiveAwardDistrPerFundCouncilScaled, echo = FALSE, fig.alt = "Distribution of award size by research council for active projects with the graphs scaled."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds) & AwardPounds > 0)        %>% 
           select(FundingOrgName, AwardPounds)                                       %>% 
           ggplot(aes(x = AwardPounds, ..scaled.., fill = FundingOrgName)) + 
           geom_density( alpha = 0.1, na.rm = TRUE) +
           xlab("Size of award (£)") + 
           ylab("Distribution of awards") +
           scale_x_log10() + labs(fill = "Funding Org") +
           theme_bw() 
```


Expenditure by year using the starting year of the award for funds allocated that year per research council for active projects:

```{r funding_ByOrgByYearAct, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data by year."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds) & 
                    !is.na(StartDate))                                   %>% 
           select(FundingOrgName, AwardPounds, StartDate)                %>% 
           mutate(year = year(StartDate))                                %>% 
           group_by(year, FundingOrgName)                                %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                   %>% 
           filter(!is.na(TotalExpenditure) & TotalExpenditure > 0)       %>% 
           ggplot(aes(x = year, y = TotalExpenditure, fill = FundingOrgName)) + 
           geom_col(colour="black", na.rm = TRUE) +
           xlab("Year") + labs(fill = "Funding Org") +
           ylab("Expenditure (million of £s)") +
           theme_bw() + scale_y_log10()
          
```

```{r funding_ByOrgByYearActPer, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data by year."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds)
                  & !is.na(StartDate))                                   %>% 
           select(FundingOrgName, AwardPounds, StartDate)                %>% 
           mutate(year = year(StartDate))                                %>% 
           group_by(year, FundingOrgName)                                %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                   %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = year, y = TotalExpenditure, fill = FundingOrgName)) + 
           geom_col(colour="black", position = "fill") +
           xlab("Year") + labs(fill = "Funding Org") +
           ylab("% Expenditure") +
           theme_bw() + scale_y_continuous(labels = scales::percent)

          
```

# ESRC data

## Project category awards

### All projects category awards

The project categories for the ESRC awards covers the period `r format(min(esrcdat$StartDate),"%d/%m/%y")` to `r format(max(esrcdat$EndDate, na.rm = TRUE),"%d/%m/%y")` (project start dates - to project end dates).  However, as previously stated data only projects that started from 2008 onwards will be considered from 
this point onwards reduces the number of records from `r format(nrow(esrcdat), big.mark = ",")` to `r format(nrow(esrcdat[year(esrcdat$StartDate) >= 2008,]), big.mark = ",")`.

```{r start_dates_from_2008,  echo = FALSE}

# Only consider ESRC projects whose start project >= 2008
esrcdat <- esrcdat[year(esrcdat$StartDate) >= 2008,]
```


No explicit expenditure data seems to be provided for *Studentships*. Data is sorted by the average award.

```{r esrc_categories, echo = FALSE, alt.fig ="Expenditure over time showing project categories."}

# Look at the project categories
esrcdat %>% select(ProjectCategory, AwardPounds)                              %>% 
            group_by(ProjectCategory)                                         %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))            %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2))) %>% 
            arrange(desc(AverageAward))                                       %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))    %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 
```

The same diagram with each year shown as a percentage:

```{r esrc_categoriesByYear, echo = FALSE, alt.fig ="Expenditure as a percentage over time showing project categories."}

# Look at the project categories
esrcdat %>% select(ProjectCategory, AwardPounds, StartDate)                %>% 
            mutate(Year = year(StartDate))                                 %>% 
            group_by(Year, ProjectCategory)                                %>% 
            summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                     %>% 
            filter(!is.na(TotalExpenditure) & TotalExpenditure > 0)        %>% 
            ggplot(aes(x = Year, y = TotalExpenditure, fill = ProjectCategory)) + 
            geom_col(colour="black") +
            xlab("Year") + labs(fill = "Project Category") +
            ylab("Expenditure (million £s)") +
            theme_bw() + scale_y_log10()
```


```{r esrc_categoriesByPercYear, echo = FALSE}

# Look at the project categories
esrcdat %>% select(ProjectCategory, AwardPounds, StartDate)                %>% 
            mutate(Year = year(StartDate))                                 %>% 
            group_by(Year, ProjectCategory)                                %>% 
            summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                     %>% 
            filter(!is.na(TotalExpenditure))                               %>% 
            ggplot(aes(x = Year, y = TotalExpenditure, fill = ProjectCategory)) + 
            geom_col(colour="black", position = "fill") +
            xlab("Year") + labs(fill = "Project Category") +
            ylab("% Expenditure") +
            theme_bw() + scale_y_continuous(labels = scales::percent) 
```

### Active projects category awards only

This information corresponds to projects that are classified as *Active*.

```{r esrc_categories_active, echo = FALSE}

# Look at the project categories
esrcdat %>% filter(Status == "Active")                                         %>% 
            select(ProjectCategory, AwardPounds)                               %>% 
            group_by(ProjectCategory)                                          %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))             %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2)))  %>% 
            arrange(desc(AverageAward))                                        %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))     %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 

```

```{r esrc_categoriesByYearAct, echo = FALSE}

# Look at the project categories
esrcdat %>% filter(Status == "Active")                                     %>% 
            select(ProjectCategory, AwardPounds, StartDate)                %>% 
            mutate(Year = year(StartDate))                                 %>% 
            group_by(Year, ProjectCategory)                                %>% 
            summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                     %>% 
            filter(!is.na(TotalExpenditure) & TotalExpenditure > 0)        %>% 
            ggplot(aes(x = Year, y = TotalExpenditure, fill = ProjectCategory)) + 
            geom_col(colour="black") +
            xlab("Year") + labs(fill = "Project Category") + 
            scale_x_continuous(breaks= scales::pretty_breaks()) +
            ylab("Expenditure (million £s)") +
            theme_bw() + scale_y_log10()
```


```{r esrc_categoriesByPercYearAct, echo = FALSE}

# Look at the project categories
esrcdat %>% filter(Status == "Active")                                     %>% 
            select(ProjectCategory, AwardPounds, StartDate)                %>% 
            mutate(Year = year(StartDate))                                 %>% 
            group_by(Year, ProjectCategory)                                %>% 
            summarise(TotalExpenditure = round(sum(AwardPounds)/1e6), 
                     .groups = "keep")                                     %>% 
            filter(!is.na(TotalExpenditure))                               %>% 
            ggplot(aes(x = Year, y = TotalExpenditure, fill = ProjectCategory)) + 
            geom_col(colour="black", position = "fill") +
            xlab("Year") + labs(fill = "Project Category") +
            ylab("% Expenditure") + scale_x_continuous(breaks= scales::pretty_breaks()) +
            theme_bw() + scale_y_continuous(labels = scales::percent) 
```


## Award length distribution

### Award length distribution for all projects

The award length distribution of the award lengths binned into 28-day periods is shown below. 

```{r award_lengths, echo = FALSE, fig.alt = "Histogram of the length distribution for all projects."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "weeks")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (weeks)") +
            labs(fill = "Project Category") + theme_bw()
```

With a y log scale.

```{r award_lengths_log, echo = FALSE, fig.alt = "Histogram of the length distribution for all projects."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "weeks")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (weeks)") +
            labs(fill = "Project Category") + theme_bw() + 
            scale_y_continuous(trans = "pseudo_log")
```

Look at the award given by the length of project by project category for all projects.

```{r award_lengthsVsAwardSize, echo = FALSE, fig.alt = "Award length vs Award size projects."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% select(StartDate, EndDate, ProjectCategory, AwardPounds) %>% 
            filter(!is.na(StartDate) & !is.na(EndDate)) %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "weeks")) %>% 
            filter(AwardPounds > 0)                                            %>% 
            #mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            ggplot(aes(x = as.numeric(grant_length), y = AwardPounds, colour = ProjectCategory)) + 
            geom_point(alpha = 0.25) + 
            ylab("Awards (£)") + xlab("Award Length (weeks)") + scale_y_log10() +
            facet_wrap(vars(ProjectCategory)) +
            labs(fill = "Project Category") + theme_bw()
```

The top 15 active projects:

```{r top15_active_projects, echo = FALSE}

esrcdat %>% filter(Status == "Active" & AwardPounds > 10e6)                  %>% 
            arrange(desc(AwardPounds))                                       %>% 
            select(LeadROName, ProjectCategory, AwardPounds, Title)          %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))   %>% 
            slice_head(n = 15)                                               %>% 
            kbl(format="pipe", align = rep("r",4), 
                col.names = c("Lead Org", "Category", 
                                "Total awarded (£)","Project title")) 


```

### Award length distribution for active projects only

The same information as provided above but only for *Active* projects. The maximum funding period corresponds to `r as.numeric(max(difftime(esrcdat[["EndDate"]][esrcdat$Status == "Active"], esrcdat[["StartDate"]][esrcdat$Status == "Active"], units = "days")))` days.

```{r award_lengths_active, echo = FALSE, fig.alt = "Histogram of the length distribution for active projects only."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>% 
            select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (days)") +
            labs(fill = "Project Category") + theme_bw()
```

The top length of awards lie by project category in days is tabulated below.

```{r award_lengths_active_table, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                                      %>% 
            select(StartDate, EndDate, ProjectCategory)                                     %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                                     %>% 
            mutate(grant_length = as.numeric(difftime(EndDate, StartDate,units = "days")))  %>% 
            group_by(grant_length, ProjectCategory)                                         %>% 
            tally()                                                                         %>% 
            arrange(desc(n))                                                                %>% 
            head(15)                                                                        %>% 
            kbl(format="pipe", align = c("r","l","r"), 
                col.names = c("Number of days","Project Category","Number of projects"))
```

Percentage of award types by time length.

```{r award_lengths_active_fill, echo = FALSE, fig.alt = "Percentage distribution of project type by the length of awards."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>% 
            select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days"))  %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black", position="fill", na.rm = TRUE) + 
            ylab("Number of Awards") + xlab("Award Length (days)") +
            labs(fill = "Project Category") + theme_bw() + 
            scale_y_continuous(labels = scales::percent)
```

Look at the award given by the length of project by project category for active projects.

```{r award_lengthsVsAwardSizeForActiveProjects, echo = FALSE, fig.alt = "Award length vs Award size for active projects."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>%
             select(StartDate, EndDate, ProjectCategory, AwardPounds)           %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days"))  %>% 
            filter(AwardPounds > 0)                                             %>% 
            #mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            ggplot(aes(x = as.numeric(grant_length), y = AwardPounds, colour = ProjectCategory)) + 
            geom_point(alpha = 0.25) + 
            ylab("Awards (£)") + xlab("Award Length (days)") + scale_y_log10() +
            facet_wrap(vars(ProjectCategory)) +
            labs(fill = "Project Category") + theme_bw()
```

## Regional distribution of awards

### Region distributions of awards for all projects

The expenditure of the awards over the whole time period by region ordered by the total award given is shown in the table below.

```{r esrc_byRegions, echo = FALSE}

esrcdat %>% select(Region, AwardPounds)                                       %>% 
            group_by(Region)                                                  %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))            %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2))) %>% 
            arrange(desc(TotalAward))                                         %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))    %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Regional distributions of awards for active projects only

We can generate the table for projects that are currently active ordered by the total award given is shown in the table below.

```{r esrc_byRegions_active, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                        %>% 
            select(Region, AwardPounds)                                       %>% 
            group_by(Region)                                                  %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))            %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2))) %>% 
            arrange(desc(TotalAward))                                         %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))    %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```


## Funding by lead organisation

### Funding by lead organisation for all projects

This only shows the top 25 organisations by the average value of the award.
 
```{r AwardByOrg, echo = FALSE}

esrcdat %>% select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = sprintf("%.2f",round(TotalAward/Number,2)))       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Funding by lead organisation for active projects only

This only shows the top 25 organisations with active projects by the average value of the award.
 
```{r ActiveAwardByOrg, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                          %>% 
            select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = sprintf("%.2f",round(TotalAward/Number,2)))       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```
The same table ordered by the number of awards:

```{r ActiveAwardByOrgByNum, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                          %>% 
            select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = sprintf("%.2f",round(TotalAward/Number,2)))       %>% 
            arrange(desc(Number))                                               %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

## Department awards

```{r clean_Departments, echo = FALSE}

# Try and normalise some of the text and add the results into a new column.
esrcdat$CleanDep <- esrcdat$Department
esrcdat$CleanDep <- gsub("Cardiff School of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("School of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Schl of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sch of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sch for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Department of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Dept of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Institute of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Inst of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Inst for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Institute for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Birbeck ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("College of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Centre for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Ctr for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Fac of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Faculty of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Essex ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Cardiff ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Oxford ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Warwick ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sheffield ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sciences", "Science", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Alliance Manchester ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Management School", "Management", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Southampton ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Nottingham University ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("University of Sussex ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub(" - SoGE", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Law School", "Law", esrcdat$CleanDep)

# length(unique(esrcdat$CleanDep))
# unique(esrcdat$CleanDep)
```

### Department awards for all projects

There are `r length(unique(esrcdat[["Department"]]))` unique departments. The table below only shows departments that have 30 or more occurrences. The Departments below have been 'cleaned' to remove minor differences, e.g. Cardiff Business School to Business School and so on.

```{r departments, echo = FALSE}

# Total number of ESRC projects to calculate percentages.
N <- nrow(esrcdat)

esrcdat %>% select(CleanDep, AwardPounds)                             %>% 
            group_by(CleanDep)                                        %>% 
            mutate(n = n())                                           %>% 
            mutate(n, Percent=round(n/N*100,2), 
                      Total = format(sum(AwardPounds),big.mark =",")) %>% 
            distinct(CleanDep, n, Percent, Total)                     %>% 
            arrange(desc(n))                                          %>% 
            filter(n >= 30)                                           %>% 
            kbl(format="pipe", align = c("l","r","r","r"),
                col.names = c("Department", "Number", "Percent", "Total Awarded (£)")) 

```


### Department awards for active projects only

There are `r length(unique(esrcdat[["Department"]][esrcdat$Status == "Active"]))` unique departments for active projects (`r length(unique(esrcdat[["Department"]]))` for all projects). The table below only shows cases that have 30 or more occurrences in active projects.

```{r active_departments, echo = FALSE}

# Total number of active projects only to calculate percentages.
N <- nrow(esrcdat[esrcdat$Status =="Active",])

esrcdat %>% filter(Status == "Active")                                %>% 
            select(CleanDep, AwardPounds)                             %>% 
            group_by(CleanDep)                                        %>% 
            mutate(n = n())                                           %>% 
            mutate(n, Percent=round(n/N*100,2), 
                      Total = format(sum(AwardPounds),big.mark =",")) %>% 
            distinct(CleanDep, n, Percent, Total)                     %>% 
            arrange(desc(n))                                          %>% 
            filter(n >= 30)                                           %>% 
            kbl(format="pipe", align = c("l","r","r","r"),
                col.names = c("Department", "Number", "Percent", "Total Awarded (£)")) 
```

## Doctoral Training Partnerships

### Active Partnerships

Currently active doctoral partnerships ordered by the start date.

```{r active_DTPs, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                      %>%  
            filter(grepl("Doctoral Training",Title, ignore.case = TRUE))    %>% 
            select(LeadROName, Department, StartDate, EndDate, AwardPounds) %>%
            arrange(StartDate)                                              %>% 
            mutate(across(where(is.Date), ~ format(., "%d/%m/%y")))         %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>% 
            kable(format="pipe", align= c("l","l","l","l","r"), 
                  col.names = c("Lead Organisation", "Department","Start", "End","Award (£)")) 
```

## Award Titles

## Classification by category

Classify the department of the Principal Investigator (assuming that the 
department will be linked to the subject of the award) using the following base 
categories:

* Area Studies
* Demography
* Development studies
* Economics
* Education
* Environmental planning
* History
* Human Geography
* Law & legal studies
* Linguistics
* Management & business studies
* Political science. & international studies
* Psychology
* Science and Technology Studies
* Social anthropology
* Social policy
* Social work
* Sociology
* Tools, technologies & methods
* Other

The categories are derived from decomposition of previous ESRC expenditure reports at 
[ESRC application and success rate data and analysis](https://www.ukri.org/publications/esrc-application-and-success-rate-data-and-analysis/). The GtR subject classification for projects has been mapped to the above scheme
and where a project subject is not provided an "Unclassified" type is used.

```{r Read_subjects, echo = FALSE}

# Categories to use
categories <- c("Area Studies",
                "Demography",
                "Development studies",
                "Economics",
                "Education",
                "Environmental planning",
                "History",
                "Human Geography",
                "Law & legal studies",
                "Linguistics",
                "Management & business studies",
                "Political science. & international studies",
                "Psychology",
                "Science and Technology Studies",
                "Social anthropology",
                "Social policy",
                "Social work",
                "Sociology",
                "Tools, technologies & methods",
                "Other")

# Define subject column types  to read from file
columns <- cols(
  id = col_character(),
  text = col_character(),
  percentage = col_double(),
  encodedText = col_character(),
  status = col_character(),
  grantReference = col_character(),
  grantCategory = col_character()
)

# read in the subject data
subjects <- read_csv(file = "../Data/subjects.csv", col_types = columns)

# Add a number of subjects assigned and a fraction contribution column to the data
subjects <- subjects                                %>%
            group_by(grantReference)                %>%
            mutate(Nsub = n())                      %>%
            mutate(fracContrib = round(1/Nsub, 3))  %>% 
            rename(subject = text, encodedSubject = encodedText)

# Join with the esrc data
esrc_subjects <- esrcdat %>%
                 left_join(subjects, by = c("ProjectReference" = "grantReference")) %>%
                 select( -percentage, -status, -grantCategory)

# Provide values for Nsub (1) and the fracContrib (1) when there is no subject
esrc_subjects$Nsub[is.na(esrc_subjects$subject)] <- 1
esrc_subjects$fracContrib[is.na(esrc_subjects$subject)] <- 1

```

```{r Assign_categories, echo = FALSE}

# Create new column
esrc_subjects$category <- rep("-",nrow(esrc_subjects))

# Set an uncategorised label
esrc_subjects$category[is.na(esrc_subjects$subject)] <- "Uncategorised"

# Need to reduce the following 71 categories to the above 21 categories
# including "Other" and "Uncategorised:
#
# Management & Business Studies, Development studies, RCUK Programmes,
# Social Policy, Climate & Climate Change, Education, Human Geography, NA,
# Genetics & development, Psychology, Social Work, Environmental planning,
# Sociology, Media, Science and Technology Studies,
# "Tools, technologies & methods", Pol. sci. & internat. studies,
# Law & legal studies, "Ecol, biodivers. & systematics",
# Civil eng. & built environment, Social Anthropology, Economics,
# Info. & commun. Technol., Languages & Literature, Linguistics,
# Medical & health interface, History, Visual arts, Demography, Design,
# Demography & human geography, Complexity Science,
# "Pollution, waste & resources", Terrest. & freshwater environ.,
# Agri-environmental science, Food science & nutrition,
# Environmental Engineering, Manufacturing, Drama & theatre studies,
# Area Studies, Cultural & museum studies, Philosophy, Animal Science, Energy,
# Mathematical sciences, Archaeology, Music, "Theology, divinity & religion"
# Library & information studies, Astronomy - observation, Astronomy - theory,
# Particle Astrophysics, Bioengineering, Cell biology, Process engineering,
# Omic sciences & technologies, Systems engineering, Marine environments,
# Atmospheric phys. & chemistry, Plant & crop science, Electrical Engineering,
# Dance, Chemical measurement, Geosciences, Microbial sciences,
# Mechanical Engineering, Classics, Catalysis & surfaces, Materials sciences,
# Instrument. sensor & detectors, Materials Processing

# Mapping:
#
# Area Studies: Area Studies
# Demography: Demography, Demography & human geography
# Development studies: Development studies
# Economics: Economics
# Education: Education
# Environmental planning: Environmental planning
# History: History
# Human Geography: Human Geography
# Law & legal studies: Law & legal studies
# Linguistics: Linguistics, Languages & Literature
# Management & business studies: Management & Business Studies
# Political science. & international studies: Pol. sci. & internat. studies
# Psychology: Psychology
# Science and Technology Studies: Science and Technology Studies
# Social anthropology: Social Anthropology
# Social policy: Social Policy
# Social work: Social Work
# Sociology: Sociology
# Tools, technologies & methods: "Tools, technologies & methods"
# Other: RCUK Programmes, Genetics & development, Climate & Climate Change,
#        Media, "Ecol, biodivers. & systematics", Civil eng. & built environment,
#        Info. & commun. Technol., Medical & health interface,
#        Visual arts, Design, Complexity Science, "Pollution, waste & resources",
#        Terrest. & freshwater environ., Agri-environmental science,
#        Food science & nutrition, Environmental Engineering,
#        Manufacturing, Drama & theatre studies, Cultural & museum studies,
#        Philosophy, Animal Science, Energy, Mathematical sciences, Archaeology,
#        Music, "Theology, divinity & religion", Library & information studies,
#        Astronomy - observation, Astronomy - theory,
#        Particle Astrophysics, Bioengineering, Cell biology, Process engineering,
#        Omic sciences & technologies, Systems engineering, Marine environments,
#        Atmospheric phys. & chemistry, Plant & crop science, Electrical Engineering,
#        Dance, Chemical measurement, Geosciences, Microbial sciences,
#        Mechanical Engineering, Classics, Catalysis & surfaces, Materials sciences,
#        Instrument. sensor & detectors, Materials Processing
# Unclassified: NA

# Function to select the right entries and reduce typing
sel <- function(parseString){
  return(grepl(parseString, esrc_subjects$subject, ignore.case = TRUE))
}

# assign the categories based on the subjects
esrc_subjects$category[sel("area")] <- "Area Studies"
# This also takes Demography and human geography, the latter being another category
esrc_subjects$category[sel("^demography")] <- "Demography"
esrc_subjects$category[sel("^development")] <- "Development studies"
esrc_subjects$category[sel("economics")] <- "Economics"
esrc_subjects$category[sel("education")] <-  "Education"
esrc_subjects$category[sel("planning")] <- "Environmental planning"
esrc_subjects$category[sel("history")] <- "History"
esrc_subjects$category[sel("^human geography")] <- "Human Geography"
esrc_subjects$category[sel("law")] <- "Law & legal studies"
esrc_subjects$category[sel("languages|linguistics")] <- "Linguistics"
esrc_subjects$category[sel("management")] <- "Management & business studies"
esrc_subjects$category[sel("pol\\.")] <- "Political science. & international studies"
esrc_subjects$category[sel("psychology")] <- "Psychology"
esrc_subjects$category[sel("^science")] <- "Science and Technology Studies"
esrc_subjects$category[sel("anthropology")] <- "Social anthropology"
esrc_subjects$category[sel("policy")] <- "Social policy"
esrc_subjects$category[sel("work")] <- "Social work"
esrc_subjects$category[sel("sociology")] <- "Sociology"
esrc_subjects$category[sel("tools|instrument|measurement")] <- "Tools, technologies & methods"
# Things that do not seem to fit any of the above categories
esrc_subjects$category[sel(paste0("rcuk|astro|dance|music|gene|museum|",
                                  "theology|science(s)?$|engineering$|drama|",
                                  "philo|arch|^omic|bio|info|class|",
                                  "atmos|design|vis|med|^cat|mar|ener|",
                                  "manu|materi|clim|poll|terr|civ|food")
                           )] <- "Other"

# Check all have been assigned
if(any(esrc_subjects$category == "-")) {
  warning("There are some unassigned categories: ",
          unique(esrc_subjects$subject[is.na(esrc_subjects$category)]))
}

```

There are 73 subject types and 21 categories described above plus the `Uncategorised` type for the cases where this information has not been provided. The GtR subjects for ESRC projects have been mapped to categories according to:

* **Area Studies**: Area Studies
* **Demography**: Demography, Demography & human geography
* **Development studies**: Development studies
* **Economics**: Economics
* **Education**: Education
* **Environmental planning**: Environmental planning
* **History**: History
* **Human Geography**: Human Geography
* **Law & legal studies**: Law & legal studies
* **Linguistics**: Linguistics, Languages & Literature
* **Management & business studies**: Management & Business Studies
* **Political science. & international studies**: Pol. sci. & internat. studies
* **Psychology**: Psychology
* **Science and Technology Studies**: Science and Technology Studies
* **Social anthropology**: Social Anthropology
* **Social policy**: Social Policy
* **Social work**: Social Work
* **Sociology**: Sociology
* **Tools, technologies & methods**: "Tools, technologies & methods"
* **Other**: RCUK Programmes, Genetics & development, Climate & Climate Change,
       Media, "Ecol, biodivers. & systematics", Civil eng. & built environment,
       Info. & commun. Technol., Medical & health interface,
       Visual arts, Design, Complexity Science, "Pollution, waste & resources",
       Terrest. & freshwater environ., Agri-environmental science,
       Food science & nutrition, Environmental Engineering,
       Manufacturing, Drama & theatre studies, Cultural & museum studies,
       Philosophy, Animal Science, Energy, Mathematical sciences, Archaeology,
       Music, "Theology, divinity & religion", Library & information studies,
       Astronomy - observation, Astronomy - theory,
       Particle Astrophysics, Bioengineering, Cell biology, Process engineering,
       Omic sciences & technologies, Systems engineering, Marine environments,
       Atmospheric phys. & chemistry, Plant & crop science, Electrical Engineering,
       Dance, Chemical measurement, Geosciences, Microbial sciences,
       Mechanical Engineering, Classics, Catalysis & surfaces, Materials sciences,
       Instrument. sensor & detectors, Materials Processing
* **Uncategorised**: NA

A project might be assigned more than one subject, where this is the case if the
project has been assigned with n subjects then each will contribute 1/n to the 
classification count and wil be assigned a contribution of Award_amount/n to each
subject. Taking this into account for each project, this gives a breakdown of the 
number of awards and amount awarded as:

```{r categories1, echo = FALSE}

# Generate stats for the categories
esrc_subjects %>% select(category, AwardPounds, fracContrib)                      %>% 

                  group_by(category)                                              %>% 
                  summarise(Contribution = round(sum(fracContrib),1), 
                            Amount = sum(fracContrib*AwardPounds))                %>%
                  mutate(totContrib = sum(Contribution), totAmount = sum(Amount)) %>% 
                  mutate(percContrib = round(Contribution/totContrib,2)*100,
                         perAward = round(Amount/totAmount,2) * 100)              %>%
                    
                  select(-totContrib, -totAmount)                                 %>% 
                  relocate(percContrib, .after = Contribution)                    %>% 
                  relocate(perAward, .after = Amount)                             %>% 
                  mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>% 
                  arrange(desc(Amount))                                           %>% 
                  kable(format="pipe", align= rep("l",5), 
                  col.names = c("Category", "Number of awards","Number %", "Award (£)",
                                "Award %"))    
```

The `Other` category dominates by award amount though the `Uncategorised` dominate by numbers. Looking at the `Other` category in more detail:

```{r categories2, echo = FALSE}

esrc_subjects %>% filter(category == "Other")                                     %>% 
                  select(subject, AwardPounds, fracContrib)                       %>%
                  group_by(subject)                                               %>% 
                  summarise(Contribution= round(sum(fracContrib),1), 
                            Amount = sum(fracContrib * AwardPounds))              %>% 
                  mutate(totContrib = sum(Contribution), totAmount = sum(Amount)) %>% 
                  mutate(percContrib = round(Contribution/totContrib,2)*100,
                         perAward = round(Amount/totAmount,2) * 100)              %>%
                    
                  select(-totContrib, -totAmount)                                 %>% 
                  relocate(percContrib, .after = Contribution)                    %>% 
                  relocate(perAward, .after = Amount)                             %>% 
                  mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>% 
                  arrange(desc(Amount)) %>% 
                  kable(format="pipe", align= rep("l", 5), 
                  col.names = c("Subject", "Number of awards","Number %", 
                                "Award (£)", "Award %"))  
```

There are some large items near the top. Also, some of the items would not usually fall under the ESRC area.

If we only focus on currently active projects we get:

```{r categories3, echo = FALSE}

esrc_subjects %>% filter(Status == "Active")                                      %>% 
                  select(category, AwardPounds, fracContrib)                      %>% 
                  group_by(category)                                              %>% 
                  summarise(Contribution = round(sum(fracContrib),1), 
                            Amount = sum(fracContrib*AwardPounds))                %>%
                  mutate(totContrib = sum(Contribution), totAmount = sum(Amount)) %>% 
                  mutate(percContrib = round(Contribution/totContrib,2)*100,
                         perAward = round(Amount/totAmount,2) * 100)              %>%
                    
                  select(-totContrib, -totAmount)                                 %>% 
                  relocate(percContrib, .after = Contribution)                    %>% 
                  relocate(perAward, .after = Amount)                             %>% 
                  mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>% 
                  arrange(desc(Amount))                                           %>% 
                  kable(format="pipe", align= rep("l",5), 
                  col.names = c("Category", "Number of awards","Number %", "Award (£)",
                                "Award %"))   
```

and again looking to see how the `Other` category breakdown for active projects only:

```{r categories4, echo = FALSE}

esrc_subjects %>% filter(category == "Other" & Status == "Active")                %>% 
                   select(subject, AwardPounds, fracContrib)                       %>%
                  group_by(subject)                                               %>% 
                  summarise(Contribution= round(sum(fracContrib),1), 
                            Amount = sum(fracContrib * AwardPounds))              %>% 
                  mutate(totContrib = sum(Contribution), totAmount = sum(Amount)) %>% 
                  mutate(percContrib = round(Contribution/totContrib,2)*100,
                         perAward = round(Amount/totAmount,2) * 100)              %>%
                    
                  select(-totContrib, -totAmount)                                 %>% 
                  relocate(percContrib, .after = Contribution)                    %>% 
                  relocate(perAward, .after = Amount)                             %>% 
                  mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>% 
                  arrange(desc(Amount)) %>% 
                  kable(format="pipe", align= rep("l", 5), 
                  col.names = c("Subject", "Number of awards","Number %", 
                                "Award (£)", "Award %"))   

```

Ignoring the `Other` and `Uncategorised` categories and considering only active
projects:

```{r categories5, echo = FALSE}

esrc_subjects %>% filter(category != "Other" & category != "Uncategorised" & 
                         Status == "Active")                                      %>% 
                  select(category, AwardPounds, fracContrib)                      %>%
                  group_by(category)                                              %>% 
                  summarise(Contribution= round(sum(fracContrib),1), 
                            Amount = sum(fracContrib * AwardPounds))              %>% 
                  mutate(totContrib = sum(Contribution), totAmount = sum(Amount)) %>% 
                  mutate(percContrib = round(Contribution/totContrib,2)*100,
                         perAward = round(Amount/totAmount,2) * 100)              %>%
                    
                  select(-totContrib, -totAmount)                                 %>% 
                  relocate(percContrib, .after = Contribution)                    %>% 
                  relocate(perAward, .after = Amount)                             %>% 
                  mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>% 
                  arrange(desc(Amount)) %>% 
                  kable(format="pipe", align= rep("l", 5), 
                  col.names = c("Category", "Number of awards","Number %", 
                                "Award (£)", "Award %"))  
```
```{r AwardPiePlot, echo = FALSE}


esrc_subjects %>% filter(category != "Other" & category != "Uncategorised" & 
                         Status == "Active")                                       %>% 
                  select(category, AwardPounds, fracContrib)                       %>%
                  group_by(category)                                               %>% 
                  summarise(Contribution= sum(fracContrib), 
                            Amount = sum(fracContrib * AwardPounds))               %>%
                  mutate(totContrib = sum(Contribution), totAmount = sum(Amount))  %>%
                  mutate(perContrib = Contribution/totContrib, 
                         perAmount = Amount/totAmount)                             %>% 
                  ggplot(aes(x = "", y = perAmount, fill = category )) + 
                  geom_bar(width = 1, stat = "identity", colour = "black") + 
                  coord_polar("y", start = 0) + 
                  scale_y_continuous(labels = scales::percent) +
                  #geom_text(aes(y = perAmount/3 + c(0, cumsum(perAmount)[-length(perAmount)]), label = paste(round(perAmount*100),"%")), size = 3) +
                  theme_bw() + labs(x = "", y = "By % of awards in £s")
```

```{r NumberOfAwardsPiePlot, echo = FALSE}


esrc_subjects %>% filter(category != "Other" & category != "Uncategorised" & 
                         Status == "Active")                                       %>% 
                  select(category, AwardPounds, fracContrib)                       %>%
                  group_by(category)                                               %>% 
                  summarise(Contribution= sum(fracContrib), 
                            Amount = sum(fracContrib * AwardPounds))               %>%
                  mutate(totContrib = sum(Contribution), totAmount = sum(Amount))  %>%
                  mutate(perContrib = Contribution/totContrib, 
                         perAmount = Amount/totAmount)                             %>% 
                  ggplot(aes(x = "", y = perContrib, fill = category )) + 
                  geom_bar(width = 1, stat = "identity", colour = "black") + 
                  coord_polar("y", start = 0) + 
                  scale_y_continuous(labels = scales::percent) +
                  theme_bw() + labs(x = "", y = "By % of the number of awards")
```
# ToDo Items


- [ ] Reconcile DTPs from what was scraped from the [ESRC DTP](https://esrc.ukri.org/skills-and-careers/doctoral-training/doctoral-training-partnerships/doctoral-training-partnership-dtp-contacts/) web page and what is in the GtR data file (there are more).
- [ ] Research title looks interesting for further examination but will require processing to be comprehensible.
