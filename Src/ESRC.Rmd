---
title: "Economic and Social Research Council (ESRC) Data"
author: "**Author**: Mario Antonioletti.<br/>"
date: "**Last updated**: `r format(Sys.Date(), '%d/%m/%y')`"
output: 
  github_document:
      toc: true
      number_sections: true
      toc_depth: 4
---

```{r setup, include=FALSE}

# Global knitr options
knitr::opts_chunk$set(echo = TRUE)

# Load packages to be used
library(readr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(stringr)
library(knitr)
library(kableExtra)

# Do not use scientific notation
options(scipen=999)

# Columns to read
input_cols <- cols(
                    FundingOrgName = col_character(),
                    ProjectReference = col_character(),
                    LeadROName = col_character(),
                    Department = col_character(),
                    ProjectCategory = col_character(),
                    PISurname = col_character(),
                    PIFirstName = col_character(),
                    PIOtherNames = col_character(),
                    `PI ORCID iD` = col_character(),
                    StudentSurname = col_character(),
                    StudentFirstName = col_character(),
                    StudentOtherNames = col_character(),
                    `Student ORCID iD` = col_character(),
                    Title = col_character(),
                    StartDate = col_date(format="%d/%m/%Y"),
                    EndDate = col_date(format="%d/%m/%Y"),
                    AwardPounds = col_double(),
                    ExpenditurePounds = col_double(),
                    Region = col_character(),
                    Status = col_character(),
                    GTRProjectUrl = col_character(),
                    ProjectId = col_character(),
                    FundingOrgId = col_character(),
                    LeadROId = col_character(),
                    PIId = col_character()
)

# Read the Gateway to Research data
gtrdat <- read_csv("../Data/projectsearch-1633957153275.csv.gz", col_types = input_cols)

# Remove EndDate >= 2050 or is an NAs - removes 25 values
gtrdat <- gtrdat[!is.na(gtrdat$EndDate) & year(gtrdat$EndDate) < 2050,]

# Filter ESRC data - 10834 rows (about 8.9% of the data)
esrcdat <- gtrdat %>% filter(FundingOrgName == "ESRC")


```

# Introduction

The aim of this document is to give an overview of expenditure done by the UKRI ESRC as determined from a [Gateway to Research](https://gtr.ukri.org/) (GtR) data set, made available under an [Open Government Licence](https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/), which covers the period `r format(min(gtrdat$StartDate),"%d/%m/%y")` to `r format(max(gtrdat$EndDate, na.rm = TRUE),"%d/%m/%y")`. The GtR data snapshot was downloaded from the GtR website on the 11/10/21 and was last updated by UKRI on the 30th of September 2021. The R markdown should also work on any future updates.

The data set contains `r format(nrow(gtrdat), big.mark = ",")` rows (after some data cleaning), where a row can be interpreted as the record of an award. In this data set `r format(nrow(gtrdat[gtrdat$FundingOrgName == "ESRC",]), big.mark = ",")` correspond to ESRC awards.

# Overall expenditure

## All projects

Expenditure for the whole period under consideration is shown in the graph below. Awards that do not have a value defined have been removed.

```{r funding_ByOrg, echo = FALSE}

gtrdat %>% filter(!is.na(AwardPounds))                                   %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1000000)) %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding Organisation") + 
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

## Active projects only 

The graph below only contains values for currently active projects:

```{r funding_ByOrg_active, echo = FALSE}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))              %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1000000)) %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding Organisation") + 
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

# ESRC data

## Project category awards

### All projects

The project categories for the ESRC awards covering the period `r format(min(esrcdat$StartDate),"%d/%m/%y")` to `r format(max(esrcdat$EndDate, na.rm = TRUE),"%d/%m/%y")`. No explicit data seems to be provided for *Studentships*.

```{r esrc_categories, echo = FALSE}

# Look at the project categories
esrcdat %>% select(ProjectCategory, AwardPounds)                           %>% 
            group_by(ProjectCategory)                                      %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(AverageAward))                                    %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 
```

### Active projects

This information corresponds to projects that are classified as *Active*.

```{r esrc_categories_active, echo = FALSE}

# Look at the project categories
esrcdat %>% filter(Status == "Active")                                     %>% 
            select(ProjectCategory, AwardPounds)                           %>% 
            group_by(ProjectCategory)                                      %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(AverageAward))                                    %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 

```

## Award length distribution

### All projects
The award length distribution of the award lengths binned into 28-day periods is shown below. 
```{r award_lengths, echo = FALSE}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% select(StartDate, EndDate, ProjectCategory) %>% 
            filter(!is.na(StartDate) & !is.na(EndDate)) %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (days)") +
            labs(fill = "Project Category") + theme_bw()
```

### Active projects only
The same information as provided above but only for *Active* projects. The maximum funding period corresponds to `r as.numeric(max(difftime(esrcdat[["EndDate"]][esrcdat$Status == "Active"], esrcdat[["StartDate"]][esrcdat$Status == "Active"], units = "days")))` days.

```{r award_lengths_active, echo = FALSE}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>% 
            select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (days)") +
            labs(fill = "Project Category") + theme_bw()
```

The top length of awards lie by project category in days is tabulated below.

```{r award_lengths_active_table, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                                      %>% 
            select(StartDate, EndDate, ProjectCategory)                                     %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                                     %>% 
            mutate(grant_length = as.numeric(difftime(EndDate, StartDate,units = "days")))  %>% 
            group_by(grant_length, ProjectCategory)                                         %>% 
            tally()                                                                         %>% 
            arrange(desc(n))                                                                %>% 
            head(15)                                                                        %>% 
            kbl(format="pipe", align = c("r","l","r"), 
                col.names = c("Number of days","Project Category","Number of projects"))
```

Percentage of award types by time length.

```{r award_lengths_active_fill, echo = FALSE}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>% 
            select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black", position="fill", na.rm = TRUE) + 
            ylab("Number of Awards") + xlab("Award Length (days)") +
            labs(fill = "Project Category") + theme_bw() + scale_y_continuous(labels = scales::percent)
```
## Geographical distribution of awards

### All projects

The expenditure of the awards over the whole time period by region ordered by the total award given is shown in the table below.

```{r esrc_byRegions, echo = FALSE}

esrcdat %>% select(Region, AwardPounds)                                    %>% 
            group_by(Region)                                               %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(TotalAward))                                      %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Active projects

We can generate the table for projects that are currently active ordered by the total award given is shown in the table below.

```{r esrc_byRegions_active, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                     %>% 
            select(Region, AwardPounds)                                    %>% 
            group_by(Region)                                               %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(TotalAward))                                      %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```


## Funding by lead organisation

### All projects

This only shows the top 25 organisations by the average value of the award.
 
```{r AwardByOrg, echo = FALSE}

esrcdat %>% select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = round(TotalAward/Number,2))                       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Active projects
This only shows the top 25 organisations with active projects by the average value of the award.
 
```{r ActiveAwardByOrg, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                          %>% 
            select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = round(TotalAward/Number,2))                       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```
The same table ordered by the number of awards:

```{r ActiveAwardByOrgByNum, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                          %>% 
            select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = round(TotalAward/Number,2))                       %>% 
            arrange(desc(Number))                                               %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```
## Department awards

```{r clean_Dep, echo = FALSE}
esrcdat$CleanDep <- esrcdat$Department
esrcdat$CleanDep <- gsub("Cardiff School of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("School of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Schl of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sch of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sch for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Department of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Dept of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Institute of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Inst of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Inst for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Institute for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Birbeck ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("College of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Centre for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Ctr for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Fac of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Faculty of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Essex ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Cardiff ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Oxford ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Warwick ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sheffield ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sciences", "Science", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Alliance Manchester ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Management School", "Management", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Southampton ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Nottingham University ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("University of Sussex ", "", esrcdat$CleanDep)

# length(unique(esrcdat$CleanDep))
# unique(esrcdat$CleanDep)
```

### All projects

There are `r length(unique(esrcdat[["Department"]]))` unique departments. The table below only shows departments that have 30 or more occurrences. The Departments below have been 'cleaned' to remove minor differences, e.g. Cardiff Business School to Business School and so on.

```{r departments, echo = FALSE}

N <- nrow(esrcdat)

esrcdat %>% select(CleanDep)                 %>% 
            group_by(CleanDep)               %>% 
            tally()                          %>%
            mutate(Percent=round(n/N*100,2)) %>% 
            arrange(desc(n))                 %>% 
            filter(n >= 30)                  %>% 
            kbl(format="pipe", align = c("l","r","r"),
                col.names = c("Department", "Number", "Percent")) 

```


### Active projects 

There are `r length(unique(esrcdat[["Department"]][esrcdat$Status == "Active"]))` unique departments for active projects (`r length(unique(esrcdat[["Department"]]))` for all projects). The table below only shows cases that have 30 or more occurrences in active projects.

```{r active_departments, echo = FALSE}

N <- nrow(esrcdat[esrcdat$Status =="Active",])

esrcdat %>% filter(Status == "Active")       %>% 
            select(CleanDep)                 %>% 
            group_by(CleanDep)               %>% 
            tally()                          %>%
            mutate(Percent=round(n/N*100,2)) %>% 
            arrange(desc(n))                 %>% 
            filter(n >= 30)                  %>% 
            kbl(format="pipe", align = c("l","r","r"),
                col.names = c("Department", "Number", "Percent")) 
```

# ToDo Items

- [ ] Department text needs some cleaning.
- [ ] Research title looks interesting for further examination but will require processing to be comprehensible.
