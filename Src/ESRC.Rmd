---
title: "Economic and Social Research Council (ESRC) Data"
author: "**Author**: Mario Antonioletti.<br/>"
date: "**Last updated**: `r format(Sys.Date(), '%d/%m/%y')`."
output: 
  github_document:
      toc: true
      number_sections: false
      toc_depth: 4
---

```{r setup, include=FALSE}

# Global knitr options
knitr::opts_chunk$set(echo = TRUE)

# Load packages to be used
library(readr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(stringr)
library(knitr)
library(kableExtra)
library(tidytext)
library(RColorBrewer)
library(wordcloud)
library(leaflet)

# Do not use scientific notation
options(scipen=999)

# Columns to read
input_cols <- cols(
                    FundingOrgName = col_character(),
                    ProjectReference = col_character(),
                    LeadROName = col_character(),
                    Department = col_character(),
                    ProjectCategory = col_character(),
                    PISurname = col_character(),
                    PIFirstName = col_character(),
                    PIOtherNames = col_character(),
                    `PI ORCID iD` = col_character(),
                    StudentSurname = col_character(),
                    StudentFirstName = col_character(),
                    StudentOtherNames = col_character(),
                    `Student ORCID iD` = col_character(),
                    Title = col_character(),
                    StartDate = col_date(format="%d/%m/%Y"),
                    EndDate = col_date(format="%d/%m/%Y"),
                    AwardPounds = col_double(),
                    ExpenditurePounds = col_double(),
                    Region = col_character(),
                    Status = col_character(),
                    GTRProjectUrl = col_character(),
                    ProjectId = col_character(),
                    FundingOrgId = col_character(),
                    LeadROId = col_character(),
                    PIId = col_character()
)

# Read the Gateway to Research data
# Data snapshot from 30th of September 2021.
# gtrdat <- read_csv("../Data/projectsearch-1636377694679.csv.gz", col_types = input_cols)
# Data snapshot from 28th October 2021.
gtrdat <- read_csv("../Data/projectsearch-1633957153275.csv.gz", col_types = input_cols)

# Remove EndDate >= 2050 or is an NAs - removes 25 values
gtrdat <- gtrdat[!is.na(gtrdat$EndDate) & year(gtrdat$EndDate) < 2050,]

# Filter ESRC data - 10834 rows (about 8.9% of the data)
esrcdat <- gtrdat %>% filter(FundingOrgName == "ESRC")


```

# Introduction

The aim of this document is to provide an overview of expenditure done of the [United Kingdom Research and Innovation](https://www.ukri.org/) (UKRI) ESRC as determined from a [Gateway to Research](https://gtr.ukri.org/) (GtR) data snapshot. The data is made available under an [Open Government Licence](https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/), and covers the period `r format(min(gtrdat$StartDate),"%d/%m/%y")` to `r format(max(gtrdat$EndDate, na.rm = TRUE),"%d/%m/%y")`. The GtR data snapshot was
downloaded from the GtR website on the 08/11/21 and corresponded to data last updated by UKRI on the 28th October 2021.<!-- 11/10/21 and corresponded to data last updated by UKRI on the 30th of September 2021. --> 

The data set contains `r format(nrow(gtrdat), big.mark = ",")` rows (after some data cleaning), where a row corresponds to the record of an award. In this data set `r format(nrow(gtrdat[gtrdat$FundingOrgName == "ESRC",]), big.mark = ",")` correspond to ESRC awards.

# Overall expenditure

We start by doing a brief overview of all the data before we focus on the ESRC data.

## Expenditure for all UKRI projects

Expenditure for the whole period under consideration is shown in the graph below. Awards that do not have a value defined have been removed.

```{r funding_ByOrg, echo = FALSE, fig.alt = "Expenditure across each UKRI council from the available data."}

gtrdat %>% filter(!is.na(AwardPounds))                                   %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1000000)) %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding organisation") + 
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

The number of awards given by each council:

```{r NumberOfAwards_ByOrg, echo = FALSE, fig.alt = "Number of awards across each UKRI councils from the available data."}

gtrdat %>% filter(!is.na(AwardPounds))                                   %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           mutate(N = n())                                               %>% 
           ggplot(aes(x = FundingOrgName, y = N/1e6)) + 
           geom_col(colour="red") +
           xlab("Funding organisation") + 
           ylab("Number of awards (millions)") +
           theme_bw() 
          
```

Average award per founding councilordered by the average award:

```{r AvgAwardPerFundCouncil, echo = FALSE, fig.alt = "Average award size per organisation."}

gtrdat %>% filter(!is.na(AwardPounds))                                              %>% 
           select(FundingOrgName, AwardPounds)                                      %>% 
           group_by(FundingOrgName)                                                 %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)),
                  TotalAwards = n())                                                %>%
           mutate(AvgAward = 
                    as.numeric(round(TotalExpenditure/TotalAwards)))         %>% 
           select(FundingOrgName, TotalAwards, TotalExpenditure, AvgAward)          %>% 
           arrange(desc(as.numeric(AvgAward)))                                      %>% 
           mutate(across(where(is.numeric), ~ format(., big.mark = ",")))           %>%
           kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Funding org", "Number of awards",
                                "Total awarded (£)","Average award (£)"))
```

## Expenditure for active UKRI projects only 

The graph below only contains values for currently active projects:

```{r Activefunding_ByOrg_active, echo = FALSE, fig.alt = "Expenditure across all UKRI councils for active projects from the available data."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))              %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1000000)) %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding Organisation") + 
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

The number of awards given by each council for active projects:

```{r ActiveNumberOfAwards_ByOrg, echo = FALSE, fig.alt = "Number of awards across each UKRI councils for active projects from the available data."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))              %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           mutate(N = n())                                               %>% 
           ggplot(aes(x = FundingOrgName, y = N/1e6)) + 
           geom_col(colour="red") +
           xlab("Funding organisation") + 
           ylab("Number of awards (millions)") +
           theme_bw() 
          
```

Average award per founding council for active projects ordered by the average award:

```{r ActiveAvgAwardPerFundCouncil, echo = FALSE, fig.alt = "Average award size per organisation for active projects."}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))                        %>% 
           select(FundingOrgName, AwardPounds)                                      %>% 
           group_by(FundingOrgName)                                                 %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)),
                  TotalAwards = n())                                                %>%
           mutate(AvgAward = 
                    as.numeric(round(TotalExpenditure/TotalAwards)))                %>% 
           select(FundingOrgName, TotalAwards, TotalExpenditure, AvgAward)          %>% 
           arrange(desc(as.numeric(AvgAward)))                                      %>% 
           mutate(across(where(is.numeric), ~ format(., big.mark = ",")))           %>%
           kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Funding org", "Number of awards",
                                "Total awarded (£)","Average award (£)"))
```
# ESRC data

## Project category awards

### All projects category awards

The project categories for the ESRC awards covering the period `r format(min(esrcdat$StartDate),"%d/%m/%y")` to `r format(max(esrcdat$EndDate, na.rm = TRUE),"%d/%m/%y")`. No explicit data seems to be provided for *Studentships*. Data is sorted by the average award.

```{r esrc_categories, echo = FALSE}

# Look at the project categories
esrcdat %>% select(ProjectCategory, AwardPounds)                              %>% 
            group_by(ProjectCategory)                                         %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))            %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2))) %>% 
            arrange(desc(AverageAward))                                       %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))    %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 
```

### Active projects categry awards only

This information corresponds to projects that are classified as *Active*.

```{r esrc_categories_active, echo = FALSE}

# Look at the project categories
esrcdat %>% filter(Status == "Active")                                         %>% 
            select(ProjectCategory, AwardPounds)                               %>% 
            group_by(ProjectCategory)                                          %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))             %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2)))  %>% 
            arrange(desc(AverageAward))                                        %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))     %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 

```

## Award length distribution

### Award length distribution for all projects

The award length distribution of the award lengths binned into 28-day periods is shown below. 

```{r award_lengths, echo = FALSE, fig.alt = "Histogram of the length distribution for all projects."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% select(StartDate, EndDate, ProjectCategory) %>% 
            filter(!is.na(StartDate) & !is.na(EndDate)) %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "weeks")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (weeks)") +
            labs(fill = "Project Category") + theme_bw()
```

Look at the award given by the length of project by project category for all projects.

```{r award_lengthsVsAwardSize, echo = FALSE, fig.alt = "Award length vs Award size projects."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% select(StartDate, EndDate, ProjectCategory, AwardPounds) %>% 
            filter(!is.na(StartDate) & !is.na(EndDate)) %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "weeks")) %>% 
            filter(AwardPounds > 0)                                            %>% 
            #mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            ggplot(aes(x = as.numeric(grant_length), y = AwardPounds, colour = ProjectCategory)) + 
            geom_point(alpha = 0.25) + 
            ylab("Awards (£)") + xlab("Award Length (weeks)") + scale_y_log10() +
            facet_wrap(vars(ProjectCategory)) +
            labs(fill = "Project Category") + theme_bw()
```

The top 15 active projects:

```{r top15_active_projects, echo = FALSE}

esrcdat %>% filter(Status == "Active" & AwardPounds > 10e6)                  %>% 
            arrange(desc(AwardPounds))                                       %>% 
            select(LeadROName, ProjectCategory, AwardPounds, Title)          %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))   %>% 
            slice_head(n = 15)                                               %>% 
            kbl(format="pipe", align = rep("r",4), 
                col.names = c("Lead Org", "Category", 
                                "Total awarded (£)","Project title")) 


```

### Award length distribution for active projects only

The same information as provided above but only for *Active* projects. The maximum funding period corresponds to `r as.numeric(max(difftime(esrcdat[["EndDate"]][esrcdat$Status == "Active"], esrcdat[["StartDate"]][esrcdat$Status == "Active"], units = "days")))` days.

```{r award_lengths_active, echo = FALSE, fig.alt = "Histogram of the length distribution for active projects only."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>% 
            select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (days)") +
            labs(fill = "Project Category") + theme_bw()
```

The top length of awards lie by project category in days is tabulated below.

```{r award_lengths_active_table, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                                      %>% 
            select(StartDate, EndDate, ProjectCategory)                                     %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                                     %>% 
            mutate(grant_length = as.numeric(difftime(EndDate, StartDate,units = "days")))  %>% 
            group_by(grant_length, ProjectCategory)                                         %>% 
            tally()                                                                         %>% 
            arrange(desc(n))                                                                %>% 
            head(15)                                                                        %>% 
            kbl(format="pipe", align = c("r","l","r"), 
                col.names = c("Number of days","Project Category","Number of projects"))
```

Percentage of award types by time length.

```{r award_lengths_active_fill, echo = FALSE, fig.alt = "Percentage distribution of project type by the length of awards."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>% 
            select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days"))  %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 28, colour="black", position="fill", na.rm = TRUE) + 
            ylab("Number of Awards") + xlab("Award Length (days)") +
            labs(fill = "Project Category") + theme_bw() + scale_y_continuous(labels = scales::percent)
```

Look at the award given by the length of project by project category for active projects.

```{r award_lengthsVsAwardSizeForActiveProjects, echo = FALSE, fig.alt = "Award length vs Award size for active projects."}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>%
             select(StartDate, EndDate, ProjectCategory, AwardPounds)           %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "days"))  %>% 
            filter(AwardPounds > 0)                                             %>% 
            #mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            ggplot(aes(x = as.numeric(grant_length), y = AwardPounds, colour = ProjectCategory)) + 
            geom_point(alpha = 0.25) + 
            ylab("Awards (£)") + xlab("Award Length (days)") + scale_y_log10() +
            facet_wrap(vars(ProjectCategory)) +
            labs(fill = "Project Category") + theme_bw()
```

## Regional distribution of awards

### Region distributions of awards for all projects

The expenditure of the awards over the whole time period by region ordered by the total award given is shown in the table below.

```{r esrc_byRegions, echo = FALSE}

esrcdat %>% select(Region, AwardPounds)                                       %>% 
            group_by(Region)                                                  %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))            %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2))) %>% 
            arrange(desc(TotalAward))                                         %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))    %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Regional distributions of awards for active projects only

We can generate the table for projects that are currently active ordered by the total award given is shown in the table below.

```{r esrc_byRegions_active, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                        %>% 
            select(Region, AwardPounds)                                       %>% 
            group_by(Region)                                                  %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))            %>% 
            mutate(AverageAward = sprintf("%.2f",round(TotalAward/Number,2))) %>% 
            arrange(desc(TotalAward))                                         %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))    %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```


## Funding by lead organisation

### Funding by lead organisation for all projects

This only shows the top 25 organisations by the average value of the award.
 
```{r AwardByOrg, echo = FALSE}

esrcdat %>% select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = sprintf("%.2f",round(TotalAward/Number,2)))       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Funding by lead organisation for active projects only

This only shows the top 25 organisations with active projects by the average value of the award.
 
```{r ActiveAwardByOrg, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                          %>% 
            select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = sprintf("%.2f",round(TotalAward/Number,2)))       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```
The same table ordered by the number of awards:

```{r ActiveAwardByOrgByNum, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                          %>% 
            select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = sprintf("%.2f",round(TotalAward/Number,2)))       %>% 
            arrange(desc(Number))                                               %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

## Department awards

```{r clean_Departments, echo = FALSE}

# Try and normalise some of the text and add the results into a new column.
esrcdat$CleanDep <- esrcdat$Department
esrcdat$CleanDep <- gsub("Cardiff School of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("School of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Schl of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sch of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sch for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Department of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Dept of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Institute of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Inst of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Inst for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Institute for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Birbeck ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("College of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Centre for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Ctr for ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Fac of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Faculty of ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Essex ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Cardiff ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Oxford ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Warwick ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sheffield ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Sciences", "Science", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Alliance Manchester ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Management School", "Management", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Southampton ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Nottingham University ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("University of Sussex ", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub(" - SoGE", "", esrcdat$CleanDep)
esrcdat$CleanDep <- gsub("Law School", "Law", esrcdat$CleanDep)

# length(unique(esrcdat$CleanDep))
# unique(esrcdat$CleanDep)
```

### Department awards for all projects

There are `r length(unique(esrcdat[["Department"]]))` unique departments. The table below only shows departments that have 30 or more occurrences. The Departments below have been 'cleaned' to remove minor differences, e.g. Cardiff Business School to Business School and so on.

```{r departments, echo = FALSE}

# Total number of ESRC projects to calculate percentages.
N <- nrow(esrcdat)

esrcdat %>% select(CleanDep, AwardPounds)                             %>% 
            group_by(CleanDep)                                        %>% 
            mutate(n = n())                                           %>% 
            mutate(n, Percent=round(n/N*100,2), 
                      Total = format(sum(AwardPounds),big.mark =",")) %>% 
            distinct(CleanDep, n, Percent, Total)                     %>% 
            arrange(desc(n))                                          %>% 
            filter(n >= 30)                                           %>% 
            kbl(format="pipe", align = c("l","r","r","r"),
                col.names = c("Department", "Number", "Percent", "Total Awarded (£)")) 

```


### Department awards for active projects only

There are `r length(unique(esrcdat[["Department"]][esrcdat$Status == "Active"]))` unique departments for active projects (`r length(unique(esrcdat[["Department"]]))` for all projects). The table below only shows cases that have 30 or more occurrences in active projects.

```{r active_departments, echo = FALSE}

# Total number of active projects only to calculate percentages.
N <- nrow(esrcdat[esrcdat$Status =="Active",])

esrcdat %>% filter(Status == "Active")                                %>% 
            select(CleanDep, AwardPounds)                             %>% 
            group_by(CleanDep)                                        %>% 
            mutate(n = n())                                           %>% 
            mutate(n, Percent=round(n/N*100,2), 
                      Total = format(sum(AwardPounds),big.mark =",")) %>% 
            distinct(CleanDep, n, Percent, Total)                     %>% 
            arrange(desc(n))                                          %>% 
            filter(n >= 30)                                           %>% 
            kbl(format="pipe", align = c("l","r","r","r"),
                col.names = c("Department", "Number", "Percent", "Total Awarded (£)")) 
```

## Doctoral Training Partnerships

### Active Partnerships

Currently active doctoral partnerships ordered by the start date.

```{r active_DTPs, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                      %>%  
            filter(grepl("Doctoral Training",Title, ignore.case = TRUE))    %>% 
            select(LeadROName, Department, StartDate, EndDate, AwardPounds) %>%
            arrange(StartDate)                                              %>% 
            mutate(across(where(is.Date), ~ format(., "%d/%m/%y")))         %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))  %>% 
            kable(format="pipe", align= c("l","l","l","l","r"), 
                  col.names = c("Lead Organisation", "Department","Start", "End","Award (£)")) 
```

## Award Titles

### Active award titles

A word cloud made from the award titles using the top 250 words thogh some of the longer words have been excluded.

```{r ActiveWordCloud, echo = FALSE}
pal <- brewer.pal(9,"BuGn")

esrcdat %>% filter(Status == "Active")                            %>%
            select(Title)                                         %>% 
            unnest_tokens(word, Title)                            %>% 
            anti_join(stop_words, by="word")                      %>% 
            suppressWarnings(filter(!str_detect(word, "^[0-9]"))) %>% 
            count(word, sort = TRUE)                              %>%
            with(suppressWarnings(wordcloud(word, n, colours = pal, ordered.colors = TRUE, max.words = 250))) 
```

# ToDo Items

- [X] Department text needs some cleaning.<br/>
      Have done some data cleaning.
- [X] Fix ToC, links do not work.<br/>
      Auto-numbering the sections was breaking the ToC links.
- [X] Add ALT tags to images.<br/>
      Have added ALT tags to the distributions. 
- [ ] Reconcile DTPs from what was scraped from the [ESRC DTP](https://esrc.ukri.org/skills-and-careers/doctoral-training/doctoral-training-partnerships/doctoral-training-partnership-dtp-contacts/) web page and what is in the GtR data file (there are more).
- [ ] Research title looks interesting for further examination but will require processing to be comprehensible.
