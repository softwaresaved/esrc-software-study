---
title: "ESRC Data"
author: "Mario Antonioletti,"
date: "`r format(Sys.Date(), '%d/%m/%y')`"
output: 
  github_document:
      toc: true
      toc_depth: 4
---

```{r setup, include=FALSE}

# Global knitr options
knitr::opts_chunk$set(echo = TRUE)

# Load packages to be used
library(readr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(knitr)
library(kableExtra)

# Do not use scientific notation
options(scipen=999)

# Columns to read
input_cols <- cols(
                    FundingOrgName = col_character(),
                    ProjectReference = col_character(),
                    LeadROName = col_character(),
                    Department = col_character(),
                    ProjectCategory = col_character(),
                    PISurname = col_character(),
                    PIFirstName = col_character(),
                    PIOtherNames = col_character(),
                    `PI ORCID iD` = col_character(),
                    StudentSurname = col_character(),
                    StudentFirstName = col_character(),
                    StudentOtherNames = col_character(),
                    `Student ORCID iD` = col_character(),
                    Title = col_character(),
                    StartDate = col_date(format="%d/%m/%Y"),
                    EndDate = col_date(format="%d/%m/%Y"),
                    AwardPounds = col_double(),
                    ExpenditurePounds = col_double(),
                    Region = col_character(),
                    Status = col_character(),
                    GTRProjectUrl = col_character(),
                    ProjectId = col_character(),
                    FundingOrgId = col_character(),
                    LeadROId = col_character(),
                    PIId = col_character()
)

# Read the Gateway to Research data
gtrdat <- read_csv("../Data/projectsearch-1633957153275.csv.gz", col_types = input_cols)

# Remove EndDate >= 2050 or is an NAs - removes 25 values
gtrdat <- gtrdat[!is.na(gtrdat$EndDate) & year(gtrdat$EndDate) < 2050,]

# Filter ESRC data - 10834 rows (about 8.9% of the data)
esrcdat <- gtrdat %>% filter(FundingOrgName == "ESRC")


```

# Overall expenditure

## All projects

The [Gateway to Research](https://gtr.ukri.org/) data set, made available under an [Open Government Licence](https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/), covers the period `r format(min(gtrdat$StartDate),"%d/%m/%y")` to `r format(max(gtrdat$EndDate, na.rm = TRUE),"%d/%m/%y")` (for data downloaded from the Gateway to Research website on 11/10/21). 

Expenditure for the whole period under consideration is shown in the graph below. Awards that do not have a value defined have been removed.

```{r funding_ByOrg, echo = FALSE}

gtrdat %>% filter(!is.na(AwardPounds))                                   %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1000000)) %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding Organisation") + 
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

## Active projects only 

The graph below only contains values for currently active projects:

```{r funding_ByOrg_active, echo = FALSE}

gtrdat %>% filter(Status == "Active" & !is.na(AwardPounds))              %>% 
           select(FundingOrgName, AwardPounds)                           %>% 
           group_by(FundingOrgName)                                      %>% 
           summarise(TotalExpenditure = round(sum(AwardPounds)/1000000)) %>% 
           filter(!is.na(TotalExpenditure))                              %>% 
           ggplot(aes(x = FundingOrgName, y = TotalExpenditure)) + 
           geom_col(colour="black",fill="red") +
           xlab("Funding Organisation") + 
           ylab("Expenditure (in million of pounds)") +
           theme_bw() + scale_y_log10()
          
```

# ESRC data

## Project category awards

### All projects

The project categories for the ESRC awards covering the period `r format(min(esrcdat$StartDate),"%d/%m/%y")` to `r format(max(esrcdat$EndDate, na.rm = TRUE),"%d/%m/%y")`. No explicit data seems to be provided for *Studentships*.

```{r esrc_categories, echo = FALSE}

# Look at the project categories
esrcdat %>% select(ProjectCategory, AwardPounds)                           %>% 
            group_by(ProjectCategory)                                      %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(AverageAward))                                    %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 
```

### Active projects

This information corresponds to projects that are classified as *Active*.

```{r esrc_categories_active, echo = FALSE}

# Look at the project categories
esrcdat %>% filter(Status == "Active")                                     %>% 
            select(ProjectCategory, AwardPounds)                           %>% 
            group_by(ProjectCategory)                                      %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(AverageAward))                                    %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)), 
                col.names = c("Project Catgeory", "Number of Awards", 
                                "Total Awarded (£)","Average Award (£)")) 

```

## Award length distribution

### All projects
The award length distribution of the award lengths binned into 4-week periods is shown below. 
```{r award_lengths, echo = FALSE}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% select(StartDate, EndDate, ProjectCategory) %>% 
            filter(!is.na(StartDate) & !is.na(EndDate)) %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "weeks")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 5, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (weeks)") +
            labs(fill = "Project Category") + theme_bw()
```

### Active projects only
The same information as provided above but only for *Active* projects. The maximum funding period corresponds to `r as.numeric(max(difftime(esrcdat[["EndDate"]][esrcdat$Status == "Active"], esrcdat[["StartDate"]][esrcdat$Status == "Active"], units = "weeks")))` weeks.

```{r award_lengths_active, echo = FALSE}

# The as.numeric() is a workaround for https://github.com/tidyverse/ggplot2/issues/1377
esrcdat %>% filter(Status == "Active")                                          %>% 
            select(StartDate, EndDate, ProjectCategory)                         %>% 
            filter(!is.na(StartDate) & !is.na(EndDate))                         %>% 
            mutate(grant_length = difftime(EndDate, StartDate,units = "weeks")) %>% 
            ggplot(aes(x = as.numeric(grant_length), fill = ProjectCategory)) + 
            geom_histogram(binwidth = 5, colour="black") + 
            ylab("Number of Awards") + xlab("Award Length (weeks)") +
            labs(fill = "Project Category") + theme_bw()
```

## Geographical distribution of awards

### All projects

The expenditure of the awards over the whole time period by region ordered by the total award given is shown in the table below.

```{r esrc_byRegions, echo = FALSE}

esrcdat %>% select(Region, AwardPounds)                                    %>% 
            group_by(Region)                                               %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(TotalAward))                                      %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Active projects

We can generate the table for projects that are currently active ordered by the total award given is shown in the table below.

```{r esrc_byRegions_active, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                     %>% 
            select(Region, AwardPounds)                                    %>% 
            group_by(Region)                                               %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds))         %>% 
            mutate(AverageAward = round(TotalAward/Number,2))              %>% 
            arrange(desc(TotalAward))                                      %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ","))) %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Region", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```


## Funding by lead organisation

### All projects

This only shows the top 25 organisations by the average value of the award.
 
```{r AwardByOrg, echo = FALSE}

esrcdat %>% select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = round(TotalAward/Number,2))                       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```

### Active projects
This only shows the top 25 organisations with active projects by the average value of the award.
 
```{r ActiveAwardByOrg, echo = FALSE}

esrcdat %>% filter(Status == "Active")                                          %>% 
            select(LeadROName, AwardPounds)                                     %>% 
            group_by(LeadROName)                                                %>% 
            summarise(Number = n(), TotalAward = sum(AwardPounds,na.rm = TRUE)) %>% 
            mutate(AvgAward = round(TotalAward/Number,2))                       %>% 
            arrange(desc(AvgAward))                                             %>% 
            mutate(across(where(is.numeric), ~ format(., big.mark = ",")))      %>% 
            slice_head(n = 25)                                                  %>% 
            kbl(format="pipe", align = c("l",rep("r",3)),
                col.names = c("Org", "Number of Awards", "Total Awarded (£)","Average Award (£)")) 
```
## Department with active awards

### All projects

There are `r length(unique(esrcdat[["Department"]]))` unique departments. The table below only shows departments that have 30 or more occurrences.

```{r departments, echo = FALSE}

esrcdat %>% select(Department)         %>% 
            group_by(Department)       %>% 
            tally()                    %>%
            arrange(desc(n))           %>% 
            filter(n >= 30)            %>% 
            kbl(format="pipe", align = c("l","r"),
                col.names = c("Department", "Number")) 

```


### Active projects 

There are `r length(unique(esrcdat[["Department"]][esrcdat$Status == "Active"]))` unique departments for active projects (`r length(unique(esrcdat[["Department"]]))` for all projects). The table below only shows cases that have 30 or more occurrences in active projects.

```{r active_departments, echo = FALSE}

esrcdat %>% filter(Status == "Active") %>% 
            select(Department)         %>% 
            group_by(Department)       %>% 
            tally()                    %>%
            arrange(desc(n))           %>% 
            filter(n >= 30)            %>% 
            kbl(format="pipe", align = c("l","r"),
                col.names = c("Department", "Number")) 

```

