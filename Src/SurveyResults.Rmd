---
title: "ESRC Software Study - Survey results"
author: "Mario Antonioletti, Johanna Walker, Selina Aragon and Neil Chue Hong"
date: "`r Sys.Date()`"
output: 
    word_document:
      toc: true
      number_sections: true
      toc_depth: 4
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include = FALSE, warnings = FALSE}

# Defaults for chunk size outputs
knitr::opts_chunk$set(echo = TRUE, echo = FALSE, dpi = 300)

# Load packages ----------------------------------------------------------

library(readxl, quietly = TRUE)
library(readr, quietly = TRUE)
library(dplyr, warn.conflicts = FALSE)
library(tidyr, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(RColorBrewer, quietly = TRUE)
library(leaflet, quietly = TRUE)
library(stringr, quietly = TRUE)
library(kableExtra, quietly = TRUE)
library(webshot, quietly = TRUE) 
library(tibble)
library(scales)
library(ellipse, warn.conflicts = FALSE)
library(viridis)
library(corrplot)

```

```{r functions, include=FALSE}

# Function to list "Other" inputs separated by career stage
listOther <- function(Quest){
  
  for(careertype in c("Junior", "Early", "Mid", "Senior", "Other","-")){
    cat("\n\n*  **'",careertype,"' career stage**' \n\n", sep = "")
    data %>% select(other = all_of(Quest), career = Q20)        %>%
             filter(!is.na(other) & careertype == career)       %>% 
             mutate(line = paste0("   1. ",other,"\n"))         %>% 
             select(-other) -> a
  
           cat(a$line)
  }
}
```

```{r read_data}

# Read in the survey results
data0 <- read_xlsx("../Data/survey-results.xlsx")

# Upload location information - long and lat for institutions
colTypes <- cols(
                  Location = col_character(),
                  Latitude = col_double(),
                  Longitude = col_double(),
                 )

locations <- read_csv("../Data/locations.csv", col_types = colTypes)

# Cleaned up software - Q5 most important software - a free text box. Cleaned up
# in OpenRefine
important_software <- read_csv("../Data/Q5-software-split.csv",
                               show_col_types = FALSE)

# Replace " "s in column names by "_"
names(important_software) <- gsub(" ", "_", names(important_software))

# Count non-NA entries per row
important_software$count <- rowSums(!is.na(important_software))

# Add the identifier to the data frame.
important_software$URN <- data0$URN

# Read funding "cleaned" funding bodies.
funding <- read_csv("../Data/Q18-Other-funding.csv", show_col_types = FALSE)

# Attach the funding to the tibble
funding$URN <- data0$URN

# Cleaned up locations (Q17) (used OpenRefine to cluster some of the data)
cleanlocs <- read_csv("../Data/CleanedLocations.csv", col_types = cols(Q17 = col_character()))

# Attach the cleaned locations to the data set
data0$CleanLocs <- cleanlocs[[1]]

# Add some slightly simplified version of other disciplines for Q19
otherdis <- read_csv("../Data/q19-other-disciplines.csv", show_col_types = FALSE)
# Join with the current data
data0 <-  data0 %>% left_join(otherdis, by = "URN")

# Important data sources
importantds <- read_csv("../Data/q2a-mostimportantds.csv", show_col_types = FALSE)
names(importantds) <-  gsub(" ", "_",names(importantds))
data0 <- data0 %>% left_join(select(importantds, -Q2_a), by = "URN")

# Workflows
workflows <-  read_csv("../Data/q8-workflows.csv", show_col_types = FALSE)
data0 <- data0 %>% left_join(select(workflows, -Q8), by = "URN")
  
# Remove three non-UK contributions
uids <-  c("839822-839804-89766209", "839822-839804-90413512", "839822-839804-91099977")
# Remove one of two entries from the same person
uids <- c(uids, "839822-839804-91021028")

data0 <- data0 %>% filter(!(URN %in% uids))
funding <- funding %>% filter(!(URN %in% uids))
important_software <- important_software %>% filter(!(URN %in% uids))

```

```{r remap_data}

# Data that will actually be used
data <- data0

## Q2 Do you create or re-use data to undertake your research? --------
# 1	Create new data (including primary data collection and data generation)
# 2	Re-use existing data

# Create new data
data$Q2_1 <- gsub("1","create",data$Q2_1)

# Reusing data
data$Q2_2 <- gsub("1","reuse",data$Q2_2)

## Q2b Data sources for reusing existing data ----
# 1	UK Data Service
# 2	University / Institutional Repository
# 3	General data repository (e.g. Dryad, Figshare, Open Science Framework, Zenodo)
# 4	Shared by collaborators using a shared drive / folder
#       (e.g. DropBox, Google Drive, ...)
# 5	Personal recommendation, eg from discussion with other researchers
# 6	Other
ds <- c("UK Data Service",
        "University/Institutional Repo",
        "General data repository",
        "Collaborator's shared drive/folder",
        "Personal recommendation",
        "Other")

for( i in seq_len(6)){
  q <- paste0("Q2_b_",i)
  data[q] <- gsub("1", ds[i], data[[q]])
}

## Q3 Sharing data ------------------------------------------------------------
# 1	I have not yet shared my data
# 2	I have licensed my data to allow it to be shared
# 3	I have shared my data with individuals/groups that have requested access
# 4	I created a DOI (or other unique identifier) to make my data findable
# 5	I have promoted my data as an accessible resource in my publications
# 6	I have deposited my data in a repository
# 7	Other

sharing <- c("NotShared","Licensed","RestrictedSharing","CreatedDOI",
             "Publications","Repository","Other")

for( i in seq_len(7)){
  q <- paste0("Q3_",i)
  data[q] <- gsub("1", sharing[i], data[[q]])
}

## Q4 Use of software ------------------------------------------------------
#  1	Animation and Storyboarding, e.g. Scratch, Storyteller
#  2	AudioTools, e.g. Music Algorithms, Paperphone
#  3	Authoring and publishing tools, e.g. Twine, Oppia
#  4	Code versioning, e.g. GitHub
#  5	Content Management Systems (CMS), e.g. WordPress, Mura
#  6	CrowdSourcing, e.g. AllOurIdeas
#  7	Exhibition/Collection Tools, e.g. Omeka, Neatline
#  8	Internet Research Tools, e.g. Google tools or Wikipedia tools
#  9	Machine Learning and Artificial Intelligence, e.g. leximancer
# 10	Mapping Tools and Platforms, Geographic Information Systems, e.g. QGIS, CartoDB, ArcGIS
# 11	MindMapping Tools, e.g. DebateGraph
# 12	Network Analysis, e.g. GEPHI
# 13	Programming Languages, e.g. Python, MATLAB
# 14	Qualitative analyses, e.g. NVivo
# 15	Simulation Tools, e.g. NetLogo
# 16	Spreadsheets, e.g. Excel, Google Sheets
# 17	Statistical analysis, e.g. R, SPSS, Stata, SAS
# 18	Text Analysis Tools, e.g. Voyant, Linguistic Corpuses, Entity Recognizers
# 19	Text Collation Tools, e.g. Juxta Commons
# 20	Text Encoding, e.g. Oxygen XML
# 21	Text and Data Wrangling, e.g. Overview, OpenRefine
# 22	Topic Modelling, e.g. Leximancer
# 23	Transcription services, e.g. otter.ai
# 24	Video and Film Analysis, e.g. Cinemetrics
# 25	Visualisation Tools, e.g. D3.js, Tableau
# 26	Other
software <-  c("AnimationStoryborarding", "Autdiotools", "AuthoringPublishing",
               "CodeVersioning", "CMS", "CrowdSourcing", "ExhibionCollection",
               "internetResearchTools", "ML_AI", "GIS", "MindMapping",
               "NetworkAnalysis", "ProgLanguagues", "QualitativeAnalysis",
               "SimulationTools","Spreadsheets","StatisticalAnalysis",
               "TextAnalysis", "TextCollation", "TextEncoding", "DataWrangling",
               "TopicModelling", "Transcription","VideoFilmAnal", "Visualisation",
               "Other")

for(i in seq_len(26)){
  q <- paste0("Q4_",i)
  data[q] <- gsub("1", software[i], data[[q]])
}

## Q5 Most important software in research ----------------------------------



## Q6 Open source ----------------------------------------------------------
# 1	Yes
# 2	No

data$Q6 <- gsub("1", "Yes", data$Q6)
data$Q6 <- gsub("2", "No", data$Q6)
data$Q6[is.na(data$Q6)] <-  "-"


## Q6a Reasons for using open source ---------------------------------------
# 1	Institutional/Funder policy
# 2	Quality of support
# 3	Open standards/interoperability
# 4	Cost
# 5	Sustainability
# 6	Licensing
# 7	Meets user needs/usability
# 8	Staff previous experience, no need for training

os_reasons <- c("Policy","Support", "Interoperability","Cost","Sustainability",
                "Licensing","Usability", "Experience")

for(i in seq_len(8)){
  q <- paste0("Q6_a_", i)
  data[q] <- gsub("1", os_reasons[i], data[[q]])
}


## Q6b Reasons for not using open-source -----------------------------------
# 1	Institutional/Funder Policy
# 2	Speed of access to support
# 3	Lack of performance
# 4	Legal reasons
# 5	Continuity
# 6	Does not meet user needs/useability
# 7	Lack of expertise/requirement for training
# 8	Requirement from collaborators

no_os <- c("Policy", "PoorSupport", "NotPerformant", "Legal",
           "Continuity", "NotMeetNeeds", "NoExpertise","CollabReqs")

for(i in seq_len(8)){
  q <- paste0("Q6_b_", i)
  data[q] <- gsub("1", no_os[i], data[[q]])
}

## Q7	How is the software you use currently being supported and maintained? ----
# 1	Provided by my institution
# 2	Commercial or paid for external support
# 3	Open source community initiative
# 4	By a software specialist / research software engineer in my institution
# 5	By me or my team
# 6	No longer supported/maintained
# 7	Other

swmaintained <- c("Institution", "Commercial", "OpenSource","RSE", "MyTeam",
                  "NotMaintained", "Other")

for(i in seq_len(7)){
  q <- paste0("Q7_", i)
  data[q] <- gsub("1", swmaintained[i], data[[q]])
}

## Q8 use combinations of software -----

data %>%  select("Q8")                            %>%
          filter(!is.na(Q8))                      %>%
          mutate(s = str_wrap(Q8, width = 20))    %>%
          select(-Q8)                             %>%
          #print(n = nrow(.))                      %>%
          write_csv("../Data/wfcases.csv")

## Q9 Develop or extend software? ------------------------------------------
# 1	Yes
# 2	No
data$Q9[data$Q9 == 1] <- "Yes"
data$Q9[data$Q9 == 2] <- "No"

## Q10 if you write your own software do you: ------------------------------
# 1	Only make available for your own use
# 2	Only share within your research group
# 3	Only share with your collaborators (including at other institutions)
# 4	Share with others on request
# 5	Make widely available for use in your field / community
# 6	Other
swuse <- c("OwnUseOnly", "RGUseOnly", "CollaboratorsOnly",
           "ShareOnRequest", "ShareWidely","Other")

for(i in seq_len(6)){
  q <- paste0("Q10_", i)
  data[q] <- gsub("1", swuse[i], data[[q]])
}


## Q11 How did you acquire the skills necessary to utilise software --------
# 1	I am still trying to acquire the skills
# 2	Self-led online material
# 3	From examples and posts found online
# 4	Free community-led online workshops (e.g. Riot Science Club, ReproducibiliTea)
# 5	Conference workshops and tutorials
# 6	Peers and colleagues
# 7	Undergraduate/masters course
# 8	Postgraduate training as part of my PhD/CDT/DTC
# 9	Institutional training course
# 10	National Centre for Research Methods (NCRM) training
# 11	Third-party training course (not NCRM)
# 12	Other
skills <- c("StillTrying","OnlineCourses", "OnlineExamples", "OnlineWorkshops",
            "ConferenceWorkshops", "PeersColleagues", "UG/MasterCourse",
            "PGTraining","InstitutionalCourse","NCRM", "ThirdPartyCourse", "Other")

for(i in seq_len(12)){
  q <- paste0("Q11_", i)
  data[q] <- gsub("1", skills[i], data[[q]])
}

## Q11b NCRM courses ----
# 1	Data in the spotlight: International time series databanks
# 2	(Non-)Probability Survey Samples in Scientific Practice
# 3	Classification Models with Python
# 4	Principles and Practices of Quantitative Data Analysis
# 5	Scoping Reviews Short Course
# 6	UK Census Longitudinal Studies (UKcenLS) Webinar
# 7	Advanced Programming in R
# 8	Introduction to QGIS: Spatial Data
# 9	Spatial Analysis, Introduction to Spatial Data & Using R as a GIS
# 10	Structural Equation Modelling using Mplus
# 11	Testing for Mediation and Moderation using Mplus
# 12	Testing for Mediation and Moderation using SPSS (PROCESS macro)
# 13	Video Production for Anthropology and Social Research
# 14	Item Response Theory and Computer Adaptive Testing
# 15	Multilevel Modelling using Mplus
# 16	Multilevel Modelling using SPSS
# 17	Analysing interview and focus group data with NVivo
# 18	Latent Growth Curve Modelling using Mplus
# 19	Applied Data Science with R
# 20	Introduction to Sequence Analysis for Social Sciences
# 21	Video Editing
# 22	Other
ncrm_courses <- c("Data in the spotlight: International time series databanks",
                  "(Non-)Probability Survey Samples in Scientific Practice",
                  "Classification Models with Python",
                  "Principles and Practices of Quantitative Data Analysis",
                  "Scoping Reviews Short Course",
                  "UK Census Longitudinal Studies (UKcenLS) Webinar",
                  "Advanced Programming in R",
                  "Introduction to QGIS: Spatial Data",
                  "Spatial Analysis, Introduction to Spatial Data & Using R as a GIS",
                  "Structural Equation Modelling using Mplus",
                  "Testing for Mediation and Moderation using Mplus",
                  "Testing for Mediation and Moderation using SPSS (PROCESS macro)",
                  "Video Production for Anthropology and Social Research",
                  "Item Response Theory and Computer Adaptive Testing",
                  "Multilevel Modelling using Mplus",
                  "Multilevel Modelling using SPSS",
                  "Analysing interview and focus group data with NVivo",
                  "Latent Growth Curve Modelling using Mplus",
                  "Applied Data Science with R",
                  "Introduction to Sequence Analysis for Social Sciences",
                  "Video Editing",
                  "Other")

for(i in seq_len(22)){
  q <- paste0("Q11_b_", i)
  data[q] <- gsub("1", ncrm_courses[i], data[[q]])
}


## Q12 Development and maintenance of research software rewarded/recognised --------
# 1	Yes
# 2	No
# 3	Don't know
rew <- c("Yes", "No", "Don't know")

for(i in seq_len(3)){
  data["Q12"] <- gsub(i, rew[i], data[["Q12"]])
}

data["Q12"][is.na(data["Q12"])] <- "-"

# Q13 Statements abut software
# When answering this question, think about the most important piece of software
# you use for research that you couldn't live without. To what level do you
# agree/disagree with the following statements?
# Q13_1	I am aware of how the software I use is funded, managed and licensed
# 1	Strongly agree
# 2	Agree
# 3	Undecided
# 4	Disagree
# 5	Strongly Disagree
# Q13_2	My institution or funder's policies on how software is funded, managed and licensed are clear to me
# 1	Strongly agree
# 2	Agree
# 3	Undecided
# 4	Disagree
# 5	Strongly Disagree
# Q13_3	There is insufficient attention paid to software funding, management and licensing by the economic
#       and social sciences research community
# 1	Strongly agree
# 2	Agree
# 3	Undecided
# 4	Disagree
# 5	Strongly Disagree
# Q13_4	There is insufficient incentive for me to learn how my software is funded, managed and licensed
# 1	Strongly agree
# 2	Agree
# 3	Undecided
# 4	Disagree
# 5	Strongly Disagree

likert <- c("Strongly agree",
            "Agree",
            "Undecided",
            "Disagree",
            "Strongly disagree")

for(i in seq_len(4)){
  for(j in seq_len(5)){
     q <- paste0("Q13_", i,"_", j)
     data[q] <- gsub(1, likert[j], data[[q]])
  }
}

## Q14 Where do you normally run your digital tools/software? --------
# 1	My own laptop/desktop
# 2	Institutionally provided laptop/desktop
# 3	Server operated by research group / department
# 4	An institutional central service
# 5	Run by an individual data centre or at a data safe haven
# 6	A UK Tier 2 high performance computing service
# 7	A UK Tier 1 high performance computing service
# 8	The Cloud, e.g. Microsoft Azure or Amazon Web Services
# 9	Other

hw <- c("Own", "InstitutionallyProvided", "RG/DepServer","InstitutionalCentralService",
        "DataCentre/SafeHaven","Tier2", "Tier1", "Cloud", "Other")

for(i in seq_len(9)){
  q <- paste0("Q14_", i)
  data[q] <- gsub("1", hw[i], data[[q]])
}

## Q15 Licensing awareness -----
# A licensing policy provides instruction or guidance on what software licenses
# are preferred for the release of software.
# A publishing policy provides instruction or guidance on how software should be
# made available to others.
# Q15_1	My Institution's
# 1	Licensing
# 2	Publishing
# Q15_2	My funder's
# 1	Licensing
# 2	Publishing
# Q15_3	My Project's
# 1	Licensing
# 2	Publishing

licawa <- c("InstitutionLicensing", "InstitutionPublishing", "FunderLicensing", 
            "FunderPublishing", "ProjectLicensing", "ProjectPublishing")

data$Q15_1_1 <- gsub("1", "InstitutionLicensing", data$Q15_1_1)
data$Q15_1_2 <- gsub("1", "InstitutionPublishing", data$Q15_1_2)

data$Q15_2_1 <- gsub("1", "FunderLicensing", data$Q15_2_1)
data$Q15_2_2 <- gsub("1", "FunderPublishing", data$Q15_2_2)

data$Q15_3_1 <- gsub("1", "ProjectLicensing", data$Q15_3_1)
data$Q15_3_2 <- gsub("1", "ProjectPublishing", data$Q15_3_2)

## Q16 barriers to the use of software -------------------------------------
# 1	Lack of expertise within your team
# 2	Unsure how to best engage with research technical specialists such as software engineers, digital archivists, etc.
# 3	Training is not available
# 4	Training is available but you have no capacity to engage
# 5	Infrastructure is not available (Infrastructure could include: digital archives; computers with access to specialist software; data sets not digitised; etc)
# 6	No disciplinary tradition for digital methodology and tools
# 7	Concern that less value is attached to digital publications and other outputs of research, etc.
# 8	Format of data and assets you work with make them less amenable to technology
# 9	Lack of funding to support research projects/components of projects focusing on digital data and digital assets
# 10	Previous bad experience
# 11	I have not found software that is fit for my purpose
# 12	Lack of time to learn how to best use research software
# 13	Other

barriers <-  c("LackOfExpertise", "UnsureHowToEngageSpecialists", "NoTraining", "NoCapacity",
               "NoInfrastructure", "NoTradition", "ConcernAboutValue", "AssetsNotAmenable",
               "LackOfFunding", "BadExperiences", "NoPertinentSoftware", "LackOfTime", "Other")

for(i in seq_len(13)){
  q <- paste0("Q16_", i)
  data[q] <- gsub("1", barriers[i], data[[q]])
}

## Q17 Institutional affiliation -------------------------------------------

# Amend some data values that can be derived from other fields
data$CleanLocs[!is.na(data$CleanLocs) & data$CleanLocs == "PhD student"] <- "University of Bristol"
data$CleanLocs[!is.na(data$CleanLocs) & data$CleanLocs == "Bristol"] <- "University of Bristol"
data$CleanLocs[!is.na(data$CleanLocs) & data$CleanLocs == "University"] <-  NA # Can't place

# Add longitude and Latitude coordinates for the institutions
data <- data %>% left_join(locations, by = c("CleanLocs" = "Location"))

## Q19 Research discipline -------------------------------------------------
# 1	Area Studies
# 2	Data science and artificial intelligence
# 3	Demography
# 4	Development studies
# 5	Economics
# 6	Education
# 7	Environmental planning
# 8	History
# 9	Human Geography
# 10	Information science
# 11	Law & legal studies
# 12	Linguistics
# 13	Management & business studies
# 14	Political science. & international studies
# 15	Psychology
# 16	Science and Technology Studies
# 17	Social anthropology
# 18	Social policy
# 19	Social work
# 20	Sociology
# 21	Tools, technologies & methods
# 22	Other

discipline <- c("AreaStudies", "DS_AI", "Demography","DevelopmentStudies",
                "Economics", "Education", "EnvPlanning","History","HumanGeography",
                "InfoSci","Law","Linguistics","ManBusStud","PolSci_IntStud",
                "Pyschology", "SciTechStud",
                "SocAnth", "SocPol", "SocWork","Sociology","ToolsTechMeth",
                "Other")

for(i in seq_len(22)){
  q <- paste0("Q19_", i)
  data[q] <- gsub("1", discipline[i], data[[q]])
}

## Q20 Career stage ------------------------------------------------------
# 1	Phase 1 - Junior (e.g. PhD candidate, Junior Research Software Engineer)
# 2	Phase 2 - Early (e.g Research Assistant/Associate, first grant holder,
#             Lecturer, Research Software Engineer)
# 3	Phase 3 - Mid / Recognised (e.g. Senior Lecturer, Reader, Senior Researcher,
#             Senior Research Software Engineer, Research Software Group Leader)
# 4	Phase 4 - Established / Experienced / Senior (e.g. Professor, Director of
#             Research Computing, Distinguished Engineer, Chief Data Scientist)
# 5	Other

# Career stages order
career <- c("Junior", "Early", "Mid", "Senior", "Other","-")

# Remap NAs to "-"
data$Q20[is.na(data$Q20)] <- "-"

for(i in seq_len(5)){
  data["Q20"] <- gsub(i, career[i], data[["Q20"]])
}

# Convert to a factor
data$Q20 <-  factor(data$Q20, ordered = TRUE, levels = career)

# Establish a career stage order
#career_order <-  c("Junior","Early","Mid","Senior","Other","-")

## Q21 Gender --------------------------------------------------------------
# 1	Woman
# 2	Man
# 3	Non-binary person
# 4	Prefer not to disclose
# 5	Other

data$Q21[is.na(data$Q21)] <- "-"

gen <-  c("Woman", "Man", "Non-binary",  "Not disclosed", "Other")

for(i in seq_len(5)){
  data["Q21"] <- gsub(i, gen[i], data[["Q21"]])
}

data$Q21 <-  factor(data$Q21, levels = c(gen, "-"), ordered = TRUE)

# These values have low statistics so will be removed from some graphs.
lowstatsgender <- c("-", "Not disclosed","Non-binary","Other")

## Q22 Ethnic group ----
# 1	White: English, Welsh, Scottish, Northern Irish or British
# 2	White: Irish
# 3	White: Gypsy or Irish Traveller
# 4	White: Roma
# 5	White: Any other White background
# 6	Mixed or Multiple ethnic groups: White and Black Caribbean
# 7	Mixed or Multiple ethnic groups: White and Black African
# 8	Mixed or Multiple ethnic groups: White and Asian
# 9	Mixed or Multiple ethnic groups: Any other Mixed or Multiple background
# 10	Asian or Asian British: Indian
# 11	Asian or Asian British: Pakistani
# 12	Asian or Asian British: Bangladeshi
# 13	Asian or Asian British: Chinese
# 14	Asian or Asian British: Any other Asian background
# 15	Black, Black British, Caribbean or African: Caribbean
# 16	Black, Black British, Caribbean or African: African background
# 17	Black, Black British, Caribbean or African: Any other Black, Black British, Caribbean or African background
# 18	Other ethnic group: Arab
# 19	Prefer not to disclose
# 20	Other

ethinicity <- c("White: English, Welsh, Scottish, Northern Irish or British",
                "White: Irish",
                "White: Gypsy or Irish Traveller",
                "White: Roma",
                "White: Any other White background",
                "Mixed or Multiple ethnic groups: White and Black Caribbean",
                "Mixed or Multiple ethnic groups: White and Black African",
                "Mixed or Multiple ethnic groups: White and Asian",
                "Mixed or Multiple ethnic groups: Any other Mixed or Multiple background",
                "Asian or Asian British: Indian",
                "Asian or Asian British: Pakistani",
                "Asian or Asian British: Bangladeshi",
                "Asian or Asian British: Chinese",
                "Asian or Asian British: Any other Asian background",
                "Black, Black British, Caribbean or African: Caribbean",
                "Black, Black British, Caribbean or African: African background",
                "Black, Black British, Caribbean or African: Any other Black, Black British, Caribbean or African background",
                "Other ethnic group: Arab",
                "Prefer not to disclose",
                "Other")

# Work backwards otherwise partial numbers are substituted
for(i in 20:1){
  data["Q22"] <- gsub(i, ethinicity[i], data[["Q22"]])
}

data$Q22[is.na(data$Q22)] <-  "-"

## Disability ----
# 1	Yes
# 2	No

data$Q23[is.na(data$Q23)] <-  "-"

data["Q23"] <- gsub(1, "Yes", data[["Q23"]])
data["Q23"] <- gsub(2, "No", data[["Q23"]])

```

```{r internal_document, child = 'internal/contents.Rmd'}

# This file will not be included in the repo until after the report is completed

```

# Survey results

## Q2 Use of data

Do you create or re-use data to undertake your research (Please check
all that apply)

### Use of data results

```{r use_of_data}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q2_", 1:2))                                  %>% 
           pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL,
                      values_to = "datause")                                  %>%
         filter(datause != 0)                                                 %>%
         summarise(lab = paste0("Use of data (N=", n_distinct(URN),")")) -> my

data %>% select(URN, num_range("Q2_", 1:2)) %>%
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL,
                      values_to = "datause")                                  %>%
         filter(datause != 0)                                                 %>%
         group_by(datause)                                                    %>% 
         mutate(n = n_distinct(URN))                                                      %>% 
         ggplot(aes(x = datause, fill = n)) +
         geom_bar(colour = "black") +
         theme_bw() + theme(legend.position = "None") +
         xlab(my$lab) + ylab("Numbers") + 
          scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(y = n, label = n), vjust = -0.5, size = 3) 
```

### Use of data by career stage

```{r use_of_data_career}
data %>% select(num_range("Q2_", 1:2), career = Q20) %>%
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL,
                      values_to = "datause")                                  %>%
         filter(datause != 0)                                                 %>%
         ggplot(aes(x = datause, fill = career)) +
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Use of data") + ylab("Numbers") +
         geom_text(aes(x = datause, label = ..count..),
                position = position_stack(vjust = 0.5), stat = "count", colour = "black", size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Use of data as % of career stage population

```{r use_of_data_career_per}

data %>% select(num_range("Q2_", 1:2), career = Q20)                          %>%
         group_by(career)                                                     %>% 
         mutate(N = n())                                                      %>% 
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL,
                      values_to = "datause")                                  %>%
         filter(datause != 0)                                                 %>%
         group_by(datause, career)                                            %>% 
         mutate(per = n()/N)                                                  %>%
         distinct(datause, career, per)                                       %>% 
         ggplot(aes(x = datause, y = per, fill = career)) +
         geom_col(colour = "black", position = position_dodge2(width = 0.9, preserve = "single")) +
         theme_bw() +
         scale_y_continuous(labels = percent) +
         xlab("Use of data") + ylab("Percent") +
         geom_text(aes(x = datause, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Leave out low stat components

```{r use_of_data_career_per2}

data %>% select(num_range("Q2_", 1:2), career = Q20)                          %>%
         group_by(career)                                                     %>% 
         filter(!(career %in% c("-","Other")))                                %>% 
         mutate(N = n())                                                      %>% 
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL,
                      values_to = "datause")                                  %>%
         filter(datause != 0)                                                 %>%

         group_by(datause, career)                                            %>% 
         mutate(per = n()/N)                                                  %>%
         distinct(datause, career, per)                                       %>% 
         ggplot(aes(x = datause, y = per, fill = career)) +
         geom_col(colour = "black", position = position_dodge2(width = 0.9, preserve = "single")) +
         theme_bw() +
         scale_y_continuous(labels = percent) +
         xlab("Use of data") + ylab("Percent") +
         geom_text(aes(x = datause, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```
### Use of data by gender

```{r use_of_data_gender_num}
data %>% select(num_range("Q2_", 1:2), gender = Q21)                          %>%
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL, values_to = "datause")                 %>%
         filter(datause != 0)                                                 %>%
         group_by(datause, gender)                                            %>% 
         ggplot(aes(x = datause, fill = gender)) +
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Use of data") + ylab("Numbers") +
         geom_text(aes(x = datause, label = ..count..),
                position = position_stack(vjust = 0.5), stat = "count", colour = "black", size = 3) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Use of data by % of gender population

```{r use_of_data_gender_per}

data %>% select(num_range("Q2_", 1:2), gender = Q21)                          %>%
         group_by(gender)                                                     %>% 
         mutate(N = n())                                                      %>% 
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL, values_to = "datause")                 %>%
         filter(datause != 0)                                                 %>%
         group_by(datause, gender)                                            %>%
         mutate(per = n()/N)                                                  %>% 
         distinct(datause, gender, per)                                       %>% 
         ggplot(aes(x = datause, y = per, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + scale_y_continuous(labels = percent_format(accuarcy = 1)) +
         xlab("Use of data") + ylab("Percentage") +
         geom_text(aes(x = datause, label = percent(per, accuracy = 1 )), vjust = -0.5,
                position = position_dodge2(width = 0.9, preserve = "single"), colour = "black", size = 2) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

Remove the low statistic components

```{r use_of_data_gender_per2}

data %>% select(num_range("Q2_", 1:2), gender = Q21)                          %>%
         filter(!(gender %in% lowstatsgender))                                %>% 
         group_by(gender)                                                     %>% 
         mutate(N = n())                                                      %>% 
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL, values_to = "datause")                 %>%
         filter(datause != 0)                                                 %>%
         group_by(datause, gender)                                            %>%
         mutate(per = n()/N)                                                  %>% 
         distinct(datause, gender, per)                                       %>% 
         ggplot(aes(x = datause, y = per, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + scale_y_continuous(labels = percent_format(accuarcy = 1)) +
         xlab("Use of data") + ylab("Percentage") +
         geom_text(aes(x = datause, label = percent(per, accuracy = 1 )), vjust = -0.5,
                position = position_dodge2(width = 0.9, preserve = "single"), colour = "black", size = 2) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```
### Gender and career stage

```{r use_of_data_gender_per2_career}

data %>% select(num_range("Q2_", 1:2), career = Q20, gender = Q21)            %>%
         filter(!(career %in% c("-", "Other")))                               %>% 
         filter(!(gender %in% lowstatsgender))                                %>% 
         group_by(gender)                                                     %>% 
         mutate(N = n())                                                      %>% 
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL, values_to = "datause")                 %>%
         filter(datause != 0)                                                 %>%
         group_by(datause, gender, career)                                    %>%
         mutate(per = n()/N)                                                  %>% 
         distinct(datause, gender, per, career)                               %>% 
         ggplot(aes(x = datause, y = per, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + scale_y_continuous(labels = percent_format(accuarcy = 1), limits = c(0, 0.34)) +
         xlab("Use of data") + ylab("Percentage") +
         geom_text(aes(x = datause, label = percent(per, accuracy = 1 )), vjust = -0.5,
                position = position_dodge2(width = 0.9, preserve = "single"), colour = "black", size = 2) +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         facet_wrap(~career)
```

### Data use by institution

In order to make the diagram less busy only institutions that have more
than 2 entries are shown.

```{r datause_institution}

data %>% select(num_range("Q2_", 1:2), institution = CleanLocs)              %>%
         group_by(institution)                                               %>% 
         mutate(N = n())                                                     %>% 
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL, values_to = "datause")                %>%
         filter(datause != 0 & !is.na(institution))                          %>% 
         filter(N > 2)                                                       %>% 
         group_by(datause, institution)                                      %>% 
         mutate(per = n()/N)                                                 %>% 
         filter(per > 0)                                                     %>% 
         ggplot(aes(x = datause, y = institution, size = per)) + 
         theme_bw() +
         geom_point(alpha = 0.25) + xlab("Data use") + ylab("Institutions") + labs(size = "Percent") +
         scale_size_continuous(labels = percent_format(accuracy = 1)) +
         theme(axis.text.y = element_text(size = 6)) 
```

As with the previous diagram only institutions that have more than 2
entries are shown.

```{r datause_institution_bar}

data %>% select(num_range("Q2_", 1:2), institution = CleanLocs)              %>%
         pivot_longer(cols = num_range("Q2_", 1:2), 
                      names_to = NULL, 
                      values_to = "datause")                                 %>%
         filter(datause != 0)                                                %>% 
         group_by(institution)                                               %>% 
         filter(n() > 2)                                                     %>% 
         group_by(datause, institution)                                      %>% 
         ggplot(aes(x = institution, fill = datause)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         ylab("Numbers") + xlab("Institution") + labs(fill = "Data use") +
         theme(axis.text.x = element_text(size = 6, angle = -90, vjust = 0.15, hjust=0)) +
         geom_text(aes(label = ..count..), position = position_stack(),  
                   stat = "count", vjust = -0.5, size = 2)

```

### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices.

```{r datause_choices}

data %>% select(id = URN, num_range("Q2_",1:2))                       %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```


### Combined plot

Can produce a plot of the above table. N = 163.

```{r datause_choices_plot}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q2_", 1:2))                           %>% 
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         summarise(lab = paste0("Use of data (N=", n_distinct(URN),")")) -> my

data %>% select(id = URN, num_range("Q2_",1:2))                        %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>%
         mutate(N = n())                                               %>% 
         group_by(choices)                                             %>%
         mutate(n = n())                                               %>%
         mutate(per = percent(n/N, accuracy = 1))                      %>% 
         distinct(n, N, choices, per)                                  %>% 
         ggplot(aes(x = choices, y = n, fill = n)) + 
         geom_col(colour = "black") + theme_bw() +
         xlab(my$lab) + ylab("Numbers") + scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(label = paste0(n," (",per,")")), vjust = -0.5, size = 3) + theme(legend.position = "None") +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse"))
```

### Combined plot by career

Adding career stage.

```{r datause_choices_career}

data %>% select(id = URN, num_range("Q2_",1:2), career = Q20)          %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices, career)                                 %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices, career)                                     %>% 
         tally()                                                       %>% 
         arrange(desc(n))                                              %>% 
         ggplot(aes(x = choices, y = n, fill = career)) + 
         geom_col(colour = "black") + theme_bw() +
         xlab("Data use") + ylab("Numbers") +
         geom_text(aes(label = n), position = position_stack(0.5), size = 3) +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse")) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Combined plot by % career stage 

Adding career stage. Percentages may not add to 100% as values that do not contribute
are not shown.

```{r datause_choices_career_per}

data %>% select(id = URN, num_range("Q2_",1:2), career = Q20)          %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices, career)                                 %>%
         group_by(career)                                              %>% 
         mutate(N = n())                                               %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices, career)                                     %>%
         mutate(n = n())                                               %>% 
         mutate(per = percent(n/N, accuracy = 1))                      %>% 
         distinct(choices, career, per, n, N)                          %>% 
         ggplot(aes(x = choices, y = n/N, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Data use") + ylab("Percentage") +
         geom_text(aes(label = paste0(n," (",per,")")), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.5, size = 2) +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse")) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```
Filter out the "Other" and "-" categories.

```{r datause_choices_career_per2}

data %>% select(id = URN, num_range("Q2_",1:2), career = Q20)          %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>% 
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices, career)                                 %>%
         group_by(career)                                              %>% 
         mutate(N = n())                                               %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices, career)                                     %>%
         mutate(n = n())                                               %>% 
         mutate(per = percent(n/N, accuracy = 1))                      %>% 
         filter(career != "Other" & career != "-")                     %>% 
         distinct(choices, career, per, n, N)                          %>% 
         ggplot(aes(x = choices, y = n/N, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Data use") + ylab("Percent") +
         geom_text(aes(label = per), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.5, size = 2.5) +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse")) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Combined by gender

```{r datause_choices_gender_per2}

data %>% select(id = URN, num_range("Q2_",1:2), gender = Q21)          %>%
         group_by(gender)                                              %>% 
         mutate(N = n())                                               %>% 
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>% 
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices, gender, N)                              %>%
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices, gender)                                     %>%
         mutate(n = n())                                               %>% 
         mutate(per = percent(n/N, accuracy = 1))                      %>% 
         filter(!(gender %in% lowstatsgender))                         %>% 
         distinct(choices, gender, per, n, N)                          %>% 
         ggplot(aes(x = choices, y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Data use") + ylab("Percent") +
         geom_text(aes(label = per), position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.5, size = 3) +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse")) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r datause_choices_gender_career}

data %>% select(id = URN, num_range("Q2_",1:2), career = Q20, gender = Q21)  %>%
         filter(!(career %in% c("-","Other")))                               %>% 
         group_by(gender)                                                    %>% 
         mutate(N = n())                                                     %>% 
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                      %>%
         filter(ds != 0)                                                     %>% 
         group_by(id)                                                        %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))         %>% 
         distinct(id, choices, gender, N, career)                            %>%
         ungroup()                                                           %>% 
         select(-id)                                                         %>% 
         group_by(choices, gender, career)                                   %>%
         mutate(n = n())                                                     %>% 
         mutate(per = percent(n/N, accuracy = 1))                            %>% 
         filter(!(gender %in% lowstatsgender))                               %>% 
         distinct(choices, gender, per, n, N)                                %>% 
         ggplot(aes(x = choices, y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0,0.3)) +
         xlab("Data use") + ylab("Percent") +
         geom_text(aes(label = per), position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.5, size = 3) +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse")) +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         facet_wrap(~ career)
```

### Combined data use by institution

Only showing instances that have more than 3 case at an institution otherwise the diagram
becomes too busy and is difficult to see.

```{r combined_datause_institution}
data %>% select(id = URN, num_range("Q2_",1:2), institution = CleanLocs)          %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices, institution)                            %>%
         ungroup()                                                     %>% 
         select(-id)                                                   %>%
         mutate(institution = ifelse(is.na(institution), "-", institution)) %>% 
         group_by(institution)                                         %>% 
         filter(n() > 3)                                               %>% 
         group_by(choices, institution)                                %>%
         mutate(n = n())                                               %>% 
         distinct(choices, institution, n)                             %>% 
         ggplot(aes(x = choices, y = institution)) + 
         geom_tile(aes(fill = n)) + 
         theme_bw() +
         xlab("Data use") + ylab("Institutions") +
         theme(axis.text.y = element_text(size = 8), legend.position = "None") +
         geom_text(aes(label = n), size = 3, colour = "white") +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse")) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")
```

### Combined data use and research discipline

Showing how data is used by discipline as a bar chart

```{r datause_discipline_bar}

data %>% select(URN, num_range("Q2_",1:2))                                   %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                      %>%
         filter(ds != 0)                                                     %>%
         group_by(URN)                                                       %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))         %>% 
         distinct(URN, choices)                                              %>% 
         left_join(select(data, URN, num_range("Q19_", 1:22)), by = "URN")   %>% 
         pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "disciplines")                             %>%                  
          filter(disciplines != 0)                                           %>%
         ungroup()                                                           %>% 
         select(-URN)                                                        %>% 
         group_by(choices, disciplines)                                      %>%
         mutate(n = n())                                                     %>% 
         distinct(choices, disciplines, n)                                   %>% 
         ggplot(aes(x = n, y = disciplines, fill = choices)) + 
         geom_col(colour = "black") + 
         theme_bw() +
         xlab("Numbers") + ylab("Disciplines") +
         theme(axis.text.y = element_text(size = 8)) + 
         scale_fill_discrete(name = "Data use", labels = c("Create", "Create and Reuse", "Reuse")) +
         geom_text(aes(label = n), size = 2, position = position_stack(0.5), colour = "black") 
```

or as a tile diagram - I do not think this is clearer.

```{r datause_discipline_tile}

data %>% select(URN, num_range("Q2_",1:2))                                   %>%
         pivot_longer(cols = starts_with("Q2_"),
                      names_to = NULL,
                      values_to = "ds")                                      %>%
         filter(ds != 0)                                                     %>%
         group_by(URN)                                                       %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))         %>% 
         distinct(URN, choices)                                              %>% 
         left_join(select(data, URN, num_range("Q19_", 1:22)), by = "URN")   %>% 
         pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "disciplines")                             %>%                  
          filter(disciplines != 0)                                           %>%
         ungroup()                                                           %>% 
         select(-URN)                                                        %>% 
         #group_by(disciplines)                                              %>% 
         #filter(n() > 3)                                                    %>% 
         group_by(choices, disciplines)                                      %>%
         mutate(n = n())                                                     %>% 
         distinct(choices, disciplines, n)                                   %>% 
         ggplot(aes(x = choices, y = disciplines)) + 
         geom_tile(aes(fill = n)) + 
         theme_bw() +
         xlab("Data use") + ylab("Disciplines") +
         theme(axis.text.y = element_text(size = 8), legend.position = "None") +
         geom_text(aes(label = n), size = 3, colour = "white") +
         scale_x_discrete(labels = c("Create", "Create and Reuse", "Reuse")) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")
```


## Q2a most important sources of data

What are your most important data source(s)?

### Important data sources

This is a simplified version of the input provided by the respondents. It only 
shows entries with more than two values.

```{r importantDS}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("ImportantDS_", 1:7))  %>% 
         pivot_longer(cols = num_range("ImportantDS_", 1:7),
                      names_to = NULL,
                      values_to = "importantDS")               %>%
         filter(!is.na(importantDS))                           %>%
         summarise(lab = paste0("Data sources (N=", n_distinct(URN),")")) -> my

data %>% select(URN, num_range("ImportantDS_", 1:7))          %>% 
         pivot_longer(cols = num_range("ImportantDS_", 1:7),
                      names_to = NULL,
                      values_to = "importantDS")               %>%
         filter(!is.na(importantDS))                           %>%
         group_by(importantDS)                                 %>% 
         mutate(n = n_distinct(URN))                           %>% 
         distinct(importantDS, n)                              %>% 
         filter(n > 2)                                         %>% 
         ggplot(aes(x = reorder(importantDS, -n), y = n, fill = n)) +
         geom_col(colour = "black") +
         theme_bw() + ylim(0, 33) + scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(label = n), vjust = -0.5, size = 3) + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 10), legend.position = "None") +
         xlab(my$lab) + ylab("Numbers")

```

### Important data sources by career


```{r importantDS_career}

data %>% select(num_range("ImportantDS_", 1:7), career = Q20)  %>% 
         filter(!(career %in% c("-", "Other")))                %>% 
         pivot_longer(cols = num_range("ImportantDS_", 1:7),
                      names_to = NULL,
                      values_to = "importantDS")               %>%
         filter(!is.na(importantDS))                           %>%
         group_by(importantDS, career)                         %>% 
         mutate(n = n())                                       %>% 
         distinct(importantDS, n, career)                      %>% 
         filter(n > 2)                                         %>% 
         ggplot(aes(x = reorder(importantDS, -n), y = n, fill = career)) +
         geom_col( colour = "black") +
         theme_bw() + ylim(0, 36.5) +
         geom_text(aes(label = n), position = position_stack(0.5),  size = 3) +
         theme(axis.text.x = element_text(angle = -45, hjust=0, size = 8)) +
         xlab("Data sources") + ylab("Numbers") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")

```
### Important data sources by % career

```{r importantDS_career_per}

data %>% select(num_range("ImportantDS_", 1:7), career = Q20)  %>% 
         filter(!(career %in% c("-", "Other")))                 %>% 
         group_by(career)                                      %>% 
         mutate(N = n())                                       %>% 
         pivot_longer(cols = num_range("ImportantDS_", 1:7),
                      names_to = NULL,
                      values_to = "importantDS")               %>%
         filter(!is.na(importantDS))                           %>%
         group_by(importantDS, career)                         %>% 
         mutate(n = n())                                       %>% 
         distinct(importantDS, n, career, N)                   %>%
         mutate(per = percent(n/N, accuracy = 1))              %>% 
         filter(n > 2)                                         %>% 
         ggplot(aes(x = reorder(importantDS, -n), y = n/N, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +  scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = per), position = position_dodge2(width = 1.0, preserve = "single"), 
                   vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, hjust=0, size = 8)) +
         xlab("Data sources") + ylab("Percent") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")

```


### Important data sources by gender

```{r importantDS_gender}

data %>% select(num_range("ImportantDS_", 1:7), gender = Q21)  %>% 
         filter(!(gender %in% lowstatsgender))                 %>% 
         pivot_longer(cols = num_range("ImportantDS_", 1:7),
                      names_to = NULL,
                      values_to = "importantDS")               %>%
         filter(!is.na(importantDS))                           %>%
         group_by(importantDS, gender)                         %>% 
         mutate(n = n())                                       %>% 
         distinct(importantDS, n, gender)                      %>% 
         filter(n > 2)                                         %>% 
         ggplot(aes(x = reorder(importantDS, -n), y = n, fill = gender)) +
         geom_col( colour = "black") +
         theme_bw() + ylim(0, 36.5) +
         geom_text(aes(label = n), position = position_stack(0.5),  size = 3) +
         theme(axis.text.x = element_text(angle = -45, hjust=0, size = 8)) +
         xlab("Data sources") + ylab("Numbers") +
         scale_fill_brewer(palette = "Set2", name = "Gender")

```

### Important data sources by % gender

```{r importantDS_gender_per}

data %>% select(num_range("ImportantDS_", 1:7), gender = Q21)  %>% 
         filter(!(gender %in% lowstatsgender))                 %>% 
         group_by(gender)                                      %>% 
         mutate(N = n())                                       %>% 
         pivot_longer(cols = num_range("ImportantDS_", 1:7),
                      names_to = NULL,
                      values_to = "importantDS")               %>%
         filter(!is.na(importantDS))                           %>%
         group_by(importantDS, gender)                         %>% 
         mutate(n = n())                                       %>% 
         distinct(importantDS, n, gender, N)                   %>%
         mutate(per = percent(n/N, accuracy = 1))              %>% 
         filter(n > 2)                                         %>% 
         ggplot(aes(x = reorder(importantDS, -n), y = n/N, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +  scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = per), position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, hjust=0, size = 8)) +
         xlab("Data sources") + ylab("Percent") +
         scale_fill_brewer(palette = "Set2", name = "Gender")

```

### Important data sources by % gender and career stage

```{r importantDS_gender_per_career}

data %>% select(num_range("ImportantDS_", 1:7), career = Q20, gender = Q21)  %>% 
         filter(!(gender %in% lowstatsgender))                               %>% 
         group_by(gender)                                                    %>% 
         mutate(N = n())                                                     %>% 
         pivot_longer(cols = num_range("ImportantDS_", 1:7),
                      names_to = NULL,
                      values_to = "importantDS")                             %>%
         filter(!is.na(importantDS))                                         %>%
         group_by(importantDS, gender, career)                               %>% 
         mutate(n = n())                                                     %>% 
         distinct(importantDS, n, gender, N, career)                         %>%
         mutate(per = percent(n/N, accuracy = 1))                            %>% 
         filter(n > 2)                                                       %>% 
         ggplot(aes(x = reorder(importantDS, -n), y = n/N, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.14)) +
         geom_text(aes(label = per), position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, hjust=0, size = 8)) +
         xlab("Data sources") + ylab("Percent") +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         facet_wrap(~ career)

```

### List resources

Number of responses by career stage.

```{r important_srcs_resp_career}

data %>% select(Q2_a, career = Q20) %>% 
         group_by(career)           %>% 
         mutate(N = n())            %>% 
         distinct(career, N)        %>% 
         ggplot(aes(x = career, y = N, fill = career)) +
         geom_col(colour = "black") +
         theme_bw() + theme(legend.position = "none") +
         xlab("Career stage") + ylab("Number of responses") +
         geom_text(aes(x = career, label = N), vjust = -0.5,  colour = "black", size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

With the actual responses:

```{r important_data, results = 'asis'}

listOther("Q2_a")

```

## Q2b Reusing existing data

If you re-use existing data, where do you find these?

### Reusing existing data responses

```{r data_sources}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q2_b_",1:6))  %>% 
         pivot_longer(cols = num_range("Q2_b_",1:6),
                      names_to = NULL,
                      values_to = "ds")           %>%
         filter(ds != 0)                          %>%
         summarise(lab = paste0("Data sources (N=", n_distinct(URN),")")) -> my

data %>% select(URN, num_range("Q2_b_",1:6))            %>%
         pivot_longer(cols = num_range("Q2_b_",1:6),
                      names_to = NULL,
                      values_to = "ds")                 %>%
         filter(ds != 0)                                %>%
         mutate(N = n_distinct(URN))                    %>% 
         group_by(ds)                                   %>% 
         mutate(n = n())                                %>% 
         mutate(per = percent(n/N, accuracy = 1))       %>% 
         ggplot(aes(x = reorder(ds, -n), fill = n)) + 
         geom_bar(colour = "black") +
         theme_bw() + ylab("Numbers") + scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(label = paste0(n," (", per, ")")), 
                   stat = "count", vjust = -0.35, size = 3)  +
         xlab(my$lab) + ylim(0, 75) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 8)) +
         theme(legend.position = "none")
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q2_correlations}

data0 %>% select(num_range("Q2_b_",1:6)) -> q  
names(q) <- ds

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50],cex.lab = 0.6*par("cex.lab"))

```
### Reusing existing data by career

```{r data_sources_career}

data %>% select(num_range("Q2_b_",1:6), career = Q20)      %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                    %>%
         filter(ds != 0)                                   %>%
         group_by(ds, career)                              %>% 
         mutate(n = n())                                   %>% 
         ggplot(aes(x = ds, fill = career)) + 
         geom_bar(colour = "black") +
         theme_bw() + ylab("Numbers") +
         geom_text(aes(label = ..count..), position = position_stack(0.5), stat = "count", size = 3)  +
         xlab("Data sources") + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 8),
               legend.text=element_text(size = 6)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Reusing existing data by % career population

```{r data_sources_career_per}

data %>% select(num_range("Q2_b_",1:6), career = Q20)      %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                    %>%
         filter(ds != 0)                                   %>%
         group_by(career)                                  %>% 
         mutate(N = n())                                   %>% 
         group_by(ds, career)                              %>% 
         mutate(per = n()/ N)                              %>% 
         distinct(ds, career, per)                         %>% 
         ggplot(aes(x = ds, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") +
         theme_bw() + ylab("Percent") +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.35, size = 2)  +
         xlab("Data sources") + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 8),
               legend.text=element_text(size = 6)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing the "Other" and "-" (not specified) choices:

```{r data_sources_career_per2}

data %>% select(num_range("Q2_b_",1:6), career = Q20)      %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                    %>%
         filter(ds != 0)                                   %>%
         group_by(ds)                                      %>% 
         mutate(M = n())                                   %>% 
         group_by(career)                                  %>% 
         mutate(N = n())                                   %>% 
         filter(career != "Other" & career != "-")         %>% 
         group_by(ds, career)                              %>% 
         mutate(n = n())                                   %>% 
         mutate(per = n/ N)                                %>% 
         distinct(ds, career, per, n, M)                   %>% 
         ggplot(aes(x = reorder(ds, -M), y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") +
         theme_bw() + ylab("Percent") +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   vjust = -0.35, size = 3)  +
         xlab("Data sources") + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 8),
               legend.text=element_text(size = 6)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Reusing existing data by gender

```{r data_sources_gender}

data %>% select(num_range("Q2_b_",1:6), gender = Q21)      %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                    %>%
         filter(ds != 0)                                   %>%
         group_by(ds, gender)                              %>% 
         mutate(n = n())                                   %>% 
         ggplot(aes(x = ds, fill = gender)) + 
         geom_bar(colour = "black") +
         theme_bw() + ylab("Numbers") +
         geom_text(aes(label = ..count..), position = position_stack(0.5), stat = "count", size = 3)  +
         xlab("Data sources") + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 8),
               legend.text=element_text(size = 6)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Reusing existing data by gender %


```{r data_sources_gender_per}

data %>% select(num_range("Q2_b_",1:6), gender = Q21)      %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                    %>%
         filter(ds != 0)                                   %>%
         group_by(gender)                                  %>% 
         mutate(N = n())                                   %>% 
         group_by(ds, gender)                              %>% 
         mutate(per = n()/N)                               %>% 
         distinct(ds, gender, per)                         %>% 
         ggplot(aes(x = ds, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + ylab("Percent") +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.35, size = 2)  +
         xlab("Data sources") + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0, size = 8),
               legend.text=element_text(size = 6)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

Removing low stat components

```{r data_sources_gender_per2}

data %>% select(num_range("Q2_b_",1:6), gender = Q21)      %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                    %>%
         filter(ds != 0)                                   %>%
         group_by(ds)                                      %>% 
         mutate(M = n())                                   %>% 
         group_by(gender)                                  %>% 
         mutate(N = n())                                   %>% 
         filter(!(gender %in% lowstatsgender))             %>% 
         group_by(ds, gender)                              %>% 
         mutate(per = n()/N)                               %>% 
         distinct(ds, gender, per, M)                      %>% 
         ggplot(aes(x = reorder(ds, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + ylab("Percent") +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.35, size = 3)  +
         xlab("Data sources") + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0, size = 8),
               legend.text=element_text(size = 6)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r data_sources_gender_per3}

data %>% select(num_range("Q2_b_",1:6), career = Q20, gender = Q21)      %>%
         filter(!(career %in% c("-", "Other")))                          %>% 
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                                  %>%
         filter(ds != 0)                                                 %>%
         group_by(ds)                                                    %>% 
         mutate(M = n())                                                 %>% 
         group_by(gender)                                                %>% 
         mutate(N = n())                                                 %>% 
         filter(!(gender %in% lowstatsgender))                           %>% 
         group_by(ds, gender)                                            %>% 
         mutate(per = n()/N)                                             %>% 
         distinct(ds, gender, per, M, career)                             %>% 
         ggplot(aes(x = reorder(ds, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + ylab("Percent") +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.35)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.35, size = 3)  +
         xlab("Data sources") + 
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0, size = 8),
               legend.text=element_text(size = 6)) + facet_wrap(~ career) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Reusing existing data by Institution

Only showing institutions that have more than 2 total entries to make
the diagram less busy.

```{r dataSources_institutions}

data %>% select(num_range("Q2_b_",1:6), institutions = CleanLocs)     %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                               %>%
         filter(ds != 0 & !is.na(institutions))                       %>%
         group_by(institutions)                                       %>% 
         filter(n() > 2)                                              %>% 
         group_by(ds, institutions)                                   %>% 
         ggplot(aes(x = institutions, fill = ds)) + 
         geom_bar(colour = "black") + theme_bw() +
         ylab("Numbers") + xlab("Institution") + labs(fill = "Data sources") +
         theme(axis.text.x = element_text(size = 10, angle = -90, vjust = 0.15, hjust = 0),
               legend.text=element_text(size = 8)) +
         geom_text(aes(label = ..count..), 
                   position = position_stack(),  stat = "count", vjust = -0.35, size = 3)

```

### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices.

```{r ds_choices}

data %>% select(id = URN, num_range("Q2_b_",1:6))                      %>%
         pivot_longer(cols = starts_with("Q2_b_"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
        # filter(n > 5)                                                %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```



### Other data sources

Values given for other data sources:

```{r other_data_sources, results='asis'}

listOther("Q2_b_i")

```

## Q2c Data processes

If you create, collect or generate your own data, could you briefly
describe how this is done?

```{r data_processes, results='asis'}

listOther("Q2_c")

```

## Q3 Sharing data

How do you share your data?

### Response distribution

```{r sharing_data}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q3_", 1:7))                           %>% 
         pivot_longer(cols = num_range("Q3_", 1:7),
                      names_to = NULL,
                      values_to = "DataSharing")                      %>%
         filter(DataSharing != 0)                                     %>%
         summarise(lab = paste0("Data sharing habits (N=", n_distinct(URN),")")) -> my

data %>% select(URN, num_range("Q3_", 1:7))                           %>%
         pivot_longer(cols = num_range("Q3_", 1:7),
                      names_to = NULL,
                      values_to = "DataSharing")                      %>%
         filter(DataSharing != 0)                                     %>%
         mutate(N = n_distinct(URN))                                  %>% 
         group_by(DataSharing)                                        %>% 
         mutate(n = n())                                              %>% 
         mutate(per = percent(n/N, accuracy = 1))                     %>% 
         distinct(n, per, DataSharing)                                %>% 
         ggplot(aes(x = reorder(DataSharing, -n), y = n, fill = n)) +
         geom_col(colour = "black") + 
         theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab(my$lab) + ylab("Numbers") + ylim(0,83) +
         geom_text(aes(label = paste0(n, " (", per,")")), vjust = -0.5, size = 3) +
         theme(legend.position = "none") 
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q3_correlations}

data0 %>% select(num_range("Q3_", 1:7)) -> q  
names(q) <- sharing

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50])

```

### Data sharing by career stage

```{r sharing_data_career}

data %>% select(num_range("Q3_", 1:7), career = "Q20")                     %>%
        pivot_longer(cols = starts_with("Q3_"), values_to = "DataSharing") %>%
        filter(DataSharing != 0)                                           %>%
        group_by(DataSharing)                                              %>% 
        mutate(n = n())                                                    %>% 
        ggplot(aes(x = reorder(DataSharing, -n), fill = career)) +
        geom_bar(colour = "black") + 
        theme_bw() +
        theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0), legend.text=element_text(size = 8)) +
        xlab("Data sharing habits") + ylab("Numbers") +
        geom_text(aes(x = DataSharing, label = ..count..),
                    position = position_stack(vjust = 0.5), stat = "count", colour = "black", size = 3) +
        scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Data sharing by percentage at each career stage


```{r sharing_data_career_per}

data %>% select(num_range("Q3_", 1:7), career = "Q20")                     %>%
        pivot_longer(cols = starts_with("Q3_"), 
                     names_to = NULL,
                     values_to = "DataSharing")                            %>%
        filter(DataSharing != 0)                                           %>%
        group_by(career)                                                   %>% 
        mutate(N = n())                                                    %>%
        group_by(DataSharing, career)                                      %>% 
        mutate(per = n()/N)                                                %>% 
        distinct(career, DataSharing, per)                                 %>% 
        ggplot(aes(x = DataSharing, y= per,fill = career)) +
        geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
        theme_bw() +
        theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0), legend.text=element_text(size = 8)) +
        xlab("Data sharing habits") + ylab("Numbers") +
        scale_y_continuous(labels = percent_format(accuracy = 1)) +
        geom_text(aes(x = DataSharing, label = percent(per, accuracy = 1)), vjust = -0.5,
                      position = position_dodge2(width = 0.9, preserve = "single"), 
                      colour = "black", size = 2) +
        scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing "Other" and "-" as they have low stats.

```{r sharing_data_career_per2}

data %>% select(num_range("Q3_", 1:7), career = "Q20")                     %>%
        pivot_longer(cols = starts_with("Q3_"), 
                     names_to = NULL,
                     values_to = "DataSharing")                            %>%
        filter(DataSharing != 0)                                           %>%
        group_by(DataSharing)                                              %>%
        mutate(M = n())                                                    %>% 
        group_by(career)                                                   %>% 
        mutate(N = n())                                                    %>%
        filter(career != "Other" & career != "-")                          %>% 
        group_by(DataSharing, career)                                      %>% 
        mutate(per = n()/N)                                                %>% 
        distinct(career, DataSharing, per, M)                              %>% 
        ggplot(aes(x = reorder(DataSharing, -M), y= per,fill = career)) +
        geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                 colour = "black") + 
        theme_bw() + 
        theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0), 
              legend.text=element_text(size = 6)) +
        xlab("Data sharing habits") + ylab("Percent") +
        scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.7)) +
        geom_text(aes(x = DataSharing, label = percent(per, accuracy = 1)), vjust = -0.5,
                      position = position_dodge2(width = 0.9, preserve = "single"), 
                      colour = "black", size = 2.5) + 
        scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Sharing by gender

```{r sharing_data_gender_per2}

data %>% select(num_range("Q3_", 1:7), gender = Q21)                       %>%
        pivot_longer(cols = starts_with("Q3_"), 
                     names_to = NULL,
                     values_to = "DataSharing")                            %>%
        filter(DataSharing != 0)                                           %>%
        group_by(DataSharing)                                              %>%
        mutate(M = n())                                                    %>% 
        group_by(gender)                                                   %>% 
        mutate(N = n())                                                    %>%
        filter(!(gender %in% lowstatsgender))                              %>% 
        group_by(DataSharing, gender)                                      %>% 
        mutate(per = n()/N)                                                %>% 
        distinct(gender, DataSharing, per, M)                              %>% 
        ggplot(aes(x = reorder(DataSharing, -M), y= per,fill = gender)) +
        geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                 colour = "black") + 
        theme_bw() + 
        theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0), 
              legend.text=element_text(size = 6)) +
        xlab("Data sharing habits") + ylab("Percent") +
        scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.7)) +
        geom_text(aes(x = DataSharing, label = percent(per, accuracy = 1)), vjust = -0.5,
                      position = position_dodge2(width = 0.9, preserve = "single"), 
                      colour = "black", size = 2.5) + 
        scale_fill_brewer(palette = "Set2", name = "Gender")
```


### Other ways of sharing data

```{r other_sharing_data, results = 'asis'}

listOther("Q3_a")

```

## Q4 Software used in research

What software do you use in your research?

### Software used in research chart

```{r sw_used}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q4_",1:26))  %>% 
         pivot_longer(cols = num_range("Q4_",1:26),
                      names_to = NULL,
                      values_to = "software")                       %>%
         filter(software != 0)                                      %>%
         summarise(lab = paste0("Software used (N=", n_distinct(URN),")")) -> my

data %>% select(num_range("Q4_",1:26))                              %>%
         pivot_longer(cols = num_range("Q4_",1:26),
                      names_to = NULL,
                      values_to = "software")                       %>%
         filter(software != 0)                                      %>%
         group_by(software)                                         %>% 
         mutate(n = n())                                            %>%   
         ggplot(aes(x = reorder(software,-n), fill = n)) +
         geom_bar(colour = "black") +
         theme_bw() + ylim(0, 132) + scale_fill_distiller(palette = "Blues", direction = 1) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0)) +
         ylab("Numbers") + xlab(my$lab) +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(size = 12), legend.position = "none")
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q4_correlations}

data0 %>% select(num_range("Q4_",1:26)) -> q  
names(q) <- software

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.5*par("cex.lab"))

```

### Software used with responses segmented by career

```{r sw_used_career}

data %>% select(num_range("Q4_",1:26), career = Q20)                        %>%
         pivot_longer(cols = starts_with("Q4"),
                      names_to = NULL,
                      values_to = "software")                                %>%
         filter(software != 0)                                               %>%
         group_by(career, software)                                          %>% 
         mutate(n = n())                                                     %>%   
         ggplot(aes(x = reorder(software,-n), fill = career)) +
         geom_bar(colour = "black") +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0, size = 8),
               legend.text=element_text(size = 8)) +
         ylab("Numbers") + xlab("Software used") +
         geom_text(aes(x = software, label = ..count..),
                position = position_stack(vjust = 0.5), 
                stat = "count", colour = "black", size = 2) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Software used by career percent of software use

```{r sw_used_career_per1}

data %>% select(num_range("Q4_",1:26), career = Q20)                         %>%
         group_by(career)                                                    %>% 
         mutate(N = n())                                                     %>% 
         pivot_longer(cols = starts_with("Q4"), 
                      names_to = NULL,
                      values_to = "software")                                %>%
         filter(software != 0)                                               %>%
         group_by(software)                                                  %>% 
         mutate(M = n())                                                     %>% 
         group_by(software, career)                                          %>% 
         mutate(per = n()/N)                                                 %>% 
         distinct(software, career, per, N, M)                               %>% 
         ggplot(aes(x = reorder(software,-M), y = per, fill = career)) +
         geom_col(position = "fill", colour = "black") +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0, size = 8),
               legend.text=element_text(size = 8)) +
         ylab("Percent") + xlab("Software used") +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(x = software, y = per, label = percent(per, accuracy = 1)), 
                 position = position_fill(vjust = 0.5),
                 size = 2) +
         scale_fill_brewer(palette = "Set1", name = "Career stage") 
```

Missing out "Other" and "-".

```{r sw_used_career_per1b}

data %>% select(num_range("Q4_",1:26), career = Q20)                         %>%
         group_by(career)                                                    %>% 
         mutate(N = n())                                                     %>% 
         pivot_longer(cols = starts_with("Q4"), 
                      names_to = NULL,
                      values_to = "software")                                %>%
         filter(software != 0 & career != "Other" & career != "-")           %>%
         group_by(software)                                                  %>% 
         mutate(M = n())                                                     %>% 
         filter(M > 10)                                                      %>% 
         group_by(software, career)                                          %>% 
         mutate(per = n()/N)                                                 %>% 
         distinct(software, career, per, N, M)                               %>% 
         ggplot(aes(x = reorder(software,-M), y = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0, size = 8),
               legend.text=element_text(size = 6)) +
         ylab("Percent") + xlab("Software used") +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(x = software, y = per, label = percent(per, accuracy = 1)), 
                 position = position_dodge2(width = 0.9, preserve = "single"), vjust= -0.5,
                 size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage") 
```

```{r sw_used_career_per2}

data %>% select(num_range("Q4_",1:26), career = "Q20")                       %>%
         group_by(career)                                                    %>% 
         mutate(N = n())                                                     %>% 
         pivot_longer(cols = starts_with("Q4"), 
                      names_to = NULL,
                      values_to = "software")                                %>%
         group_by(software)                                                  %>% 
         mutate(M = n())                                                     %>% 
         filter(software != 0)                                               %>%
         group_by(software,career)                                           %>%
         mutate(per = n()/N)                                                 %>% 
         distinct(software, career, per, M)                                  %>% 
         ggplot(aes(x = reorder(software, -M), y = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0, size = 8),
               legend.text=element_text(size = 8)) +
         ylab("Percentage") + xlab("Software used") +
         scale_fill_brewer(palette = "Set1", name = "Career stage") 
```

Removing low stat components and only showing entries with more than 5 entries.

```{r sw_used_career_per3}

data %>% select(URN, num_range("Q4_",1:26), career = "Q20")                  %>%
         group_by(career)                                                    %>% 
         mutate(N = n())                                                     %>% 
         pivot_longer(cols = starts_with("Q4"), 
                      names_to = NULL,
                      values_to = "software")                                %>%
         distinct(URN, software, career, N)                                  %>% 
         filter(software != 0)                                               %>% 
         group_by(software)                                                  %>% 
         mutate(M = n())                                                     %>% 
         filter(!(career %in% c("-", "Other")))                              %>% 
         filter(M > 10)                                                      %>%
         group_by(software,career)                                           %>%
         mutate(per = n()/N)                                                 %>% 
         distinct(software, career, per, M)                                  %>% 
         ggplot(aes(x = reorder(software, -M), y = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0, size = 8),
               legend.text=element_text(size = 8)) +
         ylab("Percentage") + xlab("Software used") +
         scale_fill_brewer(palette = "Set1", name = "Career stage") 
```

### Software by gender

Removing low stat components and only showing entries with more than 20 entries.

```{r sw_used_gender_per}

data %>% select(num_range("Q4_",1:26), gender = Q21)                         %>%
         group_by(gender)                                                    %>% 
         mutate(N = n())                                                     %>%
         pivot_longer(cols = starts_with("Q4"), 
                      names_to = NULL,
                      values_to = "software")                                %>%
         filter(software != 0)                                               %>% 
         group_by(software)                                                  %>% 
         mutate(M = n())                                                     %>% 
         filter(!(gender %in% lowstatsgender))                               %>% 
         filter(M > 10)                                                      %>%
         group_by(software,gender)                                           %>%
         mutate(per = n()/N)                                                 %>% 
         distinct(software, gender, per, M)                                  %>% 
         ggplot(aes(x = reorder(software, -M), y = per, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.83)) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0, size = 8),
               legend.text=element_text(size = 8)) +
         geom_text(aes(label = percent(per, accuracy = 1)), position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         ylab("Percent") + xlab("Software used") + 
         scale_fill_brewer(palette = "Set2", name = "Gender") 
```

```{r sw_used_gender_career_per}

data %>% select(num_range("Q4_",1:26), career = Q20, gender = Q21)                         %>%
         filter(!(career %in% c("-","Other"))) %>% 
         group_by(gender)                                                    %>% 
         mutate(N = n())                                                     %>%
         pivot_longer(cols = starts_with("Q4"), 
                      names_to = NULL,
                      values_to = "software")                                %>%
         filter(software != 0)                                               %>% 
         group_by(software)                                                  %>% 
         mutate(M = n())                                                     %>% 
         filter(!(gender %in% lowstatsgender))                               %>% 
         filter(M > 10)                                                      %>%
         group_by(software,gender, career)                                   %>%
         mutate(per = n()/N)                                                 %>% 
         distinct(software, gender, per, M, career)                                  %>% 
         ggplot(aes(x = reorder(software, -M), y = per, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.35)) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0, size = 8),
               legend.text=element_text(size = 8)) +
         geom_text(aes(label = percent(per, accuracy = 1)), position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 2, vjust = -0.5) +
         ylab("Percent") + xlab("Software used") + 
         scale_fill_brewer(palette = "Set2", name = "Gender") + facet_wrap(~career)
```
### Software used by discipline

These diagrams are over counting

```{r software_discipline}

data %>% select(num_range("Q4_",1:26), num_range("Q19_", 1:22))              %>%
         pivot_longer(cols = starts_with("Q4"),
                      names_to = NULL,
                      values_to = "software")                                %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "discipline")                              %>%
         filter(software != 0 & discipline != 0)                             %>%
         group_by(software, discipline)                                      %>% 
         mutate(n = n())                                                     %>%   
         distinct(software, discipline, n)                                   %>% 
         ggplot(aes(x = software, y = discipline, size = n)) +
         geom_point(colour = "black", alpha = 0.25) +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0), 
               legend.text=element_text(size = 8)) +
         ylab("Discipline") + xlab("Software used") + labs(size = "Numbers")
```

```{r software_discipline2}

data %>% select(URN, num_range("Q4_",1:26), num_range("Q19_", 1:22))         %>%
         pivot_longer(cols = starts_with("Q4"),
                      names_to = NULL,
                      values_to = "software")                                %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "discipline")                              %>%
         filter(software != 0 & discipline != 0)                             %>%
         distinct(URN, software, discipline)                                 %>% 
         group_by(software, discipline)                                      %>% 
         mutate(n = n())                                                     %>%   
         distinct(software, discipline, n)                                   %>% 
         ggplot(aes(x = software, y = discipline, fill = n)) +
         geom_tile(colour = "black") + 
         scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
         theme_minimal() +
         theme(legend.text=element_text(size = 8)) +
         geom_text(aes(label = n), colour = "white", size = 3) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.15, hjust=0),
               legend.position = "None") +
         ylab("Discipline") + xlab("Software used") + labs(fill = "Numbers")
```

```{r software_discipline_test, results = 'asis'}

data %>% select(URN, num_range("Q4_",1:26))                 %>%
         pivot_longer(cols = starts_with("Q4"),
                      names_to = NULL,
                      values_to = "software")              %>% 
         filter(software != 0) %>%
         distinct(URN, software) %>% 
         # group_by(software) %>% 
         # mutate(n = n()) %>% 
         # distinct(software, n) %>% 
         # arrange(desc(n))
         left_join(
           data %>% select(URN, num_range("Q19_", 1:22) )          %>% 
                    pivot_longer(cols = num_range("Q19_", 1:22),
                                 names_to = NULL,
                                 values_to = "discipline")          %>%
                    filter(discipline != 0)                        %>%
                   distinct(URN,  discipline),
                   by = "URN"
         )                                                         %>% 
         distinct(URN, software, discipline)                       %>% 
         group_by(software, discipline)                            %>% 
         mutate(n = n())                                           %>%   
         distinct(software, discipline, n)                         %>%
         arrange(desc(n))                                          %>% 
         kbl(format="pipe", align = c("l","l", "r"), col.names = c("Software", "Discipline", "Count"))

         # group_by(software) %>% 
         # summarise(N = sum(n)) %>% 
         # arrange(desc(N))
```

### Other software used

```{r other_software_used_cleaned, results = 'asis'}

aa <- read_csv("../Data/q4a.csv", show_col_types = FALSE)

aa  %>%  select(URN, num_range("OtherSw_", 1:13))            %>% 
         pivot_longer(cols = num_range("OtherSw_", 1:13),
                         names_to = NULL,
                         values_to="othersw")                %>%
        filter(!is.na(othersw))                              %>% 
        group_by(othersw)                                    %>%
        tally()                                              %>% 
        arrange(desc(n))                                     %>% 
        kbl(format="pipe", align = c("l","r"), col.names = c("Other software used", "Numbers"))



```


```{r other_software_used, results = 'asis'}

listOther("Q4_a")

```


## Q5 Most important software

What software(s) is/are most important to your work?

### Most important software

This chart is derived from the processed data input by the
interviewees - an interviewee may have input more than one choice - each
of these is counted as an integral choice (could normalise so that if an
interviewee put in N choices each would contribute 1/N to the count).
Only values with more than 2 entries are shown.

```{r important_sw_bar}

# Calculate an x label with the folks that filled in this question.
important_software  %>% select(URN, starts_with("Q5"))  %>% 
                       pivot_longer(cols =  starts_with("Q5"),
                                    names_to = "name",
                                    values_to = "software")  %>%
                       filter(!is.na(software))              %>%
         summarise(lab = paste0("Most important software (N=", n_distinct(URN),")")) -> my


important_software %>% select(starts_with("Q5"))             %>%
                       pivot_longer(cols =  starts_with("Q5"),
                                    names_to = "name",
                                    values_to = "software")  %>%
                       filter(!is.na(software))              %>%
                       group_by(software)                    %>%
                       tally()                               %>%
                       filter(n > 2)                         %>%
                       ggplot(aes(x = reorder(software, -n), y = n, fill = n)) +
                       geom_col(colour = "black") + scale_fill_distiller(palette = "Blues", direction = 1) +
                       theme_bw() +
                       theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0)) +
                       geom_text(aes(x = software, label = n), vjust = -0.5, size = 3) +
                       ylab("Numbers") + xlab(my$lab) + ylim(0,57) +
                       theme(axis.text.x = element_text(size = 10), legend.position = "None")  

```

### Software used by career stage

```{r important_sw_bar_career}

bind_cols(data["Q20"], important_software)                        %>% 
                       select(starts_with("Q5"), career = "Q20")  %>%
                       pivot_longer(cols =  starts_with("Q5"),
                                    names_to = NULL,
                                    values_to = "software")       %>%
                       filter(!is.na(software))                   %>%
                       group_by(software)                         %>%
                       mutate(N = n())                            %>%
                       filter(N > 2)                              %>%
                       group_by(career, software)                 %>%
                       mutate(n = n())                            %>%
                       ggplot(aes(x = reorder(software, -N), fill = career)) +
                       geom_bar(colour = "black") + 
                       theme_bw() +
                       theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0)) +
                       geom_text(aes(x = software, label = n), 
                                 position = position_stack(vjust = 0.5), 
                                 stat = "count", size = 3) +
                       ylab("Numbers") + xlab("Most important software") +
                       scale_fill_brewer(palette = "Set1", name = "Career stage") +
                       theme(axis.text.x = element_text(size = 8),
                             legend.text=element_text(size = 8))  

```

### Software used by % career stage

Only show software that has more than 2 entries.

```{r important_sw_bar_career_per}

bind_cols(data["Q20"], important_software)                        %>% 
                       select(starts_with("Q5"), career = Q20)    %>%
                       group_by(career)                           %>% 
                       mutate(N = n())                            %>%
                       pivot_longer(cols =  starts_with("Q5"),
                                    names_to = NULL,
                                    values_to = "software")       %>%
                       filter(!is.na(software))                   %>%
                       group_by(software)                         %>% 
                       mutate(M = n())                            %>%
                       filter(M > 2)                              %>% 
                       group_by(career, software)                 %>%
                       mutate(n = n())                            %>%
                       mutate(per = n/N)                          %>% 
                       distinct(career, software, n, N, per)      %>% 
                       ggplot(aes(x = reorder(software, -n), y = per, fill = career)) +
                       geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                                colour = "black") + 
                       scale_y_continuous(labels = percent_format(accuracy = 1)) +
                       theme_bw() +
                       theme(axis.text.x = element_text(angle = -90, vjust = 0.5,
                                                        hjust=0)) +
                       geom_text(aes(x = software, y = per, 
                                     label = percent(per, accuracy = 1)), 
                                 position = position_dodge2(width = 0.9, preserve = "single"),
                                 size = 2.5) +
                       ylab("Percentage") + xlab("Most important software") +
                       scale_fill_brewer(palette = "Set1", name = "Career stage") +
                       theme(axis.text.x = element_text(size = 8),
                             legend.text=element_text(size = 8))  

```

Removing "Other" and "-".

```{r important_sw_bar_career_per2}

bind_cols(data["Q20"], important_software)                        %>% 
                       select(starts_with("Q5"), career = Q20)    %>%
                       group_by(career)                           %>% 
                       mutate(N = n())                            %>%
                       pivot_longer(cols =  starts_with("Q5"),
                                    names_to = NULL,
                                    values_to = "software")       %>%
                       filter(!is.na(software))                   %>%
                       group_by(software)                         %>%
                       mutate(M = n())                            %>% 
                       filter(career != "Other" & career != "-")  %>% 
                       filter(M > 5)                              %>% 
                       group_by(career, software)                 %>%
                       mutate(n = n())                            %>%
                       mutate(per = n/N)                          %>% 
                       distinct(career, software, n, N, per, M)   %>% 
                       ggplot(aes(x = reorder(software, -M), y = per, fill = career)) +
                       geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
                       scale_y_continuous(labels = percent_format(accuracy = 1)) +
                       theme_bw() +
                       theme(axis.text.x = element_text(angle = -90, vjust = 0.5,
                                                        hjust=0)) +
                       geom_text(aes(x = software, y = per, 
                                     label = percent(per, accuracy = 1)), vjust = -0.5,
                                 position = position_dodge2(width = 0.9, preserve = "single"),
                                 size = 3) +
                       ylab("Percentage") + xlab("Most important software") +
                       scale_fill_brewer(palette = "Set1", name = "Career stage") +
                       theme(axis.text.x = element_text(size = 8),
                             legend.text=element_text(size = 6))  

```
### Important software by gender

```{r important_sw_bar_gender_per2}

bind_cols(data["Q21"], important_software)                        %>% 
                       select(starts_with("Q5"), gender = Q21)    %>%
                       group_by(gender)                           %>% 
                       mutate(N = n())                            %>%
                       pivot_longer(cols =  starts_with("Q5"),
                                    names_to = NULL,
                                    values_to = "software")       %>%
                       filter(!is.na(software))                   %>%
                       group_by(software)                         %>%
                       mutate(M = n())                            %>% 
                       filter(!(gender %in% lowstatsgender))      %>% 
                       filter(M > 5)                              %>% 
                       group_by(gender, software)                 %>%
                       mutate(n = n())                            %>%
                       mutate(per = n/N)                          %>% 
                       distinct(gender, software, n, N, per, M)   %>% 
                       ggplot(aes(x = reorder(software, -M), y = per, fill = gender)) +
                       geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
                       scale_y_continuous(labels = percent_format(accuracy = 1)) +
                       theme_bw() +
                       theme(axis.text.x = element_text(angle = -90, vjust = 0.5,
                                                        hjust=0)) +
                       geom_text(aes(x = software, y = per, 
                                     label = percent(per, accuracy = 1)), vjust = -0.5,
                                 position = position_dodge2(width = 0.9, preserve = "single"),
                                 size = 3) +
                       ylab("Percentage") + xlab("Most important software") +
                       scale_fill_brewer(palette = "Set2", name = "Gender") +
                       theme(axis.text.x = element_text(size = 8),
                             legend.text=element_text(size = 6))  

```

### Most important software as a percentage at a given career stage

The percentages here are taken as a percentage of the responses from
each career stage. Only software that has been nominated more than five times
are shown otherwise the graph becomes very busy. Note that an individual may 
have suggested more than one piece of software - this has not been normalised.

```{r important_sw_bar_career_per3}

bind_cols(data["Q20"], important_software)                        %>% 
                       select(starts_with("Q5"), career = "Q20")  %>%
                       pivot_longer(cols =  starts_with("Q5"),
                                    names_to = NULL,
                                    values_to = "software")       %>%
                       filter(!is.na(software))                   %>% 
  
                       group_by(career)                           %>% 
                       mutate(N = n())                            %>%
                       group_by(software)                         %>% 
                       mutate(Ns = n())                           %>%  
                       filter(Ns > 5)                             %>%
                       group_by(career, software)                 %>%
                       mutate(n = n())                            %>%
                       mutate(per = n/N)                          %>% 
                       distinct(career, software, per, N)         %>% 
                       ggplot(aes(x = reorder(software, N), y = per, fill = career)) +
                       geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                                colour = "black") + 
                       theme_bw() +
                       scale_y_continuous(labels = percent_format(accuracy = 1)) +
                       theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0)) +
                       geom_text(aes(x = software, label = percent(per, accuracy = 1)), 
                                 position = position_dodge2(width = 0.9, preserve = "single"), 
                                 vjust = -0.5,
                                 size = 2) +
                       ylab("percentage") + xlab("Most important software") +
                       scale_fill_brewer(palette = "Set1", name = "Career stage") +
                       theme(axis.text.x = element_text(size = 8), 
                             legend.text=element_text(size = 8))  


```

### List of choices

```{r important_software, results = 'asis'}

listOther("Q5")

```

## Q6 Use of open source software

Do you use open source software?

### OS responses

```{r use_os}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, Q6)  %>% 
         summarise(lab = paste0("Use of Open Source (N=", n_distinct(URN),")")) -> my

data %>% select(Q6)       %>%
         group_by(Q6)     %>% 
         mutate(n = n())  %>% 
         ggplot(aes(x = reorder(Q6, -n), fill = n)) + 
         geom_bar(colour = "black") + 
         theme_bw() +
         xlab(my$lab) + scale_fill_distiller(palette = "Blues", direction = 1) +
         ylab("Numbers") + ylim(0, 110) + theme(legend.position = "None") +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) 

```

### OS by career stage

```{r use_os_career}

data %>% select(Q6, career = "Q20")       %>%
         group_by(Q6)                     %>% 
         mutate(N = n())                  %>% 
         group_by(Q6, career)             %>% 
         mutate(n = n())                  %>% 
         ggplot(aes(x = reorder(Q6, -N), fill = career)) + 
         geom_bar(colour = "black") + 
         theme_bw() +
         xlab("Use of Open Source") + 
         ylab("Numbers") +
         geom_text(aes(x = Q6, label = n), position = position_stack(vjust = 0.5), 
                                 stat = "count", size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage") +
         theme(axis.text.x = element_text(size = 8),
               legend.text=element_text(size = 6))  

```

### OS by % career stage

```{r use_os_caree_per}

data %>% select(os = Q6, career = Q20)             %>%
         group_by(career)                          %>% 
         filter(career != "Other" & career != "-") %>% 
         mutate(N = n())                           %>% 
         group_by(os, career)                      %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>%
         distinct(n, N, os, per, career)           %>% 
         ggplot(aes(x = reorder(os, -n), y = n/N, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         xlab("Use of Open Source") + scale_y_continuous(labels = percent_format(accuracy = 1)) +
         ylab("Percent") +
         geom_text(aes(label = paste0(n," (", per,")")),
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage") +
         theme(axis.text.x = element_text(size = 8), 
                             legend.text=element_text(size = 6))  

```
### OS by gender

```{r use_os_gender}

data %>% select(Q6, gender = Q21)         %>%
         group_by(Q6)                     %>% 
         mutate(N = n())                  %>% 
         group_by(Q6, gender)             %>% 
         mutate(n = n())                  %>% 
         ggplot(aes(x = reorder(Q6, -N), fill = gender)) + 
         geom_bar(colour = "black") + 
         theme_bw() +
         xlab("Use of Open Source") + 
         ylab("Numbers") +
         geom_text(aes(x = Q6, label = n), position = position_stack(vjust = 0.5), 
                                 stat = "count", size = 3) +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         theme(axis.text.x = element_text(size = 8),
               legend.text=element_text(size = 6))  

```

### OS by % gender

```{r use_os_gender_per}

data %>% select(os = Q6, gender = Q21)             %>%
         group_by(gender)                          %>% 
         mutate(N = n())                           %>% 
         group_by(os, gender)                      %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>%
         distinct(n, N, os, per, gender)           %>% 
         ggplot(aes(x = os, y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         xlab("Use of Open Source") + scale_y_continuous(labels = percent_format(accuracy = 1)) +
         ylab("Percent") +
         geom_text(aes(label = paste0(n," (", per,")")),
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 2) +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         theme(axis.text.x = element_text(size = 8), 
                             legend.text=element_text(size = 6))  

```

```{r use_os_gender_per2}

data %>% select(os = Q6, gender = Q21)             %>%
         group_by(os)                              %>% 
         mutate(M = n())                           %>% 
         filter(!(gender %in% lowstatsgender))     %>% 
         group_by(gender)                          %>% 
         mutate(N = n())                           %>% 
         group_by(os, gender)                      %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>%
         distinct(n, N, os, per, gender, M)        %>% 
         ggplot(aes(x = reorder(os, -M), y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         xlab("Use of Open Source") + scale_y_continuous(labels = percent_format(accuracy = 1)) +
         ylab("Percent") +
         geom_text(aes(label = paste0(n," (", per,")")),
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 3) +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         theme(axis.text.x = element_text(size = 8), 
                             legend.text=element_text(size = 6))  

```
 Split by gender and career stage.
 
```{r use_os_gender_per2_career}

data %>% select(os = Q6, career = Q20, gender = Q21)    %>%
         filter(!(career %in% c("Other", "-")))      %>% 
         group_by(os)                              %>% 
         mutate(M = n())                           %>% 
         filter(!(gender %in% lowstatsgender))     %>% 
         group_by(gender)                          %>% 
         mutate(N = n())                           %>% 
         group_by(os, gender,career)                      %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>%
         distinct(n, N, os, per, gender, career, M)        %>% 
         ggplot(aes(x = reorder(os, -M), y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         xlab("Use of Open Source") + scale_y_continuous(labels = percent_format(accuracy = 1)) +
         ylab("Percent") +
         geom_text(aes(label = paste0(n," (", per,")")),
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 3) +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         theme(axis.text.x = element_text(size = 8), 
                             legend.text=element_text(size = 6))  + 
         facet_wrap(~career)

```

## Q6a Reason for using open source

If you answered yes to the previous question, what are your main reasons
for using open source software?

### Using OS

```{r reason4os}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, starts_with("Q6_a"))         %>% 
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")        %>%
         filter(UseOS != 0)                       %>%             
         summarise(lab = paste0("Reason for using OS (N=", n_distinct(URN),")")) -> my

data %>% select(starts_with("Q6_a"))              %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")        %>%
         filter(UseOS != 0)                       %>%
         group_by(UseOS)                          %>% 
         mutate(n = n())                          %>% 
         ungroup()                                %>% 
         distinct(UseOS, n)                       %>% 
         ggplot(aes(x = reorder(UseOS, -n), y = n, fill = n)) + 
         geom_col(colour = "black") + xlab(unique(my$lab)) +
         theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +         
         geom_text(aes(label = n), vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 10), legend.position = "None") +
         ylab("Numbers")
```
 
 
### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q6a_correlations}

data0 %>% select(starts_with("Q6_a")) -> q  
names(q) <- os_reasons

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.75*par("cex.lab"))

```
### Using OS by career stage

```{r reason4os_career}

data %>% select(starts_with("Q6_a"), career = Q20)   %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")           %>%
         filter(UseOS != 0)                          %>%
         group_by(UseOS, career)                     %>% 
         mutate(n = n())                             %>% 
         ggplot(aes(x = reorder(UseOS, -n), fill = career)) + 
         geom_bar(colour = "black") + 
         theme_bw() +
         geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for using Open Source") + ylab("Numbers") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Using OS by % career stage pop 

```{r reason4os_career_per}

data %>% select(starts_with("Q6_a"), career = Q20)   %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")           %>%
         filter(UseOS != 0)                          %>%
         group_by(career)                            %>% 
         mutate(N = n())                             %>% 
         group_by(UseOS, career)                     %>% 
         mutate(per = n()/N)                         %>%
         distinct(UseOS, career, per)                %>% 
         ggplot(aes(x = UseOS, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for using Open Source") + ylab("Numbers") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```
Leaving out "Other" and "-"

```{r reason4os_career_per2}

data %>% select(starts_with("Q6_a"), career = Q20)   %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")           %>%
         filter(UseOS != 0)                          %>%
         group_by(UseOS)                             %>% 
         mutate(M = n())                            %>% 
         group_by(career)                            %>% 
         filter(career != "Other" & career != "-")   %>% 
         mutate(N = n())                             %>% 
         group_by(UseOS, career)                     %>% 
         mutate(per = n()/N)                         %>%
         distinct(UseOS, career, per, M)             %>% 
         ggplot(aes(x = reorder(UseOS, -M), y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for using Open Source") + ylab("Percentage") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```
### Using OS by gender 

```{r reason4os_gender}

data %>% select(starts_with("Q6_a"), gender = Q21)   %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")           %>%
         filter(UseOS != 0)                          %>%
         group_by(UseOS, gender)                     %>% 
         mutate(n = n())                             %>% 
         ggplot(aes(x = reorder(UseOS, -n), fill = gender)) + 
         geom_bar(colour = "black") + 
         theme_bw() +
         geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for using Open Source") + ylab("Numbers") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Using OS by % gender pop 

```{r reason4os_gender_per}

data %>% select(starts_with("Q6_a"), gender = Q21)   %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")           %>%
         filter(UseOS != 0)                          %>%
         group_by(gender)                            %>% 
         mutate(N = n())                             %>% 
         group_by(UseOS, gender)                     %>% 
         mutate(per = n()/N)                         %>%
         distinct(UseOS, gender, per)                %>% 
         ggplot(aes(x = UseOS, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for using Open Source") + ylab("Percentage") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r reason4os_gender_per2}

data %>% select(starts_with("Q6_a"), gender = Q21)   %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")           %>%
         filter(UseOS != 0)                          %>%
         group_by(UseOS)                             %>% 
         mutate(M = n())                             %>% 
         filter(!(gender %in% lowstatsgender))       %>% 
         group_by(gender)                            %>% 
         mutate(N = n())                             %>% 
         group_by(UseOS, gender)                     %>% 
         mutate(per = n()/N)                         %>%
         distinct(UseOS, gender, per, M)             %>% 
         ggplot(aes(x = reorder(UseOS, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for using Open Source") + ylab("Percentage") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r reason4os_gender_car_per2}

data %>% select(starts_with("Q6_a"), career = Q20, gender = Q21)   %>%
         filter(!(career %in% c("-","Other"))) %>% 
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "UseOS")           %>%
         filter(UseOS != 0)                          %>%
         group_by(UseOS)                             %>% 
         mutate(M = n())                             %>% 
         filter(!(gender %in% lowstatsgender))       %>% 
         group_by(gender)                            %>% 
         mutate(N = n())                             %>% 
         group_by(UseOS, gender, career)                     %>% 
         mutate(per = n()/N)                         %>%
         distinct(UseOS, gender, per, M, career)             %>% 
         ggplot(aes(x = reorder(UseOS, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0,.12)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for using Open Source") + ylab("Percentage") +
         scale_fill_brewer(palette = "Set2", name = "Gender") + facet_wrap(~career)
```

### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices. Only counting values that have a count greater than 1.

```{r reason4os_choices}

data %>% select(id = URN, starts_with("Q6_a"))                         %>%
         pivot_longer(cols = starts_with("Q6_a"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         filter(n > 1)                                                 %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```


## Q6b Reasons for not using OS

If you answered no to the previous question, what are your main reasons
for not using open source software?

### Responses

```{r reasons4NotOS}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, starts_with("Q6_b"))  %>% 
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")  %>%
         filter(UseOS != 0)                 %>%
         summarise(lab = paste0("Reasons for not using Open Source (N=", n_distinct(URN),")")) -> my

data %>% select(starts_with("Q6_b"))        %>%
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")  %>%
         filter(UseOS != 0)                 %>%
         group_by(UseOS)                    %>% 
         mutate(n = n())                    %>% 
         ggplot(aes(x = reorder(UseOS, -n), fill = n)) + 
         geom_bar(colour = "black") + 
         theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 10), legend.position = "None") +
         xlab(my$lab) + ylab("Numbers")
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q6b_correlations}

data0 %>% select(starts_with("Q6_b")) -> q  
names(q) <- no_os

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.75*par("cex.lab"))

# http://www.sthda.com/english/wiki/visualize-correlation-matrix-using-correlogram
# corrplot(cor(q), method="circle")
# corrplot(cor(q), method="pie")
# corrplot(cor(q), method="color")
# corrplot(cor(q), method="number")
```

### Responses by career stage

```{r reasons4NotOS_career}

data %>% select(starts_with("Q6_b"), career = Q20)        %>%
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")                %>%
         filter(UseOS != 0)                               %>%
         group_by(UseOS, career)                          %>% 
         mutate(n = n())                                  %>% 
         ggplot(aes(x = reorder(UseOS, -n), fill = career)) + 
         geom_bar(colour = "black") + 
         theme_bw() +
         geom_text(aes(label = ..count..), stat = "count", 
                   position = position_stack(0.5), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for not using Open Source") + ylab("Numbers") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Responses by % career stage

```{r reasons4NotOS_career_per}

data %>% select(starts_with("Q6_b"), career = Q20)  %>%
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")         %>%
         filter(UseOS != 0)                        %>%
         group_by(career)                          %>% 
         mutate(N = n())                           %>% 
         group_by(UseOS, career)                   %>% 
         mutate(per = n()/N)                       %>% 
         distinct(UseOS, career, per)              %>% 
         ggplot(aes(x = UseOS, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for not using Open Source") + ylab("Percent") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Without "Other" and "-"

```{r reasons4NotOS_career_per2}

data %>% select(starts_with("Q6_b"), career = Q20)  %>%
         group_by(career)                           %>% 
         mutate(N = n())                            %>% 
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")          %>%
         filter(UseOS != 0)                         %>%
         group_by(UseOS)                            %>% 
         mutate(M = n())                            %>% 
         filter(career != "Other" & career != "-")  %>% 
         group_by(UseOS, career)                    %>% 
         mutate(per = n()/N)                        %>% 
         distinct(UseOS, career, per, M)            %>% 
         ggplot(aes(x = reorder(UseOS, -M), y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for not using Open Source") + ylab("Percent") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```
### Responses by gender

```{r reasons4NotOS_gender}

data %>% select(starts_with("Q6_b"), gender = Q21)        %>%
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")                %>%
         filter(UseOS != 0)                               %>%
         group_by(UseOS, gender)                          %>% 
         mutate(n = n())                                  %>% 
         ggplot(aes(x = reorder(UseOS, -n), fill = gender)) + 
         geom_bar(colour = "black") + 
         theme_bw() +
         geom_text(aes(label = ..count..), stat = "count", 
                   position = position_stack(0.5), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for not using Open Source") + ylab("Numbers") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Responses by % Gender

```{r reasons4NotOS_gender_per}

data %>% select(starts_with("Q6_b"), gender = Q21)  %>%
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")         %>%
         filter(UseOS != 0)                        %>%
         group_by(UseOS)                           %>% 
         mutate(M = n())                           %>% 
         group_by(gender)                          %>% 
         mutate(N = n())                           %>% 
         group_by(UseOS, gender)                   %>% 
         mutate(per = n()/N)                       %>% 
         distinct(UseOS, gender, per, M)           %>% 
         ggplot(aes(x = reorder(UseOS, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for not using Open Source") + ylab("Percent") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r reasons4NotOS_gender_per2}

data %>% select(starts_with("Q6_b"), gender = Q21) %>%
         filter(!(gender %in% lowstatsgender))     %>% 
         group_by(gender)                          %>% 
         mutate(N = n())                           %>% 
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "UseOS")         %>%
         filter(UseOS != 0)                        %>%
         group_by(UseOS)                           %>% 
         mutate(M = n())                           %>% 
         group_by(UseOS, gender)                   %>% 
         mutate(per = n()/N)                       %>% 
         distinct(UseOS, gender, per, M)           %>% 
         ggplot(aes(x = reorder(UseOS, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") + 
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("Reasons for not using Open Source") + ylab("Percent") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices.

```{r reasons4NotOS_choices}

data %>% select(id = URN, starts_with("Q6_b"))                         %>%
         pivot_longer(cols = starts_with("Q6_b"),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         #filter(n > 1)                                                %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```


## Q7 How software is being maintained

How is the software you use currently being supported and maintained?

### How software is maintained

```{r sw_maintenace}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q7_", 1:7))  %>% 
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         summarise(lab = paste0("How Software is being maintained (N=", n_distinct(URN),")")) -> my

data %>% select(num_range("Q7_", 1:7))              %>%
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         group_by(swmaint)                          %>% 
         mutate(n = n())                            %>% 
         ggplot(aes(x = reorder(swmaint,-n), fill = n)) + 
         geom_bar(colour = "black") +
         theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 12), legend.position = "None") +
         xlab(my$lab) + ylab("Numbers") +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3)
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q7_correlations}

data0 %>% select(num_range("Q7_", 1:7)) -> q  
names(q) <- swmaintained

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.75*par("cex.lab"))

```

### Software maintainance by career

```{r sw_maintenace_career}

data %>% select(num_range("Q7_", 1:7), career = Q20)  %>%
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         group_by(swmaint, career)                  %>% 
         mutate(n = n())                            %>% 
         ggplot(aes(x = reorder(swmaint,-n), fill = career)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("How Software is maintained") + ylab("Numbers") +
         geom_text(aes(label = ..count..), 
                   position = position_stack(0.5), stat = "count", size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")

```

### Software maintainance by % career

```{r sw_maintenace_career_per}

data %>% select(num_range("Q7_", 1:7), career = Q20) %>%
         group_by(career)                           %>% 
         mutate(N = n())                            %>% 
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         group_by(swmaint)                          %>% 
         mutate(M = n())                            %>% 
         filter(career != "Other" & career != "-")  %>% 
         group_by(swmaint, career)                  %>% 
         mutate(n = n())                            %>% 
         mutate(per = percent(n/N, accuracy = 1))   %>% 
         distinct(swmaint, career, per, n, N, M)    %>% 
         ggplot(aes(x = reorder(swmaint,-M), y = n/N, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() + 
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("How Software is maintained") + ylab("Percent") +
         geom_text(aes(label = per), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")

```

### Software maintainance by gender

```{r sw_maintenace_gender}

data %>% select(num_range("Q7_", 1:7), gender = Q21)  %>%
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         group_by(swmaint, gender)                  %>% 
         mutate(n = n())                            %>% 
         ggplot(aes(x = reorder(swmaint,-n), fill = gender)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("How Software is maintained") + ylab("Numbers") +
         geom_text(aes(label = ..count..), 
                   position = position_stack(0.5), stat = "count", size = 3) +
         scale_fill_brewer(palette = "Set2", name = "Gender")

```

### Software maintainance by % gender

```{r sw_maintenace_gender_per}

data %>% select(num_range("Q7_", 1:7), gender = Q21) %>%
         group_by(gender)                            %>% 
         mutate(N = n())                             %>% 
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         group_by(swmaint)                          %>% 
         mutate(M = n())                            %>% 
         filter(gender != "Other" & gender != "-")  %>% 
         group_by(swmaint, gender)                  %>% 
         mutate(n = n())                            %>% 
         mutate(per = percent(n/N, accuracy = 1))   %>% 
         distinct(swmaint, gender, per, n, N, M)    %>% 
         ggplot(aes(x = reorder(swmaint,-M), y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() + 
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("How Software is maintained") + ylab("Percent") +
         geom_text(aes(label = per), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         scale_fill_brewer(palette = "Set2", name = "Gender")

```

```{r sw_maintenace_gender_per2}

data %>% select(num_range("Q7_", 1:7), gender = Q21) %>%
         filter(!(gender %in% lowstatsgender))       %>% 
         group_by(gender)                            %>% 
         mutate(N = n())                             %>% 
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         group_by(swmaint)                          %>% 
         mutate(M = n())                            %>% 
         filter(gender != "Other" & gender != "-")  %>% 
         group_by(swmaint, gender)                  %>% 
         mutate(n = n())                            %>% 
         mutate(per = percent(n/N, accuracy = 1))   %>% 
         distinct(swmaint, gender, per, n, N, M)    %>% 
         ggplot(aes(x = reorder(swmaint,-M), y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() + 
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("How Software is maintained") + ylab("Percent") +
         geom_text(aes(label = per), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         scale_fill_brewer(palette = "Set2", name = "Gender")

```

```{r sw_maintenace_gender_per2_career}

data %>% select(num_range("Q7_", 1:7), career = Q20, gender = Q21) %>%
         filter(!(career %in% c("-", "Other")))                    %>% 
         filter(!(gender %in% lowstatsgender))                     %>% 
         group_by(gender)                                          %>% 
         mutate(N = n())                                           %>% 
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")                       %>%
         filter(swmaint != 0)                                      %>%
         group_by(swmaint)                                         %>% 
         mutate(M = n())                                           %>% 
         filter(gender != "Other" & gender != "-")                 %>% 
         group_by(swmaint, gender, career)                         %>% 
         mutate(n = n())                                           %>% 
         mutate(per = percent(n/N, accuracy = 1))                  %>% 
         distinct(swmaint, gender, career, per, n, N, M)           %>% 
         ggplot(aes(x = reorder(swmaint,-M), y = n/N, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() + 
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.29)) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         xlab("How Software is maintained") + ylab("Percent") +
         geom_text(aes(label = per), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 2, vjust = -0.5) + 
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         facet_wrap(~ career)

```
### Software maintenance by discipline


```{r swmaint_dist_test}

data %>% select(URN, num_range("Q7_", 1:7), num_range("Q19_", 1:22))    %>%
         pivot_longer(cols = starts_with("Q19"),
                      names_to = NULL,
                      values_to ="discipline")                           %>%
         filter(discipline != 0)                                         %>%
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")                             %>%
         filter(swmaint != 0)                                            %>%
         distinct(URN, swmaint, discipline)                              %>% 
         mutate(N = n())                                                 %>% 
         group_by(discipline, swmaint)                                   %>%
         mutate(n = n())                                                 %>% 
         distinct(discipline, swmaint, n, N)                             %>% 
         group_by(swmaint)                                               %>% 
         summarise(Tot = sum(n))                                         %>% 
         arrange(desc(Tot))
```

```{r swmaint_dist_per_tile}

data %>% select(num_range("Q7_", 1:7), num_range("Q19_", 1:22))          %>%
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "swmaint")        %>%
         filter(swmaint != 0)                       %>%
         pivot_longer(cols = starts_with("Q19"),
                      names_to = NULL,
                      values_to ="discipline")                           %>%
         filter(discipline != 0)                                         %>%
         mutate(N = n())                                                 %>% 
         group_by(discipline, swmaint)                                   %>%
         mutate(n = n())                                                 %>%
         mutate(per = percent(n/N, accuracy = 1))                        %>% 
         distinct(discipline, swmaint, n, N, per)                        %>% 
         ggplot(aes(x = discipline, y = swmaint)) +
         theme_bw() +
         geom_tile(aes(fill = n)) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0),
               axis.text.y = element_text(size = 8), legend.position = "None") +
         geom_text(aes(label = n), size = 3, colour = "white") +
         ylab("How Software is supported/maintained") + xlab("Discipline") +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")
```

### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices. Only showing combinations that have a count greater
than 1.

```{r swMaintained_choices}

data %>% select(id = URN, num_range("Q7_", 1:7))                       %>%
         pivot_longer(cols = num_range("Q7_", 1:7),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         filter(n  > 1)                                                %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```


### Other maintenance mechanisms

```{r other_maintenace, results = 'asis'}

listOther("Q7_a")

```

## Q8 Software workflows

Do you use different pieces of software in combination to achieve a
specific goal or purpose? For instance, you could use audio software to
record interviews, transcription software to transcribe the interviews,
and qualitative coding software to bring documents, transcripts and
photographs together for further analysis. If yes, please specify.

### List processed data

```{r sw_wf1, results = 'asis'}

listOther("Workflow")

```


### List original inputs

```{r sw_wf2, results = 'asis'}

listOther("Q8")

```

## Q9 Do you develop software

Do you develop or extend software yourself? (As described above,
software includes scripts, applications, tools, codes and formulae in
spreadsheets)

### Responses

```{r develop_sw}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, Q9)  %>% 
         summarise(lab = paste0("Do you develop software? (N=", n_distinct(URN),")")) -> my

data %>% select(Q9)                              %>%
         mutate(Q9 = ifelse(!is.na(Q9), Q9, "-"))  %>% 
         mutate(N = n())                           %>% 
         group_by(Q9)                              %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>%
         distinct(Q9, N, n, per)                   %>% 
         ggplot(aes(x = reorder(Q9, -n), y = n, fill = n)) + 
         geom_col(colour = "black") +
         theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
         xlab(my$lab) + ylab("Numbers") + theme(legend.position = "None") +
         geom_text(aes(label = paste0(n," (", per,")")), vjust = -0.5, size = 3)

```

### Responses by career stage

```{r develop_sw_career}
data %>% select("Q9", career = Q20)    %>%
         group_by(Q9, career)          %>% 
         mutate(n = n())               %>% 
         ggplot(aes(x = reorder(Q9, -n), fill = career)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Do you develop software?") + ylab("Numbers") +
         geom_text(aes(label = ..count..), stat = "count", 
                   position = position_stack(0.5), size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```
### Responses by % career stage

```{r develop_sw_career_per}
data %>% select(Q9, career = Q20)      %>%
         group_by(career)              %>% 
         mutate(N = n())               %>% 
         group_by(Q9, career)          %>% 
         mutate(per = n()/N)           %>%
         distinct(Q9, career, per)     %>% 
         ggplot(aes(x = Q9, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Do you develop software?") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)),
                   position = position_dodge2(width = 0.9, preserve = "single"),  
                   vjust = -0.5, size = 2) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing "Other" and "-".

```{r develop_sw_career_per2}

data %>% select(Q9, career = Q20)                  %>%
         mutate(Q9 = ifelse(!is.na(Q9), Q9, "-"))  %>% 
         group_by(Q9)                              %>% 
         mutate(M = n())                           %>% 
         group_by(career)                          %>% 
         filter(career != "Other" &
                career != "-")                     %>% 
         mutate(N = n())                           %>% 
         group_by(Q9, career)                      %>% 
         mutate(per = n()/N)                       %>%
         distinct(Q9, career, per, M)              %>% 
         ggplot(aes(x = reorder(Q9, -M), y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Do you develop software?") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)),
                   position = position_dodge2(width = 0.9, preserve = "single"),  
                   vjust = -0.5, size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Responses by % gender 

```{r develop_sw_gender_per}

data %>% select(Q9, gender = Q21)    %>%
         mutate(Q9 = ifelse(!is.na(Q9), Q9, "-"))  %>% 
         group_by(gender)              %>% 
         mutate(N = n())               %>% 
         group_by(Q9, gender)          %>% 
         mutate(per = n()/N)           %>%
         distinct(Q9, gender, per)     %>% 
         ggplot(aes(x = Q9, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Do you develop software?") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)),
                   position = position_dodge2(width = 0.9, preserve = "single"),  
                   vjust = -0.5, size = 2) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r develop_sw_gender_per2}

data %>% select(Q9, gender = Q21)                  %>%
         group_by(Q9)                              %>%
         mutate(M = n())                           %>% 
         mutate(Q9 = ifelse(!is.na(Q9), Q9, "-"))  %>% 
         filter(!(gender %in% lowstatsgender))     %>% 
         group_by(gender)                          %>% 
         mutate(N = n())                           %>% 
         group_by(Q9, gender)                      %>% 
         mutate(per = n()/N)                       %>%
         distinct(Q9, gender, per, M)              %>% 
         ggplot(aes(x = reorder(Q9, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Do you develop software?") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)),
                   position = position_dodge2(width = 0.9, preserve = "single"),  
                   vjust = -0.5, size = 3) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Develop software by discipline

```{r swdev_dist_test}

data %>% select(Q9, num_range("Q19_", 1:22))                             %>%
         mutate(Q9 = ifelse(!is.na(Q9), Q9, "-"))                        %>% 
         pivot_longer(cols = starts_with("Q19"),
                      names_to = NULL,
                      values_to ="discipline")                           %>%
         filter(discipline != 0)                                         %>%
         group_by(discipline, Q9)                                        %>%
         mutate(n = n())                                                 %>%
         distinct(Q9, discipline, n)                                     %>% 
         group_by(Q9)                                                    %>% 
         summarise(Tot = sum(n))                                         %>% 
         arrange(desc(Tot))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Answer type", "Numbers"))

```

```{r swdev_dist_per_tile}

data %>% select(Q9, num_range("Q19_", 1:22))                             %>%
         mutate(Q9 = ifelse(!is.na(Q9), Q9, "-"))                        %>% 
         pivot_longer(cols = starts_with("Q19"),
                      names_to = NULL,
                      values_to ="discipline")                           %>%
         filter(discipline != 0)                                         %>%
         group_by(discipline, Q9)                                        %>%
         mutate(n = n())                                                 %>%
         mutate(per = percent(n/N, accuracy = 1))                        %>% 
         ggplot(aes(x = discipline, y = Q9)) +
         theme_bw() +
         geom_tile(aes(fill = n)) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0),
               axis.text.y = element_text(size = 8), legend.position = "None") +
         geom_text(aes(label = n), size = 3, colour = "white") +
         ylab("Do you develop software?") + xlab("Discipline") +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")
```
### How you extend software

If you answered yes to the above, could you briefly describe what
software(s) you write or extend?

```{r extending_sw, results='asis'}

listOther("Q9_a")

```

## Q10 Extending software

If you write or extend software (including scripts, applications, tools,
codes and formulae in spreadsheets), do you (check all that apply)

### Extending software

```{r extending}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q10_", 1:7))  %>% 
         pivot_longer(cols = num_range("Q10_", 1:7),
                      names_to = NULL,
                      values_to = "swuse")              %>%
         filter(swuse != 0)                             %>%
         summarise(lab = paste0("Who do you share your software with? (N=", n_distinct(URN),")")) -> my

data %>% select(num_range("Q10_", 1:7))                 %>%
         pivot_longer(cols = num_range("Q10_", 1:7),
                      names_to = NULL,
                      values_to = "swuse")              %>%
         filter(swuse != 0)                             %>%
         group_by(swuse)                                %>%
         mutate(n = n())                                %>% 
         ggplot(aes(x = reorder(swuse, -n), fill = n)) + 
         geom_bar(colour = "black") + scale_fill_distiller(palette = "Blues", direction = 1) +
         theme_bw() +
         xlab(my$lab) + ylab("Numbers") +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0), legend.position = "None")
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q10_correlations}

data0 %>% select(num_range("Q10_", 1:7)) -> q  
names(q) <- swuse

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.5*par("cex.lab"))

```

### Extending software by career

```{r extending_career}

data %>% select(num_range("Q10_", 1:7), career = Q20)   %>%
         pivot_longer(cols = num_range("Q10_", 1:7),
                      names_to = NULL,
                      values_to = "swuse")              %>%
         filter(swuse != 0)                             %>%
         group_by(swuse, career)                        %>%
         mutate(n = n())                                %>% 
         ggplot(aes(x = reorder(swuse, -n), fill = career)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Who do you share your software with?") + ylab("Numbers") +
         geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Extending software by % career stage

```{r extending_career_per}

data %>% select(num_range("Q10_", 1:7), career = Q20)   %>%
         pivot_longer(cols = num_range("Q10_", 1:7),
                      names_to = NULL,
                      values_to = "swuse")              %>%
         filter(swuse != 0)                             %>%
         group_by(career)                               %>%
         mutate(N = n())                                %>% 
         group_by(swuse, career)                        %>%
         mutate(per = n()/N)                            %>% 
         distinct(swuse, career, per)                   %>% 
         ggplot(aes(x = swuse, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Who do you share your software with?") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy=1)), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"),  size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Extending software by gender

```{r extending_gender}

data %>% select(num_range("Q10_", 1:7), gender = Q21)   %>%
         pivot_longer(cols = num_range("Q10_", 1:7),
                      names_to = NULL,
                      values_to = "swuse")              %>%
         filter(swuse != 0)                             %>%
         group_by(swuse, gender)                        %>%
         mutate(n = n())                                %>% 
         ggplot(aes(x = reorder(swuse, -n), fill = gender)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Who do you share your software with?") + ylab("Numbers") +
         geom_text(aes(label = ..count..), stat = "count", 
                   position = position_stack(0.5), size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Extending software by % gender

```{r extending_gender_per}

data %>% select(num_range("Q10_", 1:7), gender = Q21)   %>%
         pivot_longer(cols = num_range("Q10_", 1:7),
                      names_to = NULL,
                      values_to = "swuse")              %>%
         filter(swuse != 0)                             %>%
         group_by(gender)                               %>%
         mutate(N = n())                                %>% 
         group_by(swuse, gender)                        %>%
         mutate(per = n()/N)                            %>% 
         distinct(swuse, gender, per)                   %>% 
         ggplot(aes(x = swuse, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Who do you share your software with?") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy=1)), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"),  size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices. Only showing combinations that have a count greater
than 1.

```{r extendingSW_choices}

data %>% select(id = URN, num_range("Q10_", 1:7))                     %>%
         pivot_longer(cols = num_range("Q10_", 1:7),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         filter(n  > 1)                                                %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```

### Other extending mechanisms

```{r other_extending, results = 'asis'}

listOther("Q10_a")

```

## Q11 Acquiring skills

How did you acquire the skills necessary to utilise software in your
research? (Please check all that apply.)

### How skills are acquired

```{r acquiring_skills}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q11_", 1:12))  %>% 
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         summarise(lab = paste0("Where skills are acquired (N=", n_distinct(URN),")")) -> my

data %>% select(num_range("Q11_", 1:12))                 %>%
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         group_by(skills)                                %>% 
         mutate(n = n())                                 %>% 
         ggplot(aes(x = reorder(skills, -n), fill = n)) + 
         geom_bar(colour = "black") +
         theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
         xlab(my$lab) + ylab("Numbers") +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 12), legend.position = "None")
```

```{r acquiring_skills_per}
data %>% select(num_range("Q11_", 1:12))                 %>%
         mutate(N = n())                                 %>% 
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         group_by(skills)                                %>% 
         mutate(n = n())                                 %>% 
         mutate(per = percent(n/N, accuracy = 1))        %>% 
         ggplot(aes(x = reorder(skills, -n), fill = n)) + 
         geom_bar(colour = "black") +
         theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
         xlab("Where skills are acquired") + ylab("Numbers") + ylim(0, 129) +
         geom_text(aes(y = n, label = paste0(n, " (", per,")")), vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 12), legend.position = "None")
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q11_correlations}

data0 %>% select(num_range("Q11_", 1:12)) -> q  
names(q) <- skills

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.5*par("cex.lab"))

```

### Skills acquisition by career stage

```{r acquiring_skills_career}
data %>% select(num_range("Q11_", 1:12), career = Q20)   %>%
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         group_by(skills)                                %>% 
         mutate(n = n())                                 %>% 
         ggplot(aes(x = reorder(skills, -n), fill = career)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Where skills are acquired") + ylab("Numbers") +
         geom_text(aes(label = ..count..), position = position_stack(vjust = 0.5), 
                   stat = "count", size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0),
               legend.text=element_text(size = 6)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Skills acquisition by % career stage

```{r acquiring_skills_career_per}

data %>% select(num_range("Q11_", 1:12), career = Q20)   %>%
         group_by(career)                                %>% 
         mutate(N = n())                                 %>% 
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         group_by(skills)                                %>% 
         mutate(M = n())                                 %>% 
         group_by(career, skills)                        %>% 
         mutate(per = n()/N)                             %>% 
         distinct(career, skills, per, M)                %>% 
         ggplot(aes(x = reorder(skills, -M), y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Where skills are acquired") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0),
               legend.text=element_text(size = 8)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing "Other" and "-".

```{r acquiring_skills_career_per2}

data %>% select(num_range("Q11_", 1:12), career = Q20)   %>%
         group_by(career)                                %>% 
         mutate(N = n())                                 %>% 
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         filter(career != "Other" & career != "-")       %>%
         group_by(skills)                                %>% 
         mutate(M = n())                                 %>% 
         group_by(career, skills)                        %>% 
         mutate(per = n()/N)                             %>% 
         distinct(career, skills, per, M)                %>% 
         ggplot(aes(x = reorder(skills, -M), y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Where skills are being acquired") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0),
               legend.text=element_text(size = 8)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Skills acquisition by gender

```{r acquiring_skills_gender}

data %>% select(num_range("Q11_", 1:12), gender = Q21)   %>%
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         group_by(skills)                                %>% 
         mutate(n = n())                                 %>% 
         ggplot(aes(x = reorder(skills, -n), fill = gender)) + 
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Where skills are acquired") + ylab("Numbers") +
         geom_text(aes(label = ..count..), position = position_stack(vjust = 0.5), 
                   stat = "count", size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Skills acquisition by % gender pop

```{r acquiring_skills_gender_per}

data %>% select(num_range("Q11_", 1:12), gender = Q21)   %>%
         group_by(gender)                                %>% 
         mutate(N = n())                                 %>% 
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         group_by(skills)                                %>% 
         mutate(M = n())                                 %>% 
         group_by(gender, skills)                        %>% 
         mutate(per = n()/N)                             %>% 
         distinct(gender, skills, per, M)                   %>% 
         ggplot(aes(x = reorder(skills, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Where skills are being acquired") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r acquiring_skills_gender_per2}

data %>% select(num_range("Q11_", 1:12), gender = Q21)   %>%
         group_by(gender)                                %>% 
         mutate(N = n())                                 %>% 
         filter(!(gender %in% lowstatsgender))           %>% 
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")              %>%
         filter(skills != 0)                             %>%
         group_by(skills)                                %>% 
         mutate(M = n())                                 %>% 
         group_by(gender, skills)                        %>% 
         mutate(per = n()/N)                             %>% 
         distinct(gender, skills, per, M)                   %>% 
         ggplot(aes(x = reorder(skills, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Where skills are being acquired") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Skills acquisition % gender and career stage

```{r acquiring_skills_gender_per2_career}

data %>% select(num_range("Q11_", 1:12), career = Q20, gender = Q21)   %>%
         group_by(gender)                                              %>% 
         mutate(N = n())                                               %>% 
         filter(!(gender %in% lowstatsgender))                         %>% 
         filter(!(career %in% c("-", "Other")))                        %>% 
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = "questions",
                      values_to = "skills")                           %>%
         filter(skills != 0)                                          %>%
         group_by(skills)                                             %>% 
         mutate(M = n())                                              %>% 
         group_by(gender, skills, career)                             %>% 
         mutate(per = n()/N)                                          %>% 
         distinct(gender, skills, per, M, career)                     %>% 
         ggplot(aes(x = reorder(skills, -M), y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"),
                  colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.34)) +
         xlab("How skills are being acquired") + ylab("Percent") +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"),
                   vjust = -0.5, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         facet_wrap( ~ career)
```

### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices. Only showing combinations that have a count greater
than 1.

```{r acquiringSkills_choices}

data %>% select(id = URN, num_range("Q11_", 1:12))                     %>%
         pivot_longer(cols = num_range("Q11_", 1:12),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         filter(n  > 1)                                                %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```

### Other ways of acquiring skills

```{r other_mechanisms, results = 'asis'}

listOther("Q11_a")

```

### Q11b NCRM courses

If you have participated in National Centre for Research Methods
training at any point please indicate which training course(s) you have
taken here: (Check all that apply)

#### NCRM courses overview stats

The table below specifies the courses taken from the list we gave in the
survey.

```{r ncrm_courses_stats, results='asis'}

# These variables are used in the summary paragraph after the code section.

data %>% select(id = URN, num_range("Q11_b_", 1:22), career = Q20) %>%
         pivot_longer(cols = num_range("Q11_b_", 1:22),
                      names_to = NULL,
                      values_to = "ncrm")              %>%
         filter(ncrm != 0)                             %>%
         group_by(id)                                  %>%
         mutate(N = n())                               %>%
         ungroup()                                     %>%
         distinct(career, N) -> a

# This takes into account the "Other" category - previous code section only looks
# at 1 too 22, this one also includes i for (other)
data %>% select(id = URN, starts_with("Q11_b_"), career = Q20) %>%
         pivot_longer(cols = starts_with("Q11_b_"),
                      names_to = NULL,
                      values_to = "ncrm")              %>%
         filter(ncrm != 0)                             %>%
         group_by(id)                                  %>%
         mutate(N = n())                               %>%
         ungroup()                                     %>%
         distinct(career, N) -> b


```

We asked people if they had taken NCRM courses (question 11b) and asked people to check a list of the courses 
they had taken from a sample of 22 current courses (at the time the survey was deployed - that is early 2022)  
provided by the NCRM. What we can say though is that out of the `r nrow(data)` individual answers that we are 
using from the survey, `r sum(a$N)` individuals have taken NCRM courses or, if we take the `Other` content category
this rises to `r sum(b$N)` individuals that is `r percent(sum(a$N)/nrow(data), accuracy = 0.1)` or
`r percent(sum(b$N)/nrow(data), accuracy = 0.1)` respectively have taken NCRM courses.

#### List of NCRM courses taken

```{r ncrm_courses, results='asis'}

data %>% select(num_range("Q11_b_", 1:22)) %>%
         pivot_longer(cols = num_range("Q11_b_", 1:22),
                      names_to = "questions",
                      values_to = "ncrm")              %>%
         filter(ncrm != 0)                             %>%
         group_by(ncrm)                                %>%
         tally()                                       %>%
         arrange(desc(n))                              %>%
         kbl(format="pipe", align = c("l","r"),
                col.names = c("NCRM course", "Numbers"))
```

#### NCRM courses by career stage

```{r ncrm_courses_career}

data %>% select(id = URN, starts_with("Q11_b_"), career = Q20) %>%
         pivot_longer(cols = starts_with("Q11_b_"),
                      names_to = NULL,
                      values_to = "ncrm")              %>%
         filter(ncrm != 0)                             %>%
         distinct(id, ncrm, career)                    %>% 
         group_by(career)                              %>% 
         mutate(n = n())                               %>%
         distinct(career, n)                           %>% 
         ggplot(aes(x = career, y = n, fill = career)) +
         geom_col(colour = "black") + theme_bw() +
         scale_fill_brewer(palette = "Set1", name = "Career stage") +
         theme(legend.position = "none")  + ylab("Number of NCRM courses taken") +
         xlab("Career stage") + geom_text(aes(x = career, label = n ), vjust = -0.5, size = 3)

```

#### NCRM courses by gender

```{r ncrm_courses_gender}

data %>% select(id = URN, starts_with("Q11_b_"), gender = Q21) %>%
         pivot_longer(cols = starts_with("Q11_b_"),
                      names_to = NULL,
                      values_to = "ncrm")              %>%
         filter(ncrm != 0)                             %>%
         distinct(id, ncrm, gender)                    %>% 
         group_by(gender)                              %>% 
         mutate(n = n())                               %>%
         ungroup()                                     %>% 
         distinct(gender, n)                           %>% 
         ggplot(aes(x = gender, y = n, fill = gender)) +
         geom_col(colour = "black") + theme_bw() +
         scale_fill_brewer(palette = "Set2", name = "Career stage") +
         theme(legend.position = "none")  + ylab("Number of NCRM courses taken") +
         xlab("Gender") + geom_text(aes(x = gender, label = n ), vjust = -0.5, size = 3)

```


```{r ncrm_courses_gender2}

data %>% select(id = URN, starts_with("Q11_b_"), gender = Q21) %>%
         pivot_longer(cols = starts_with("Q11_b_"),
                      names_to = NULL,
                      values_to = "ncrm")              %>%
         filter(ncrm != 0)                             %>%
         filter(!(gender %in% lowstatsgender))         %>% 
         distinct(id, ncrm, gender)                    %>% 
         group_by(gender)                              %>% 
         mutate(n = n())                               %>%
         ungroup()                                     %>% 
         distinct(gender, n)                           %>% 
         ggplot(aes(x = gender, y = n, fill = gender)) +
         geom_col(colour = "black") + theme_bw() +
         scale_fill_brewer(palette = "Set2", name = "Career stage") +
         theme(legend.position = "none")  + ylab("Number of NCRM courses taken") +
         xlab("Gender") + geom_text(aes(x = gender, label = n ), vjust = -0.5, size = 3)

```

#### Number of NCRM courses by individuals by career stage

Need to be slightly careful with this measure - it counts an entry in
"Other" as a course even if a list is given there.

```{r ncrm_courses_individual_career}

data %>% select(id = URN, starts_with("Q11_b_"), career = Q20) %>%
         pivot_longer(cols = starts_with("Q11_b_"),
                      names_to = NULL,
                      values_to = "ncrm")              %>%
         filter(ncrm != 0)                             %>%
         distinct(id, ncrm, career)                   %>% 
         group_by(id)                                  %>% 
         mutate(N = n())                               %>% # Number of courses taken by individuals
         distinct(career, N) %>% 
         group_by(career, N)                           %>% 
         mutate(n = n())                               %>% # Number of individuals that have taken N courses
         ungroup()                                     %>% 
         distinct(career, n, N)                        %>% 
         ggplot(aes(x = N, y = n, fill = career)) +
         geom_col(colour = "black") + theme_bw() +
         scale_fill_brewer(palette = "Set1", name = "Career stage") +
         ylab("Number of people") +
         #scale_x_discrete() +
         xlab("Number of courses taken") + 
         geom_text(aes(x = N, label = n), position = position_stack(0.5),  size = 3)

```

#### Number of NCRM courses by individuals by gender

```{r ncrm_courses_individual_gender}

data %>% select(id = URN, starts_with("Q11_b_"), gender = Q21) %>%
         pivot_longer(cols = starts_with("Q11_b_"),
                      names_to = NULL,
                      values_to = "ncrm")                      %>%
         filter(ncrm != 0)                                     %>%
         filter(!(gender %in% lowstatsgender))                 %>% 
         distinct(id, ncrm, gender)                            %>% 
         group_by(id)                                          %>% 
         mutate(N = n())                                       %>% # Number of courses taken by individuals
         distinct(gender, N)                                   %>% 
         group_by(gender, N)                                   %>% 
         mutate(n = n())                                       %>% # Number of individuals that have taken N courses
         ungroup()                                             %>% 
         distinct(gender, n, N)                                %>% 
         ggplot(aes(x = N, y = n, fill = gender)) +
         geom_col(colour = "black") + theme_bw() +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         ylab("Number of people") +
         #scale_x_discrete() +
         xlab("Number of courses taken") + 
         geom_text(aes(x = N, label = n), position = position_stack(0.5),  size = 3)

```

### Other NCRM courses

```{r other_ncrm_courses, results='asis'}

listOther("Q11_b_i")

```

## Q12 Recognition

Do you feel in your field that the development and maintenance of
research software are sufficiently recognised or rewarded?

### Recognition responses

```{r recognition}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, Q12)  %>% 
         summarise(lab = paste0("Development/Maintenance of rsearch software rewarded/recognised (N=",
                                n_distinct(URN),")")) -> my

data %>%  select(URN, rew = Q12)                   %>%
          mutate(N = n_distinct(URN))              %>% 
          group_by(rew)                            %>% 
          mutate(n = n())                          %>% 
          mutate(per = percent(n/N, accuracy = 1)) %>% 
          distinct(rew, n, N, per)                 %>% 
          ggplot(aes(x = reorder(rew, -n), y = n, fill = n)) + 
          geom_col(colour = "black") +
          theme_bw() +
          xlab(my$lab) + scale_fill_distiller(palette = "Blues", direction = 1) +
          ylab("Numbers") + ylim(0, 76) +
          geom_text(aes(label = paste0(n," (", per,")")), vjust = -0.5, size = 3) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0), legend.position = "None")

```

### Recognition segmented by career stage

```{r recognition_careerStage}

data %>%  select(rew = Q12, career = Q20) %>%
          group_by(rew)                   %>% 
          mutate(n = n())                 %>% 
          ggplot(aes(x = reorder(rew, -n), fill = career)) + 
          geom_bar(colour = "black") +
          theme_bw() +
          xlab("Development/Maintenance of rsearch software rewarded/recognised") +
          ylab("Numbers") +
          geom_text(aes(label = ..count..), position = position_stack(vjust = 0.5), 
                   stat = "count", size = 3) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set1", name = "Career stage")

```

### Recognition segmented by career stage percentage

The percentages are given as a proportion of the given career stage
population.

```{r recognition_careerStage_per}

data %>%  select(rew = Q12, career =Q20) %>%
          group_by(career)               %>% 
          mutate(N = n())                %>% 
          group_by(rew, career)          %>% 
          mutate(per = n()/N)            %>% 
          distinct(rew, career, per)     %>% 
          ggplot(aes(x = rew, y = per, fill = career)) + 
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          theme_bw() +
          xlab("Development/Maintenance of rsearch software rewarded/recognised") +
          ylab("Percentage") +
          scale_y_continuous(labels = percent_format(accuracy = 1)) +
          geom_text(aes(label = percent(per, accuracy = 1)), 
                    position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                    size = 2) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set1", name = "Career stage")

```

Removing "Other" and "-".

```{r recognition_careerStage_per2}

data %>%  select(rew = Q12, career =Q20)        %>%
          group_by(rew)                         %>% 
          mutate(M = n())                       %>% 
          group_by(career)                      %>% 
          filter(!(career %in% c("Other","-"))) %>% 
          mutate(N = n())                       %>% 
          group_by(rew, career)                 %>% 
          mutate(per = n()/N)                   %>% 
          distinct(rew, career, per, M)         %>% 
          ggplot(aes(x = reorder(rew, -M), y = per, fill = career)) + 
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          theme_bw() +
          xlab("Development/Maintenance of rsearch software rewarded/recognised") +
          ylab("Percentage") +
          scale_y_continuous(labels = percent_format(accuracy = 1)) +
          geom_text(aes(label = percent(per, accuracy = 1)), 
                    position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                    size = 3) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set1", name = "Career stage")

```

### Recognition segmented by gender

```{r recognition_gender}

data %>%  select(rew = Q12, gender = Q21) %>%
          group_by(rew)       %>% 
          mutate(n = n())     %>% 
          ggplot(aes(x = reorder(rew, -n), fill = gender)) + 
          geom_bar(colour = "black") +
          theme_bw() +
          xlab("Development/Maintenance of rsearch software rewarded/recognised") +
          ylab("Numbers") +
          geom_text(aes(label = ..count..), position = position_stack(vjust = 0.5), 
                   stat = "count", size = 3) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set2", name = "Gender")

```

### Recognition segmented by gender percentage

The percentages are given as a proportion of the given gender
population.

```{r recognition_gender_per}

data %>%  select(rew = Q12, gender =Q21) %>%
          group_by(gender)               %>% 
          mutate(N = n())                %>% 
          group_by(rew, gender)          %>% 
          mutate(per = n()/N)            %>% 
          distinct(rew, gender, per)     %>% 
          ggplot(aes(x = rew, y = per, fill = gender)) + 
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          theme_bw() +
          xlab("Development/Maintenance of rsearch software rewarded/recognised") +
          ylab("Percentage") +
          scale_y_continuous(labels = percent_format(accuracy = 1)) +
          geom_text(aes(label = percent(per, accuracy = 1)), 
                    position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                    size = 2) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set2", name = "Gender")

```

```{r recognition_gender_per2}

data %>%  select(rew = Q12, gender = Q21)        %>%
          group_by(rew)                          %>% 
          mutate(M = n())                        %>% 
          filter(!(gender %in% lowstatsgender))  %>% 
          group_by(gender)                       %>% 
          mutate(N = n())                        %>% 
          group_by(rew, gender)                  %>% 
          mutate(per = n()/N)                    %>% 
          distinct(rew, gender, per, M)          %>% 
          ggplot(aes(x = reorder(rew, -M), y = per, fill = gender)) + 
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          theme_bw() +
          xlab("Development/Maintenance of rsearch software rewarded/recognised") +
          ylab("Percentage") +
          scale_y_continuous(labels = percent_format(accuracy = 1)) +
          geom_text(aes(label = percent(per, accuracy = 1)), 
                    position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                    size = 3) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set2", name = "Gender")

```

```{r recognition_gender_per2_career}

data %>%  select(rew = Q12, career= Q20, gender = Q21)  %>%
          group_by(rew)                          %>% 
          mutate(M = n())                        %>% 
          filter(!(gender %in% lowstatsgender))  %>% 
          filter(!(career %in% c("-", "Other"))) %>% 
          group_by(gender)                       %>% 
          mutate(N = n())                        %>% 
          group_by(rew, gender, career)                  %>% 
          mutate(per = n()/N)                    %>% 
          distinct(rew, gender, per, M, career)          %>% 
          ggplot(aes(x = reorder(rew, -M), y = per, fill = gender)) + 
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black", na.rm = TRUE) +
          theme_bw() +
          xlab("Development/Maintenance of rsearch software rewarded/recognised") +
          ylab("Percentage") +
          scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.32)) +
          geom_text(aes(label = percent(per, accuracy = 1)), 
                    position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                    size = 3, na.rm = TRUE) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set2", name = "Gender") +
          facet_wrap(~ career)

```
### Rationale

If you answered yes or no can you briefly state your reasons for
answering this way

```{r recognition_rationale, results = 'asis'}

listOther("Q12_a")

```

## Q13 Licensing

When answering this question, think about the most important piece of
software you use for research that you couldn't live without. To what
level do you agree/disagree with the following statements?

### Q13a Awareness of software funding, managent and licensing

I am aware of how the software I use is funded, managed and licensed

#### Responses

```{r aware_sw}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q13_1_",1:5))  %>% 
           pivot_longer(cols = num_range("Q13_1_",1:5),
                      names_to = NULL,
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         summarise(lab = paste0("Aware of how s/w I use is funded, managed and licensed (N=",
                                n_distinct(URN),")")) -> my

data %>% select(num_range("Q13_1_",1:5))            %>%
         pivot_longer(cols = num_range("Q13_1_",1:5),
                      names_to = NULL,
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         group_by(understanding)                    %>% 
         mutate(n = n())                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = n)) + 
         geom_bar(colour = "black") + scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         theme_bw() + ylab("Numbers") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 10), 
               legend.position = "None") +
         xlab(my$lab)
```

#### Responses by career stage

```{r aware_sw_career}

data %>% select(num_range("Q13_1_",1:5), career = Q20)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = career)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Aware of how s/w I use is funded, managed and licensed") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

#### Responses as % of career stage

Percentages may not add up to 100% as members that have not answered the question 
are not shown.

```{r aware_sw_career_per}

data %>% select(num_range("Q13_1_",1:5), career = Q20)                                  %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                       position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how s/w I use is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing "Other" and "-"

```{r aware_sw_career_per2}

data %>% select(num_range("Q13_1_",1:5), career = Q20)                                  %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         filter(!(career %in% c("Other","-")))                                          %>% 
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                       position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how s/w I use is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

#### Responses by gender

```{r aware_sw_gender}

data %>% select(num_range("Q13_1_",1:5), gender = Q21)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = gender)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Aware of how s/w I use is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

#### Responses as % of gender

Percentages may not add up to 100% as members that have not answered the question 
are not shown.

```{r aware_sw_gender_per}

data %>% select(num_range("Q13_1_",1:5), gender = Q21)                                  %>%
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how s/w I use is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r aware_sw_gender_per2}

data %>% select(num_range("Q13_1_",1:5), gender = Q21)                                  %>%
         filter(!(gender %in% lowstatsgender))                                          %>% 
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how s/w I use is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Q13b Clarity of software funding, managent and licensing

My institution/funder's policies on how software is funded, managed and
licensed are clear to me

#### Responses

```{r aware_policies}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q13_2_",1:5))  %>% 
         pivot_longer(cols = num_range("Q13_2_",1:5),
                      names_to = "questions",
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         summarise(lab = paste0("Aware of how s/w I use is funded, managed and licensed (N=",
                                n_distinct(URN),")")) -> my

data %>% select(num_range("Q13_2_",1:5))            %>%
         pivot_longer(cols = num_range("Q13_2_",1:5),
                      names_to = "questions",
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         group_by(understanding)                    %>% 
         mutate(n = n())                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = n)) + 
         geom_bar(colour = "black") + 
        scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         theme_bw() + ylab("Numbers") + theme(legend.position = "None") +
         xlab(my$lab)
```

#### Responses by career stage

```{r aware_policies_career}

data %>% select(num_range("Q13_2_",1:5), career = Q20)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = career)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Aware of how institution/funder's policies on how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

#### Responses as % of career stage


```{r aware_policies_career_per}

data %>% select(num_range("Q13_2_",1:5), career = Q20)     %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how institution/funder's policies on how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing "Other" and "-"

```{r aware_policies_career_per2}

data %>% select(num_range("Q13_2_",1:5), career = Q20)                                  %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         filter(!(career %in% c("Other", "-")))                                         %>% 
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how institution/funder's policies on how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```


#### Responses by gender

```{r aware_policies_gender}

data %>% select(num_range("Q13_2_",1:5), gender = Q21)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = gender)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Aware of how institution/funder's policies on how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

#### Responses as % of gender pop

```{r aware_policies_gender_per}

data %>% select(num_range("Q13_2_",1:5), gender = Q21)     %>%
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how institution/funder's policies on how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r aware_policies_gender_per2}

data %>% select(num_range("Q13_2_",1:5), gender = Q21)                                  %>%
         filter(!(gender %in% lowstatsgender))                                          %>% 
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how institution/funder's policies on how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

#### Gender and career stage

```{r aware_policies_gender_per2_career}

data %>% select(num_range("Q13_2_",1:5), career = Q20, gender = Q21)                    %>%
         filter(!(gender %in% lowstatsgender))                                          %>% 
         filter(!(career %in% c("-", "Other")))                                         %>% 
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender, career)                                        %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per, career)                                   %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.21)) +
         theme_bw() + ylab("Percent") +
         xlab("Aware of how institution/funder's policies on how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         facet_wrap(~ career)
```

### Q13c Insufficient attention paid to s/w funding, management and licensing

There is insufficient attention paid to software funding, management and
licensing by the economic and social sciences research community

#### Responses

```{r insufficient_attention}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q13_3_",1:5))  %>% 
         pivot_longer(cols = num_range("Q13_3_",1:5),
                      names_to = "questions",
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         summarise(lab = 
              paste0("Insufficient awareness on how s/w is funded, managed and licensed by the community (N=",
                     n_distinct(URN),")")) -> my

data %>% select(num_range("Q13_3_",1:5))            %>%
         pivot_longer(cols = num_range("Q13_3_",1:5),
                      names_to = "questions",
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         group_by(understanding)                    %>% 
         mutate(n = n())                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = n)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         theme_bw() + ylab("Numbers") + scale_fill_distiller(palette = "Blues", direction = 1) +
         xlab(my$lab) + theme(legend.position = "None")
```

#### Responses by career stage

```{r insufficient_attention_career}

data %>% select(num_range("Q13_3_",1:5), career = Q20)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = career)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Insufficient awareness on how s/w is funded, managed and licensed by the community") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

#### Responses as % of career stage

```{r insufficient_attention_career_per}

data %>% select(num_range("Q13_3_",1:5), career = Q20)                                  %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                       position = position_dodge2(width = 0.9, preserve = "single"), size = 2, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient awareness on how s/w is funded, managed and licensed by the community") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing "-" and "Other".

```{r insufficient_attention_career_per2}

data %>% select(num_range("Q13_3_",1:5), career = Q20)                                  %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         filter(!(career %in% c("Other", "-")))                                         %>% 
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                       position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient awareness on how s/w is funded, managed and licensed by the community") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

#### Responses by gender

```{r insufficient_attention_gender}

data %>% select(num_range("Q13_3_",1:5), gender = Q21)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = gender)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Insufficient awareness on how s/w is funded, managed and licensed by the community") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

#### Responses as % of gender pop

```{r insufficient_attention_gender_per}

data %>% select(num_range("Q13_3_",1:5), gender = Q21)                                  %>%
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient awareness on how s/w is funded, managed and licensed by the community") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r insufficient_attention_gender_per2}

data %>% select(num_range("Q13_3_",1:5), gender = Q21)                                  %>%
        filter(!(gender %in% lowstatsgender))                                           %>% 
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient awareness on how s/w is funded, managed and licensed by the community") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

#### Gender and career stage

```{r insufficient_attention_gender_per2_career}

data %>% select(num_range("Q13_3_",1:5), career = Q20, gender = Q21)                    %>%
         filter(!(gender %in% lowstatsgender))                                          %>% 
         filter(!(career %in% c("-","Other")))                                          %>% 
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender, career)                                        %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per, career)                                   %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.22)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient awareness on how s/w is funded, managed and licensed by the community") +
         scale_fill_brewer(palette = "Set2", name = "Gender") + 
         facet_wrap(~ career)
```
### Q13d Insufficient incentive to learn how s/w is funded, managed and licensed

There is insufficient incentive for me to learn how my software is
funded, managed and licensed

#### Responses

```{r insufficient_incentives}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q13_4_",1:5))  %>% 
         pivot_longer(cols = num_range("Q13_4_",1:5),
                      names_to = "questions",
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         summarise(lab = 
                     paste0("Insufficient incentive learn how s/w is funded, managed and licensed (N=",
                            n_distinct(URN),")")) -> my

data %>% select(num_range("Q13_4_",1:5))            %>%
         pivot_longer(cols = num_range("Q13_4_",1:5),
                      names_to = "questions",
                      values_to = "understanding")  %>%
         filter(understanding != 0)                 %>%
         group_by(understanding)                    %>% 
         mutate(n = n())                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = n)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
         scale_fill_distiller(palette = "Blues", direction = 1) +
         theme_bw() + ylab("Numbers") + theme(legend.position = "None") +
         xlab(my$lab)
```

#### Responses by career stage

```{r insufficient_incentives_career}

data %>% select(num_range("Q13_4_",1:5), career = Q20)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = career)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Insufficient incentive for me to learn how my s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

#### Distribution of answers as % of career stage

```{r insufficient_incentives_career_per}

data %>% select(num_range("Q13_4_",1:5), career = Q20)                                  %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                       position = position_dodge2(width = 0.9, preserve = "single"), size = 2, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient incentive to learn how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing "Other" and "-"

```{r insufficient_incentives_career_per2}

data %>% select(num_range("Q13_4_",1:5), career = Q20)                                  %>%
         group_by(career)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         filter(!(career %in% c("Other", "-")))                                         %>% 
         group_by(understanding, career)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, career, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = career)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                       position = position_dodge2(width = 0.9, preserve = "single"), size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient incentive to learn how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

#### Responses by gender

```{r insufficient_incentives_gender}

data %>% select(num_range("Q13_4_",1:5), gender = Q21)     %>%
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")         %>%
         filter(understanding != 0)                        %>%
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         ggplot(aes(x = understanding, fill = gender)) + 
         geom_bar(colour = "black") +
         geom_text(aes(label = ..count..), stat = "count",position = position_stack(0.5), size = 3) +
         theme_bw() + ylab("Numbers") +
         xlab("Insufficient incentive to learn how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

#### Distribution of answers as % of gender pop

```{r insufficient_incentives_gender_per}

data %>% select(num_range("Q13_4_",1:5), gender = Q21)                                  %>%
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 2, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient incentive to learn how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

```{r insufficient_incentives_gender_per2}

data %>% select(num_range("Q13_4_",1:5), gender = Q21)                                  %>%
         filter(!(gender %in% lowstatsgender))                                          %>% 
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender)                                                %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per)                                           %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient incentive to learn how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

#### Gender and career stage

```{r insufficient_incentives_gender_per2_career}

data %>% select(num_range("Q13_4_",1:5), career = Q20, gender = Q21)                    %>%
         filter(!(career %in% c("-", "Other")))                                         %>% 
         filter(!(gender %in% lowstatsgender))                                          %>% 
         group_by(gender)                                                               %>% 
         mutate(N = n())                                                                %>% 
         pivot_longer(cols = starts_with("Q13"),
                      names_to = NULL,
                      values_to = "understanding")                                      %>%
         filter(understanding != 0)                                                     %>%
         group_by(understanding, gender, career)                                        %>% 
         mutate(per = n()/N)                                                            %>% 
         mutate(understanding = factor(understanding, levels = likert, ordered = TRUE)) %>%
         distinct(understanding, gender, per, career)                                   %>% 
         ggplot(aes(x = understanding, y = per, fill = gender)) + 
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         geom_text(aes(y = per, label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), 
                   size = 3, vjust = -0.5) +
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.20)) +
         theme_bw() + ylab("Percent") +
         xlab("Insufficient incentive to learn how s/w is funded, managed and licensed") +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         facet_wrap(~ career)
```

### Combined Q13 graph

```{r combined_q13}
data %>% select(URN, starts_with("Q13_"), career = Q20, gender = Q21)     %>%
         pivot_longer(cols = num_range("Q13_1_",1:5),
                      names_to = NULL,
                      values_to = "Q13a")                                 %>% 
         pivot_longer(cols = num_range("Q13_2_",1:5),
                      names_to = NULL,
                      values_to = "Q13b")                                 %>% 
         pivot_longer(cols = num_range("Q13_3_",1:5),
                      names_to = NULL,
                      values_to = "Q13c")                                 %>% 
         pivot_longer(cols = num_range("Q13_4_",1:5),
                      names_to = NULL,
                      values_to = "Q13d")                                %>% 
         pivot_longer(cols = c("Q13a", "Q13b","Q13c","Q13d"),
                      names_to = "Q13",
                      values_to ="Response")                             %>% 
        filter(Response != 0)                                            %>% 
        distinct(URN, career, gender, Q13, Response)                     %>% 
        mutate(Response = factor(Response, 
              levels = c("Strongly agree","Agree","Undecided", "Disagree","Strongly disagree"))) %>% 
        ggplot(aes(x = Response, fill = Q13)) + geom_bar(position = position_dodge2(), colour = "black") +
        theme_bw() + ylab("Numbers")

```

## Q14 Where software is run

Where do you normally run your digital tools/software? Please check all
that apply. The UK Tier 1 provides a national supercomputing service,
e.g. ARCHER2, and Tier 2 systems provide computational services
somewhere between institutional and the national Tier 1 service.

### Distribution of where software is run

```{r where_sw_run}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q14_", 1:9))  %>% 
         pivot_longer(cols = num_range("Q14_", 1:9),
                      names_to = "questions",
                      values_to = "runon")              %>%
         filter(runon != 0)                             %>%
         summarise(lab = paste0("Where software is run (N=", n_distinct(URN),")")) -> my

data %>%  select(URN, num_range("Q14_", 1:9))         %>%
          pivot_longer(cols = num_range("Q14_", 1:9),
                       names_to = "questions",
                       values_to = "runon")              %>%
          filter(runon != 0)                             %>%
          mutate(N = n_distinct(URN))                    %>% 
          group_by(runon)                                %>% 
          mutate(n = n())                                %>% 
  ggplot(aes(x = reorder(runon, -n), fill = n)) +
  geom_bar(colour = "black") +
  theme_bw() + ylim(0, 111) +
  xlab(my$lab) + ylab("Numbers") + scale_fill_distiller(palette = "Blues", direction = 1) +
  geom_text(aes(y = n,label = paste0(n," (", percent(n/N, accuracy = 1),")")), vjust = -0.5, size = 3) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 8), legend.position = "None")
```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation. Removed the use of tier 1 and
tier 2 as these got no response.

```{r q14_correlations}

data0 %>% select(num_range("Q14_", 1:9)) -> q  
 q <- q[,c(-6, -7)]
names(q) <- hw[c(-6, -7)]

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.75*par("cex.lab"))

```

### Where software is run by career stage

```{r where_sw_run_career}

data %>%  select(num_range("Q14_", 1:9), career = Q20)         %>%
  pivot_longer(cols = num_range("Q14_", 1:9),
               names_to = NULL,
               values_to = "runon")              %>%
  filter(runon != 0)                             %>%
  group_by(runon)                                %>% 
  mutate(n = n())                                %>% 
  group_by(career, runon)                        %>% 
  ggplot(aes(x = reorder(runon, -n), fill  = career)) +
  geom_bar( colour = "black") +
  theme_bw() +
  xlab("Where software is run") + ylab("Numbers") +
  geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
  scale_fill_brewer(palette = "Set1", name = "Career stage")

```


### Where software is run by % career stage

```{r where_sw_run_career_per2}

data %>%  select(num_range("Q14_", 1:9), career = Q20)         %>%
  group_by(career)                                             %>% 
  mutate(N = n())                                              %>% 
  pivot_longer(cols = num_range("Q14_", 1:9),
               names_to = NULL,
               values_to = "runon")                            %>%
  filter(runon != 0)                                           %>%
  group_by(runon)                                              %>% 
  mutate(M = n())                                              %>% 
  filter(!(career %in% c("Other", "-")))                       %>% 
  group_by(career, runon)                                      %>% 
  mutate(n = n())                                              %>% 
  mutate(per = percent(n/N, accuracy = 1))                     %>% 
  distinct(M, N, n, per)                                       %>% 
  ggplot(aes(x = reorder(runon, -M), y = n/N, fill  = career)) +
  geom_col( position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
  theme_bw() + scale_y_continuous(labels = percent_format(accuracy = 1)) +
  xlab("Where software is run") + ylab("Percent") +
  geom_text(aes(label = per), vjust = -0.5,
            position = position_dodge2(width = 0.9, preserve = "single"), size = 3) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
  scale_fill_brewer(palette = "Set1", name = "Career stage")

```


### Where software is run by gender

```{r where_sw_run_gender}

data %>%  select(num_range("Q14_", 1:9), gender = Q21)         %>%
  pivot_longer(cols = num_range("Q14_", 1:9),
               names_to = NULL,
               values_to = "runon")              %>%
  filter(runon != 0)                             %>%
  group_by(runon)                                %>% 
  mutate(n = n())                                %>% 
  group_by(gender, runon)                        %>% 
  ggplot(aes(x = reorder(runon, -n), fill  = gender)) +
  geom_bar( colour = "black") +
  theme_bw() +
  xlab("Where software is run") + ylab("Numbers") +
  geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 3) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
  scale_fill_brewer(palette = "Set2", name = "Gender")

```
### Where software is run by % gender

```{r where_sw_run_gender_per}

data %>%  select(num_range("Q14_", 1:9), gender = Q21)         %>%
  group_by(gender)                                             %>% 
  mutate(N = n())                                              %>% 
  pivot_longer(cols = num_range("Q14_", 1:9),
               names_to = NULL,
               values_to = "runon")                            %>%
  filter(runon != 0)                                           %>%
  group_by(runon)                                              %>% 
  mutate(M = n())                                              %>% 
  filter(!(gender %in% lowstatsgender))                        %>% 
  group_by(gender, runon)                                      %>% 
  mutate(n = n())                                              %>% 
  mutate(per = percent(n/N, accuracy = 1))                     %>% 
  distinct(M, N, n, per)                                       %>% 
  ggplot(aes(x = reorder(runon, -M), y = n/N, fill  = gender)) +
  geom_col( position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
  theme_bw() + scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.76)) +
  xlab("Where software is run") + ylab("Percent") +
  geom_text(aes(label = per), vjust = -0.5,
            position = position_dodge2(width = 0.9, preserve = "single"), size = 3) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
  scale_fill_brewer(palette = "Set2", name = "Gender")

```


### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices. Only showing combinations that have a count greater
than 1.

```{r run_choices}

data %>% select(id = URN, num_range("Q14_", 1:9))                       %>%
         pivot_longer(cols = num_range("Q14_", 1:9),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
         distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         filter(n  > 1)                                                %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```

### Other platforms used

```{r other_run_on, results='asis'}

listOther("Q14_a")

```

## Q15 Licensing and publishing policies

A licensing policy provides instruction or guidance on what software
licenses are preferred for the release of software.

A publishing policy provides instruction or guidance on how software
should be made available to others.

Which relevant software policies are you aware of (please check all you
are aware of)?

### Licensing policies awareness distributions

```{r licensing}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, starts_with("Q15_"), -"Q15_a")  %>% 
         pivot_longer(cols = starts_with("Q15_"),
                      names_to = NULL,
                      values_to ="aware")                               %>%
         filter(aware != 0)                                             %>%
         summarise(lab = paste0("Aware of the policy for (N=", n_distinct(URN),")")) -> my

data %>% select(URN, starts_with("Q15_"), -"Q15_a")                     %>%
         pivot_longer(cols = starts_with("Q15_"),
                      names_to = NULL,
                      values_to ="aware")                               %>%
         filter(aware != 0)                                             %>%
         mutate(N = n_distinct(URN))                                    %>% 
         mutate(aware = factor(aware, ordered = TRUE, levels = licawa)) %>% 
         group_by(aware)                                                %>%
         mutate(n = n_distinct(URN))                                    %>% 
         mutate(per = percent(n/N, accuracy = 1))                       %>% 
         ggplot(aes(x = aware, fill = n)) + 
         geom_bar(colour = "black") +
         theme_bw() + ylim(0,76) + scale_fill_distiller(palette = "Blues", direction = 1) +
         geom_text(aes(y = n, label = paste0(n, " (", per, ")")),  
                   vjust = -0.5, size = 3) +
         ylab("Numbers") + xlab(my$lab)  +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 12), 
               legend.position = "None") 
```


### Licensing policies awareness by career stage

```{r licensing_career}

data %>% select(starts_with("Q15_"), -"Q15_a", career = Q20)            %>%
         pivot_longer(cols = starts_with("Q15_"),
                      names_to = NULL,
                      values_to ="aware")                               %>%
         filter(aware != 0)                                             %>%
         mutate(aware = factor(aware, ordered = TRUE, levels = licawa)) %>% 
         group_by(career, aware)                                        %>% 
         mutate(n = n())                                                %>% 
         ggplot(aes(x = aware, fill = career)) +
         geom_bar(colour = "black") +
         theme_bw() +
         geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 3) +
         ylab("Numbers") + xlab("Aware of the policy for") +
         scale_fill_brewer(palette = "Set1", name = "Career stage") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```

### Licensing policies awareness by % career stage

```{r licensing_career_per}

data %>% select(id = URN, starts_with("Q15_"), -"Q15_a", career = Q20)     %>%
         group_by(career)                                                  %>%
         mutate(N = n())                                                  %>% 
         pivot_longer(cols = starts_with("Q15_"),
                      names_to = NULL,
                      values_to ="aware")                                 %>%
         filter(aware != 0)                                               %>%
         distinct(id, aware, career,N)                                    %>% 
         filter(!(career %in% c("Other","-")))                            %>% 
         mutate(aware = factor(aware, ordered = TRUE, levels = licawa))   %>% 
         group_by(career, aware)                                          %>% 
         mutate(n = n())                                                  %>% 
         mutate(per = percent(n/N, accuracy = 1))                         %>% 
         distinct(n, N, per, career, aware)                               %>% 
         ggplot(aes(x = aware, y = n/N, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + 
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = per), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3) +
         ylab("Percent") + xlab("Aware of the policy for") +
         scale_fill_brewer(palette = "Set1", name = "Career stage") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```

### Licensing policies awareness by gender

```{r licensing_gender}

data %>% select(starts_with("Q15_"), -"Q15_a", gender = Q21)              %>%
         pivot_longer(cols = starts_with("Q15_"),
                      names_to = NULL,
                      values_to ="aware")                                 %>%
         filter(aware != 0)                                               %>%
         mutate(aware = factor(aware, ordered = TRUE, levels = licawa))   %>% 
         group_by(gender, aware)                                          %>% 
         mutate(n = n())                                                  %>% 
         ggplot(aes(x = reorder(aware, -n), fill = gender)) +
         geom_bar(colour = "black") +
         theme_bw() +
         geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 3) +
         ylab("Numbers") + xlab("Aware of the policy for") +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```

### Licensing policies awareness by % career stage

```{r licensing_gender_per}

data %>% select(id = URN, starts_with("Q15_"), -"Q15_a", gender = Q21)    %>%
         group_by(gender)                                                  %>%
         mutate(N = n())                                                  %>% 
         group_by(gender)                                                 %>% 
         pivot_longer(cols = starts_with("Q15_"),
                      names_to = NULL,
                      values_to ="aware")                                 %>%
         filter(aware != 0)                                               %>%
         distinct(id, aware, gender,N)                                    %>% 
         filter(!(gender %in% lowstatsgender))                            %>% 
         mutate(aware = factor(aware, ordered = TRUE, levels = licawa))   %>% 
         group_by(gender, aware)                                          %>% 
         mutate(n = n())                                                  %>% 
         mutate(per = percent(n/N, accuracy = 1))                         %>% 
         distinct(n, N, per, gender, aware)                               %>% 
         ggplot(aes(x = aware, y = n/N, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + 
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = per), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3) +
         ylab("Percent") + xlab("Aware of the policy for") +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```

### Awareness by gender and career stage

```{r licensing_gender_per_career}

data %>% select(id = URN, starts_with("Q15_"), -"Q15_a", career = Q20, 
                gender = Q21)    %>%
         group_by(gender)                                                 %>%
         mutate(N = n())                                                  %>% 
         pivot_longer(cols = starts_with("Q15_"),
                      names_to = NULL,
                      values_to ="aware")                                 %>%
         filter(aware != 0)                                               %>%
         distinct(id, aware, gender,N, career)                            %>% 
         filter(!(gender %in% lowstatsgender))                            %>% 
         filter(!(career %in% c("-", "Other")))                           %>% 
         mutate(aware = factor(aware, ordered = TRUE, levels = licawa))   %>% 
         group_by(gender, aware, career)                                  %>% 
         mutate(n = n())                                                  %>% 
         mutate(per = percent(n/N, accuracy = 1))                         %>% 
         distinct(n, N, per, gender, aware, career)                       %>% 
         ggplot(aes(x = aware, y = n/N, fill = gender)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + 
         scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 0.23)) +
         geom_text(aes(label = per), vjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 3) +
         ylab("Percent") + xlab("Aware of the policy for") +
         scale_fill_brewer(palette = "Set2", name = "Gender") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         facet_wrap(~career)

```

### Awareness vs institutions

Percentages are given as a percentage from an institution.

```{r awareness_inst}

data %>% select(Institutions = CleanLocs, starts_with("Q15_"), -"Q15_a") %>%
         group_by(Institutions)                                          %>% 
         mutate(N = n())                                                 %>%
         pivot_longer(cols = starts_with("Q15"),
                      names_to = "columns",
                      values_to ="aware")                                %>%
         filter(aware != 0)                                              %>%
         mutate(aware = factor(aware, ordered = TRUE, levels = licawa))  %>% 
 
         group_by(aware, Institutions)                                   %>%
         mutate(n = n())                                                 %>%
         ggplot(aes(x = aware, y = Institutions, size = n/N)) +
         geom_point(alpha = 0.25) +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0)) +
         theme(axis.text.y = element_text(size = 6)) +
         ylab("Institutions") + xlab("Aware of the policy for") +
         labs(size = "Percent of Institution") + scale_size_continuous(labels = percent)
```

### Other policies

```{r other_policies, results = 'asis'}

listOther("Q15_a")

```

## Q16 Barriers to software use

What barriers have you experienced to the use of software in your
research? (Check all that apply.)

### Barriers

```{r barriers}

# Calculate an x label with the folks that filled in this question.
data %>% select(URN, num_range("Q16_", 1:13))           %>% 
         pivot_longer(cols = num_range("Q16_", 1:13),
                      names_to = "questions",
                      values_to = "barriers")            %>%
         filter(barriers != 0)                           %>%
         summarise(lab = paste0("Barriers to software use (N=", n_distinct(URN),")")) -> my


data %>%  select(num_range("Q16_", 1:13))         %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = "questions",
               values_to = "barriers")            %>%
  filter(barriers != 0)                           %>%
  group_by(barriers)                              %>%
  mutate(n = n())                                 %>% 
  ggplot(aes(x = reorder(barriers, -n), fill = n)) +
  geom_bar(colour = "black") +
  theme_bw() + ylim(0, 91) +
  xlab(my$lab) + ylab("Numbers") + scale_fill_distiller(palette = "Blues", direction = 1) +
  geom_text(aes(label = ..count..), stat = "count", vjust = -0.5, size = 3) +
  theme(axis.text.x = element_text(angle = -60, vjust = 0.5, hjust=0, size = 10),
        legend.position = "None")

```

### Choice correlations

My interpretation of this graph is that obtuse angles are negatively correlated, 
acute are positively correlated, circles are not correlated. The thinner the ellipse
the stronger the correlation or anti correlation.

```{r q16_correlations}

data0 %>% select(num_range("Q16_", 1:13)) -> q  
names(q) <- barriers

q <- apply(q, 2, function(x) as.integer(x))

my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.5*par("cex.lab"))

```

### Barriers by career stage

```{r barriers_careeer}

data %>%  select(num_range("Q16_", 1:13), career = Q20) %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(barriers)                                    %>%
  mutate(n = n())                                       %>% 
  ggplot(aes(x = reorder(barriers, -n), fill  = career)) +
  geom_bar(colour = "black") +
  theme_bw() +
  xlab("Barriers to software use") + ylab("Numbers") +
  geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))  +
  scale_fill_brewer(palette = "Set1", name = "Career stage")

```

### Barriers as % of careers

```{r barriers_careeer_per}

data %>%  select(num_range("Q16_", 1:13), career = Q20) %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(career)                                      %>%
  mutate(N = n())                                       %>% 
  group_by(career, barriers)                            %>%
  mutate(per = n()/N)                                   %>% 
  distinct(career, barriers, per)                       %>% 
  ggplot(aes(x =barriers, y = per, fill  = career)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
  theme_bw() +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  xlab("Barriers to software use") + ylab("Percentage") +
  geom_text(aes(label = percent(per, accuracy = 1)), 
            position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))  +
  scale_fill_brewer(palette = "Set1", name = "Career stage")

```

Removing "Other" and "-"

```{r barriers_careeer_per2}

data %>%  select(num_range("Q16_", 1:13), career = Q20) %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(barriers)                                    %>% 
  mutate(M = n())                                       %>% 
  filter(!(career %in% c("Other", "-")))                %>% 
  group_by(career)                                      %>%
  mutate(N = n())                                       %>% 
  group_by(career, barriers)                            %>%
  mutate(per = n()/N)                                   %>% 
  distinct(career, barriers, per, M)                   %>% 
  ggplot(aes(x = reorder(barriers, -M), y = per, fill  = career)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
  theme_bw() +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  xlab("Barriers to software use") + ylab("Percentage") +
  geom_text(aes(label = percent(per, accuracy = 1)), 
            position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0, size = 8),
        legend.text = element_text(size = 6))  +
  scale_fill_brewer(palette = "Set1", name = "Career stage")

```

### Barriers frequencies with gender

```{r barriers_gender}

data %>%  select(num_range("Q16_", 1:13), gender = Q21) %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(barriers)                                    %>%
  mutate(n = n())                                       %>% 
  ggplot(aes(x = reorder(barriers, -n), fill  = gender)) +
  geom_bar(colour = "black") +
  theme_bw() +
  xlab("Barriers to software use") + ylab("Numbers") +
  geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))  +
  scale_fill_brewer(palette = "Set2", name = "Gender")

```

### Barriers as % of gender

```{r barriers_gender_per}

data %>%  select(num_range("Q16_", 1:13), gender = Q21) %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(gender)                                      %>%
  mutate(N = n())                                       %>% 
  group_by(gender, barriers)                            %>%
  mutate(per = n()/N)                                   %>% 
  distinct(gender, barriers, per)                       %>% 
  ggplot(aes(x =barriers, y = per, fill  = gender)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
  theme_bw() +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  xlab("Barriers to software use") + ylab("Percentage") +
  geom_text(aes(label = percent(per, accuracy = 1)), 
            position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))  +
  scale_fill_brewer(palette = "Set2", name = "Gender")

```

Remove the low stat components

```{r barriers_gender_per2}

data %>%  select(num_range("Q16_", 1:13), gender = Q21) %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(barriers)                                    %>% 
  mutate(M = n())                                       %>% 
  group_by(gender)                                      %>%
  filter(!(gender %in% lowstatsgender))                 %>% 
  mutate(N = n())                                       %>% 
  group_by(gender, barriers)                            %>%
  mutate(per = n()/N)                                   %>% 
  distinct(gender, barriers, per, M)                    %>% 
  ggplot(aes(x = reorder(barriers, -M), y = per, fill  = gender)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
  theme_bw() +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  xlab("Barriers to software use") + ylab("Percentage") +
  geom_text(aes(label = percent(per, accuracy = 0.1)), 
            position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5, size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))  +
  scale_fill_brewer(palette = "Set2", name = "Gender")

```

### Barriers and dissability

```{r barriers_dis}

data %>%  select(num_range("Q16_", 1:13), dis = Q23)    %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(barriers)                                    %>%
  mutate(n = n())                                       %>% 
  ggplot(aes(x = reorder(barriers, -n), fill  = dis)) +
  geom_bar(colour = "black") +
  theme_bw() +
  xlab("Barriers to software use") + ylab("Numbers") +
  geom_text(aes(label = ..count..), stat = "count", position = position_stack(0.5), size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))  +
  scale_fill_brewer(palette = "Set3", name = "Dissability")

```

```{r barriers_dis_per}

data %>%  select(num_range("Q16_", 1:13), dis = Q23)    %>%
  pivot_longer(cols = num_range("Q16_", 1:13),
               names_to = NULL,
               values_to = "barriers")                  %>%
  filter(barriers != 0)                                 %>%
  group_by(barriers)                                    %>%
  mutate(M = n())                                       %>% 
  group_by(dis)                                         %>% 
  mutate(N = n())                                       %>% 
  group_by(dis, barriers)                               %>% 
  filter(dis != "-")                                    %>% 
  mutate(n = n())                                       %>% 
  mutate(per = percent(n/N, accuracy = 1))              %>% 
  distinct(dis, M, N, n, per, barriers)                 %>% 
  ggplot(aes(x = reorder(barriers, -M), y = n/N, fill = dis)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"), 
           colour = "black") +
  theme_bw() + scale_y_continuous(labels = percent_format(accuarcy = 1)) +
  xlab("Barriers to software use") + ylab("Percent") +
  geom_text(aes(y = n/N, label = per), 
            position = position_dodge2(width = 0.9, preserve = "single"),
            vjust = -0.5, size = 2) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))  +
  scale_fill_brewer(palette = "Set3", name = "Dissability")

```


### Counting combined choices

For each multiple choice replace spaces by "-"s and collapse all the
non-empty choices and join them with an "\_". So, if an individual only
chose A then that would only contribute an A, if an individual chose A,
B and D then that would contribute an A_B\_D then we count all the
combined choices.

```{r barrier_choices}

data %>% select(id = URN, num_range("Q16_", 1:13))                       %>%
         pivot_longer(cols = num_range("Q16_", 1:13),
                      names_to = NULL,
                      values_to = "ds")                                %>%
         filter(ds != 0)                                               %>%  
         group_by(id)                                                  %>% 
         mutate(choices = paste0(gsub(" ","-", ds), collapse = "_"))   %>% 
        # distinct(id, choices)                                         %>% 
         ungroup()                                                     %>% 
         select(-id)                                                   %>% 
         group_by(choices)                                             %>% 
         tally()                                                       %>% 
         arrange(desc(n))                                              %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Combined choice", "Numbers"))
```

### Other barriers

```{r other_barriers, results='asis'}

listOther("Q16_a")

```

## Q17 Institutions

### Institutions

The institutional affiliations of respondents to the survey.

```{r TabulateInstitutions}
data %>% select(Institution = CleanLocs)     %>%
         #filter(!is.na(institution))        %>%
         group_by(Institution)               %>%
         replace_na(list(Institution = "-")) %>% 
         tally()                             %>%
         filter(n > 3)                       %>% 
         arrange(desc(n))                    %>%
         kbl(format="pipe", align = c("l","r"),
                col.names = c("Institutions", "Responses"))
```

### Map institutions

```{r mapInstitutions}
     
data %>%  
          select(Institutions = CleanLocs, Latitude, Longitude)  %>%
          filter(!is.na(Institutions) & !is.na(Latitude))        %>%
          filter(-7 <= Longitude & Longitude <= 1.6)             %>%
          filter(49 <= Latitude & Latitude <= 59)                %>%
          group_by(Institutions)                                 %>%
          mutate(n = n())                                        %>%
          leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
          addTiles()                                             %>%
          addCircleMarkers(lng = ~Longitude, lat = ~Latitude, radius = ~n)



```

## Q18 Funding

Who has funded your research within the last 5 years?

### Funding distribution

The list given in the listing below has been manipulated to provide some
level of uniformity. Note that in this instance all contributions are
counted equally, i.e. a respondent may have suggested more than one
funding body - each of these is given a count of 1 regardless of how many were provided.

```{r funding}

# Calculate an x label with the folks that filled in this question.
funding %>% select(URN, num_range("Q18_", 1:7))  %>% 
            pivot_longer(cols = num_range("Q18_", 1:7),
                         names_to = NULL,
                         values_to =  "funding")         %>% 
            filter(!is.na(funding))                      %>%
            summarise(lab = paste0("Funding body (N=", n_distinct(URN),")")) -> my

funding %>% pivot_longer(cols = num_range("Q18_", 1:7),
                         names_to = NULL,
                         values_to =  "funding")         %>% 
            filter(!is.na(funding))                      %>%
            group_by(funding)                            %>% 
            tally()                                      %>% 
            filter(n > 2)                                %>%
            ggplot(aes(x = reorder(funding, -n), y = n, fill = n)) +
            geom_col(colour = "black") + ylim(0,115) +
            theme_bw() + xlab(my$lab) + ylab("Numbers") +
            scale_fill_distiller(palette = "Blues", direction = 1) +
            geom_text(aes(x = funding, label = n), vjust = -0.5, size = 3) +
            theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0),
                  legend.position = "None")
```

### Funding correlation

```{r funding_correlation}

# pick out the data that we want
funding %>% select(num_range("Q18_", 1:7)) -> q

# add an id
q$id <- 1:nrow(q)

# manipulate the form of the data - only use data with more than 4 values
q %>% pivot_longer(cols = num_range("Q18_", 1:7),
                   names_to = NULL,
                   values_to = "funding") %>% 
            filter(!is.na(funding) & funding != "Retired") %>% 
            group_by(funding) %>% 
            mutate(n = n()) %>% 
            filter(n > 4)   %>% 
            select(-n)      %>%
      mutate(val = ifelse(is.na(funding), 0L, 1L)) %>% 
      filter(!is.na(funding) & funding != "Retired") %>% 
      pivot_wider(names_from = funding,
                  values_fill = 0,
                  values_from = val) %>% 
      select(-id) -> q

# Remap embedded spaces to underscores
names(q) <- gsub(" ","_", names(q))

#q <- apply(q, 2, function(x) as.integer(x))

# Colour map
my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

# plot the correlation
plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.75*par("cex.lab"))

```

### Funding distribution normalised

The graph below normalises the contributions suggested by the responder,
i.e. if they mayd N suggestion then each suggestion contributes 1/N to
the total.

```{r funding_norm}

funding %>% mutate(nelements = rowSums(!is.na(.)))                             %>% 
            mutate(contrib = ifelse(nelements == 0, 0, round(1/nelements, 1))) %>% 
            pivot_longer(cols = num_range("Q18_", 1:7),
                         names_to = NULL,
                         values_to =  "funding")                               %>% 
            filter(!is.na(funding))                                            %>%
            group_by(funding)                                                  %>% 
            summarise(N = sum(contrib))                                        %>% 
            filter(N > 1)                                                      %>%
            ggplot(aes(x = reorder(funding, -N), y = N)) +
            geom_col(colour = "black", fill = "light blue") +
            theme_bw() + xlab("Funding body") + ylab("Numbers") +
            geom_text(aes(x = funding, label = N), vjust = -0.6, size = 2) +
            theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))
```

### Funding distribution normalised with career stage

```{r funding_norm_career}

bind_cols(funding, data["Q20"]) %>% select(num_range("Q18_", 1:7), career = Q20) %>% 
            mutate(nelements = rowSums(!is.na(select(., -career))))              %>% 
            mutate(contrib = ifelse(nelements == 0, 0, round(1/nelements, 1)))   %>% 
            pivot_longer(cols = num_range("Q18_", 1:7),
                         names_to = NULL,
                         values_to =  "funding")                                 %>% 
            filter(!is.na(funding))                                              %>%
            group_by(funding)                                                    %>% 
            mutate(n = sum(contrib))                                             %>% 
            filter(n  > 1)                                                       %>%
            group_by(funding, career)                                            %>% 
            mutate(N = sum(contrib))                                             %>% 
            distinct(funding, N, career)                                         %>% 
            ggplot(aes(x = reorder(funding, -N), y = N, fill = career)) +
            geom_col(colour = "black") +
            theme_bw() + xlab("Funding body") + ylab("Numbers") +
            geom_text(aes(x = funding, label = N), position = position_stack(vjust = 0.5), size = 2) +
            theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
            scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Listing of funding over the last 5 years

Who has funded your research within the last 5 years?

```{r funding_list, results='asis'}

listOther("Q18")

```

## Q19 Reserach discipline

Research Discipline: Level one codes from the Primary Research Areas
covered by ESRC discipline funding remit. Use the 'Other' option if your
discipline is not listed. (Please check all that apply.)

### Discipline of respondents

```{r research_disc}
data %>%  select(num_range("Q19_", 1:22))               %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "disciplines")        %>%
          filter(disciplines != 0)                      %>%
          mutate(N = n())                               %>% 
          group_by(disciplines)                         %>% 
          mutate(n = n())                               %>% 
          mutate(per = percent(n/N, accuracy = 1))      %>% 
          ggplot(aes(x = reorder(disciplines, -n), fill = n)) +
          geom_bar(colour = "black") +
          theme_bw() + ylim(0, 44) +
          xlab("Discipline") + ylab("Numbers") +
          scale_fill_distiller(palette = "Blues", direction = 1) +
          geom_text(aes(label = paste0(n, " (",per,")")), stat = "count", vjust = -0.5, size = 3) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0), legend.position = "None")
```

### Number of research disciplines selected

```{r num_disciplines}

data %>%  select(URN, num_range("Q19_", 1:22))          %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "disciplines")        %>%
          filter(disciplines != 0)                      %>%
          group_by(URN)                                 %>% 
          mutate(n = n())                               %>%                           
          distinct(URN, n)                              %>% 
          ggplot(aes(x = n, fill = ..count..)) + 
          geom_bar(colour ="black") + 
          theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
          xlab("Number of research disciplines chosen by an individual") +
          ylab("Number of people") + theme(legend.position = "None") +
          geom_text(aes(label = ..count..), stat = "count", size = 3, vjust = -0.5)
```

We can use the above information to normalise contribtuions so that if a research
discipline is mentioned N times it will only contribut 1/N times.
The other disciplines specified were:

```{r normalised_research_disciplines, echo = FALSE}

data %>%  select(URN, num_range("Q19_", 1:22))          %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                       values_to = "disciplines")       %>%
          filter(disciplines != 0)                      %>%
          group_by(URN)                                 %>%
          mutate(n = n())                               %>%
          group_by(disciplines)                         %>%
          summarise(Con = round(sum(1/n), 2))           %>%
          mutate(Tot = sum(Con))                        %>%
          mutate(Per = Con/Tot)                         %>%
          ggplot(aes(x = reorder(disciplines, -Per), y = Per, fill = Per)) +
          geom_col(colour ="black") +
          scale_y_continuous(labels = percent_format(accuracy = 1)) +
          theme_bw() + scale_fill_distiller(palette = "Blues", direction = 1) +
          xlab("Normalised research disciplines") +
          ylab("Percent") +
          theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "None") +
          geom_text(aes(label = percent(Per, accuracy = 1)), size = 3, vjust = -0.5)

```

The `Other` disciplines are:

```{r row_all_zeros, results='asis'}

data %>% select(num_range("Q19_", 1:22))          %>%  
         filter(if_all(Q19_1:Q19_22, ~ . == 0))   -> a
```

The number of people that did not specify an academic discipline `r nrow(a)`.

Look at cases greater than 1

```{r num_disciplines_tabulate, results='asis'}

data %>%  select(URN, num_range("Q19_", 1:22))                                %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "disciplines")                              %>%
          filter(disciplines != 0)                                            %>%
          group_by(URN)                                                       %>% 
          mutate(n = n())                                                     %>% 
          filter(n > 1)                                                       %>% 
          group_by(URN)                                                       %>% 
          mutate(choices = paste0(disciplines, collapse = ", "))              %>% 
          distinct(URN, n, choices)                                           %>% 
          ungroup()                                                           %>% 
          select(n, choices)                                                  %>% 
          group_by(n, choices)                                                %>% 
          mutate(N = n())                                                     %>% 
          ungroup()                                                           %>% 
          distinct(N, choices)                                                %>% 
          select(choices, N)                                                  %>% 
          filter(N > 1)                                                       %>% 
          arrange(desc(N))                                                    %>% 
          kbl(format="pipe", align = c("l","r"), col.names = c("Combined disciplines", "Count"))

          
          # %>% # Code to check consistency with the grah above
          # group_by(n) %>% 
          # mutate(NN = sum(N)) %>%  distinct(n, NN) %>%  arrange(desc(n))

```

### Correlation between choices

Overview of how choices have been used in combination.

```{r discipline_correlation}

data %>%  select(id = URN, num_range("Q19_", 1:22))          %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "disciplines")             %>%
          filter(disciplines != 0)                           %>% 
          mutate(val = 1L)                                   %>% 
          pivot_wider(names_from = disciplines,
                      values_fill = 0,
                      values_from = val)                    %>% 
          select(-id) -> q

# Colour map
my_colors <- brewer.pal(5, "Spectral")
my_colors <- colorRampPalette(my_colors)(100)

# plot the correlation
plotcorr(cor(q), col=my_colors[cor(q)*50+50], cex.lab = 0.75*par("cex.lab"))

```

### Discipline by career stage

```{r research_disc_careers}
data %>%  select(num_range("Q19_", 1:22), career = Q20) %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                      values_to = "disciplines")        %>%
          filter(disciplines != 0)                      %>%
          group_by(disciplines)                         %>% 
          mutate(N = n())                               %>% 
          group_by(disciplines, career)                 %>% 
          mutate( n = n())                              %>% 
          ggplot(aes(x = reorder(disciplines, -N), fill = career)) +
          geom_bar(colour = "black") +
          theme_bw() +
          xlab("Discipline") + ylab("Numbers") +
          geom_text(aes(x = disciplines, label = n), 
                    position = position_stack(vjust = 0.5), 
                                 stat = "count", size = 2) +
          scale_fill_brewer(palette = "Set1", name = "Career stage") +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))
```

### Discipline by percentage career stage

Percentages are in relation to a given career stage.

```{r research_disc_careers_per}
data %>%  select(num_range("Q19_", 1:22), career = "Q20") %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                       values_to = "disciplines")                 %>%
          filter(disciplines != 0)                                %>%
          group_by(career)                                        %>% 
          mutate(N = n())                                         %>% 
          group_by(disciplines, career)                           %>%
          mutate(n = n())                                         %>%
          mutate(y = n/N)                                         %>%
          mutate(per = percent(n/N, accuracy = 0.1))      %>%
          distinct(disciplines, career, per, y)                   %>%
          ggplot(aes(x = disciplines, y = y, fill = career)) +
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          geom_text(aes(x = disciplines, y = y, label = percent(y, accuracy = 1)), 
                        position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                        size = 2) +
          theme_bw() + scale_y_continuous(labels = percent) +
          xlab("Discipline") + ylab("Percentage") + labs(fill = "Career stage") +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Remove "Other" and "-"

```{r research_disc_careers_per2}

data %>%  select(num_range("Q19_", 1:22), career = "Q20") %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                       values_to = "disciplines")                 %>%
          filter(disciplines != 0)                                %>%
          group_by(career)                                        %>% 
          filter(!(career %in% c("Other", "-")))                  %>% 
          mutate(N = n())                                         %>% 
          group_by(disciplines, career)                           %>%
          mutate(n = n())                                         %>%
          mutate(y = n/N)                                         %>%
          mutate(per = percent(n/N, accuracy = 0.1))      %>%
          distinct(disciplines, career, per, y)                   %>%
          ggplot(aes(x = disciplines, y = y, fill = career)) +
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          geom_text(aes(x = disciplines, y = y, label = percent(y, accuracy = 1)), 
                        position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                        size = 2) +
          theme_bw() + scale_y_continuous(labels = percent) +
          xlab("Discipline") + ylab("Percentage") + labs(fill = "Career stage") +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
          scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Discipline by gender

```{r research_gender}

data %>%  select(num_range("Q19_", 1:22), gender = Q21)           %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                       values_to = "disciplines")                 %>%
          filter(disciplines != 0)                                %>%
          ggplot(aes(x = disciplines, fill = gender)) +
          geom_bar(colour = "black") +
          theme_bw() +
          xlab("Discipline") + ylab("Numbers") + labs(fill = "Gender") +
          geom_text(aes(x = disciplines, label = ..count..),
                   position = position_stack(vjust = 0.5), stat = "count", colour = "white", size = 2) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")


```

### Discipline by percentage gender

Percentages are in relation to a given gender.

```{r research_disc_gender_per}
data %>%  select(num_range("Q19_", 1:22), gender = Q21)           %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                       values_to = "disciplines")                 %>%
          filter(disciplines != 0)                                %>%
          group_by(gender)                                        %>% 
          mutate(N = n())                                         %>% 
          group_by(disciplines, gender)                           %>%
          mutate(n = n())                                         %>%
          mutate(y = n/N)                                         %>%
          mutate(per = percent(n/N, accuracy = 0.1))      %>%
          distinct(disciplines, gender, per, y)                   %>%
          ggplot(aes(x = disciplines, y = y, fill = gender)) +
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          geom_text(aes(x = disciplines, y = y, label = percent(y, accuracy = 1)), 
                        position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                        size = 2) +
          theme_bw() + scale_y_continuous(labels = percent) +
          xlab("Discipline") + ylab("Percentage") + labs(fill = "Gender") +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

Remove the low statistic components.

```{r research_disc_gender_per2}
data %>%  select(num_range("Q19_", 1:22), gender = Q21)           %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                       values_to = "disciplines")                 %>%
          filter(disciplines != 0)                                %>%
          filter(!(gender %in% lowstatsgender))                   %>% 
          group_by(gender)                                        %>% 
          mutate(N = n())                                         %>% 
          group_by(disciplines, gender)                           %>%
          mutate(n = n())                                         %>%
          mutate(y = n/N)                                         %>%
          mutate(per = percent(n/N, accuracy = 0.1))              %>%
          distinct(disciplines, gender, per, y)                   %>%
          ggplot(aes(x = disciplines, y = y, fill = gender)) +
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          geom_text(aes(x = disciplines, y = y, label = percent(y, accuracy = 1)), 
                        position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                        size = 2) +
          theme_bw() + scale_y_continuous(labels = percent) +
          xlab("Discipline") + ylab("Percentage") + labs(fill = "Gender") +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```
### Discipline by dissability

```{r research_disc_dissability}
data %>%  select(num_range("Q19_", 1:22), disability = Q23) %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                      values_to = "disciplines")            %>%
          filter(disciplines != 0)                          %>%
          group_by(disciplines)                             %>% 
          mutate(N = n())                                   %>% 
          group_by(disciplines, disability)                 %>% 
          mutate( n = n())                                  %>% 
          ggplot(aes(x = reorder(disciplines, -N), fill = disability)) +
          geom_bar(colour = "black") +
          theme_bw() +
          xlab("Discipline") + ylab("Numbers") +
          geom_text(aes(x = disciplines, label = n), position = position_stack(vjust = 0.5), 
                                 stat = "count", size = 2) +
          scale_fill_brewer(palette = "Set3", name = "Disability") +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))
```

### Discipline by % disability

```{r research_disc_disability_per2}

data %>%  select(num_range("Q19_", 1:22), dis = Q23)             %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = "questions",
                       values_to = "disciplines")                 %>%
          filter(disciplines != 0)                                %>%
          group_by(dis)                                           %>% 
          filter(dis != "-")                                      %>% 
          mutate(N = n())                                         %>% 
          group_by(disciplines, dis)                              %>%
          mutate(n = n())                                         %>%
          mutate(y = n/N)                                         %>%
          mutate(per = percent(n/N, accuracy = 0.1))              %>%
          distinct(disciplines, dis, per, y)                      %>%
          ggplot(aes(x = disciplines, y = y, fill = dis)) +
          geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
          geom_text(aes(x = disciplines, y = y, label = percent(y, accuracy = 1)), 
                        position = position_dodge2(width = 0.9, preserve = "single"), vjust = -0.5,
                        size = 3) +
          theme_bw() + scale_y_continuous(labels = percent) +
          xlab("Academic discipline") + ylab("Percentage") + labs(fill = "Disability") +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set3", name = "Dissability")
```

### Discipline by institution

```{r awareness_inst_per}

data %>% select(Institutions = CleanLocs, num_range("Q19_", 1:22))       %>%
         pivot_longer(cols = starts_with("Q19"),
                      names_to = NULL,
                      values_to ="discipline")                           %>%
         filter(discipline != 0 & !is.na(Institutions))                  %>%
         group_by(Institutions)                                          %>% 
         mutate(N = n())                                                 %>% 
         group_by(discipline, Institutions)                              %>%
         mutate(n = n())                                                 %>%
         ggplot(aes(x = discipline, y = Institutions, size = n/N,)) +
         geom_point(alpha = 0.25) +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0)) +
         theme(axis.text.y = element_text(size = 6)) +
         ylab("Institutions") + xlab("Discipline") +
         labs(size = "Institution %") + 
         scale_size_continuous(labels = percent)
```

The same graph but this time the percentage is by discipline (the % of
the discipline at each institution):

```{r awareness_dist_per}

data %>% select(Institutions = CleanLocs, num_range("Q19_", 1:22))       %>%
         pivot_longer(cols = starts_with("Q19"),
                      names_to = NULL,
                      values_to ="discipline")                           %>%
         filter(discipline != 0 & !is.na(Institutions))                  %>%
         group_by(discipline)                                            %>% 
         mutate(N = n())                                                 %>% 
         group_by(discipline, Institutions)                              %>%
         mutate(n = n())                                                 %>%
         ggplot(aes(x = discipline, y = Institutions, size = n/N,)) +
         geom_point(alpha = 0.25) +
         theme_bw() +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0)) +
         theme(axis.text.y = element_text(size = 6)) +
         ylab("Institutions") + xlab("Discipline") +
         labs(size = "Discipline %") + 
         scale_size_continuous(labels = percent_format(accuracy = 1))
```
As a tile diagram with actual numbers:

```{r awareness_dist_per_tile}

data %>% select(Institutions = CleanLocs, num_range("Q19_", 1:22))       %>%
         pivot_longer(cols = starts_with("Q19"),
                      names_to = NULL,
                      values_to ="discipline")                           %>%
         filter(discipline != 0 & !is.na(Institutions))                  %>%
         mutate(N = n())                                                 %>% 
         group_by(discipline, Institutions)                              %>%
         mutate(n = n())                                                 %>%
         mutate(per = percent(n/N, accuracy = 1))                        %>% 
         ggplot(aes(x = discipline, y = Institutions)) +
         theme_bw() +
         geom_tile(aes(fill = n)) +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0),
               axis.text.y = element_text(size = 6), legend.position = "None") +
         geom_text(aes(label = n), size = 2, colour = "white") +
         ylab("Institutions") + xlab("Discipline") +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")
```

### Other disciplines

We can simplify/generalise the values provided to get an overview

```{r simplified_other_disciplines}

data %>% select(OtherDisciplines)         %>% 
         group_by(OtherDisciplines)       %>% 
         filter(!is.na(OtherDisciplines)) %>% 
         tally()                          %>% 
         arrange(desc(n))                 %>% 
         kbl(format="pipe", align = c("l","r"), col.names = c("Discipline", "Count"))
```


The actual values provided are as below:

```{r other_disciplines, results = 'asis'}

listOther("Q19_a")

```

## Q20 Career stage

Career stage: Please select the career stage that most accurately
describes your role.

### Career stage

```{r career}

data %>%  select(career = Q20)                      %>%
          mutate(N = n())                           %>% 
          group_by(career)                          %>% 
          mutate(n =  n())                          %>% 
          mutate(per = percent(n/N, accuracy = 1))  %>% 
          distinct(n, per, career)                  %>% 
          ggplot(aes(x = reorder(career, -n),  y = n, fill = career)) +
          geom_col(colour = "black") +
          theme_bw() +
          xlab("Career stage") + ylab("Numbers")  +
          geom_text(aes(label = paste0(n," (", per, ")")), vjust = -0.5, size = 3) +
          scale_fill_brewer(palette = "Set1", name = "Career stage") + 
          theme(legend.position = "none")

```

### Career stage pie

```{r career_pie}

data %>%  select(career = Q20)     %>%
          mutate(N = n())          %>% 
          group_by(career)         %>% 
          mutate(per =  n()/N)     %>% 
          distinct(career, per)    %>% 
          ggplot(aes(x = "", y = per, fill = career)) +
          geom_bar(stat="identity", width=1, colour = "black") + coord_polar("y", start=0) +
          theme_void() +
          geom_text(aes(y = per, label = percent(per, accuracy = 1)), colour = "black", position = position_stack(0.5), size = 2.5) +
          scale_fill_brewer(palette = "Set1", name = "Career stage")
```

## Q21 Gender

Gender (we are asking this to ensure that we get a balance of the
community). If you prefer to self-describe, please write in the "Other"
option. We apologise in advance for "othering" you. Unfortunately, this
is the only write-in option available for multiple-choice questions on
this platform.

### Gender distribution

```{r gender}

data %>%  select(gender = Q21)                      %>%
          mutate(N = n())                           %>% 
          group_by(gender)                          %>% 
          mutate(n =  n())                          %>% 
          mutate(per = percent(n/N, accuracy = 1))  %>% 
          distinct(n, per, gender)                  %>% 
          ggplot(aes(x = reorder(gender, -n),  y = n, fill = gender)) +
          geom_col(colour = "black") +
          theme_bw() +
          xlab("Gender") + ylab("Numbers")  +
          geom_text(aes(label = paste0(n," (", per, ")")), vjust = -0.5, size = 3) +
          scale_fill_brewer(palette = "Set2", name = "Gender") +
          theme(legend.position = "none")

```

### Gender by career stage

```{r gender_career}
data %>% select(gender = Q21, career = Q20)                     %>%
         group_by(gender)                                       %>% 
         mutate(n = n())                                        %>% 
         ggplot(aes(x = gender, fill = career)) +
         geom_bar(colour = "black") +
         theme_bw() +
         geom_text(aes(label = ..count..), stat = "count", 
                   position = position_stack(vjust = 0.5), size = 2, colour = "white") +
         xlab("Gender") + ylab("Numbers") + labs(fill = "Career stage") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))
```

### Gender by career stage percent

```{r gender_career_per}

data %>% select(gender = Q21, career = Q20)                     %>%
         filter(!(gender %in% lowstatsgender |
                  career %in% c("-", "Other")))                 %>% 
         group_by(career)                                       %>% 
         mutate(N = n())                                        %>% 
         group_by(gender, career)                               %>% 
         mutate(n = n())                                        %>% 
         mutate(per = percent(n/N, accuracy = 1))               %>% 
         distinct(career, gender, n, N, per)                    %>% 
         ggplot(aes(x = career, y = n/N, fill = gender)) +
         geom_col(colour = "black") +
         theme_bw() + scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = per), position = position_stack(vjust = 0.5), size = 3, colour = "black") +
         xlab("Career stage") + ylab("percent") + labs(fill = "Gender") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

### Gender vs Career stage

A different representation of career vs gender.

```{r gender_career_pts}

data %>% select(gender = Q21, career = Q20) %>%
         group_by(gender, career)           %>%
         mutate(size = n())                 %>%
         ggplot(aes(x = gender,
                    y = career, colour = size)) +
         geom_point(aes(size = size)) + theme_bw() +
         geom_text(aes(x = gender,
                       y = career, label = size), vjust = 2) +
         xlab("Gender") + ylab("Career stage") + theme(legend.position = "none") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```
Same information in a tile diagram.

```{r gender_career_tile}

data %>% select(gender = Q21, career = Q20)             %>%
         mutate(N = n())                                %>% 
         group_by(gender, career)                       %>%
         mutate(size = n())                             %>%
         mutate(per = percent(size/N, accuracy = 1))    %>% 
         ggplot(aes(x = gender,
                    y = career, colour = size)) +
         geom_tile(aes(fill = size)) + 
         theme_bw() +
         geom_text(aes(x = gender,
                       y = career, label = paste0(size," (",per,")")), colour = "white") +
         xlab("Gender") + ylab("Career stage") + 
         scale_fill_continuous(high = "#132B43", low = "#56B1F7") + 
         theme(legend.position = "none") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```


```{r gender_career_points}

data %>% select(gender = Q21, career = Q20)             %>%
         filter(!(career %in% c("-","Other") | 
                  gender %in% lowstatsgender))          %>% 
         group_by(gender, career)                       %>%
         mutate(n = n())                                %>% 
         ggplot(aes(x = career, y = gender, fill = gender, size = n)) +
         geom_point() + 
         theme_bw() +
         ylab("Gender") + xlab("Career stage") +
         theme(legend.position = "none") +
         geom_text(aes(label = n), vjust = -2, size = 3) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```

```{r gender_career_corr, results='asis'}

data %>% select(gender = Q21, career = Q20)             %>%
         filter(!(career %in% c("-","Other") | 
                  gender %in% lowstatsgender))          %>% 
         group_by(gender, career)                       %>%
         tally() -> a

a$stage <-  c(1:4,1:4)

# Correlation between women and career stage
cat("Correlation between career stage and number of women ", cor(x = a$stage[a$gender == "Woman"], y = a$n[a$gender == "Woman"]),".\n")

# Correlation between women and career stage
cat("Correlation between career stage and number of men ", cor(x = a$stage[a$gender == "Man"], y = a$n[a$gender == "Man"]),".\n")


```

### Gender, career stage and ethnicity

```{r gender_career_ethnicity}

data %>% select(ethnicity = "Q22", career = "Q20", gender = "Q21") %>%
         group_by(gender, ethnicity, career)                       %>%
         tally()                                                   %>%
         ggplot(aes(x = career, y = ethnicity, size = n, colour = gender)) +
         geom_point(alpha = 0.25) + geom_jitter() + theme_bw() +
         xlab("Career stage") + ylab("Ethnicity") +
         labs(colour = "Gender", size = "Numbers") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8)) +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0))

```

### Gender distribution segmented by percentage by career stage

```{r gender_career_per2}

data %>% select(gender = Q21, career = Q20)                     %>%
         group_by(career)                                       %>% 
         mutate(N = n())                                        %>%
         group_by(gender, career)                               %>% 
         mutate(per = n()/N)                                    %>% 
         distinct(gender, career, per)                          %>% 
         ggplot(aes(x = gender, y = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2, vjust = -0.5) +
         xlab("Gender") + ylab("Percent") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

Removing the low statistics gender and career stage components

```{r gender_career_per3}

data %>% select(gender = Q21, career = Q20)                     %>%
         group_by(career)                                       %>% 
         mutate(N = n())                                        %>%
         filter(!(gender %in% lowstatsgender) & 
                  !(career %in% c("-", "Other")))               %>% 
         group_by(gender, career)                               %>% 
         mutate(per = n()/N)                                    %>% 
         distinct(gender, career, per)                          %>% 
         ggplot(aes(x = gender, y = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() + scale_y_continuous(labels = percent_format(accuracy = 1)) +
         geom_text(aes(label = percent(per, accuracy = 1)), 
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2, vjust = -0.5) +
         xlab("Gender") + ylab("Percent") +
         theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0)) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

### Other gender comments

```{r othergender, results='asis'}

listOther("Q21_a")

```


## Q22 Ethnic group

### Ethnicity distribution

```{r ethnicity}

data %>% select(ethnicity =  Q22)                 %>%
         mutate(N = n())                          %>% 
         group_by(ethnicity)                      %>%
         mutate(n = n())                          %>%
         mutate(per = percent(n/N, accuracy = 1)) %>% 
         distinct(n, ethnicity, per)              %>% 
         ggplot(aes(x = n, y = reorder(ethnicity, -n))) +
         geom_col(colour = "black", fill = "light blue") +
         theme_bw() + 
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8)) +
         xlab("Numbers") + ylab("Ethnicity") + xlim(0, 96) +
         geom_text(aes(y = ethnicity, label = paste0(n," (",per,")")), hjust = -0.2, size = 3)
  
```

### Ethnicity by career stage

```{r ethnicity_career}

data %>% select(ethnicity = "Q22", career = Q20)    %>%
         group_by(ethnicity)                        %>%
         mutate(N = n())                            %>%
         group_by(ethnicity, career)                %>% 
         ggplot(aes(y = reorder(ethnicity, -N), fill = career)) +
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Numbers") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8)) +
         geom_text(aes(label = ..count..), stat = "count", 
                   position = position_stack(vjust = 0.5), size = 2, colour = "white") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")

```

### Ethnicity by % pop career stage

```{r ethnicity_career_popper}

data %>% select(ethnicity = "Q22", career = Q20)    %>%
         filter(!is.na(ethnicity) & !is.na(career)) %>% 
         group_by(career)                           %>%
         mutate(N = n())                            %>%
         group_by(ethnicity, career)                %>% 
         mutate(per = n()/N)                        %>% 
         distinct(ethnicity, career, per)           %>% 
         ggplot(aes(y = ethnicity, x = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_x_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Percent") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8)) +
         geom_text(aes(label = percent(per, accuracy = 1)), hjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2, colour = "black") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")

```

Making the diagram a bit less busy by focusing on the non-White component.

```{r ethnicity_career_popper_nonwhite}

data %>% select(ethnicity = "Q22", career = Q20)    %>%
         filter(!is.na(ethnicity) & !is.na(career)) %>% 
         group_by(career)                           %>%
         mutate(N = n())                            %>%
         group_by(ethnicity, career)                %>% 
         mutate(per = n()/N)                        %>% 
         distinct(ethnicity, career, per)           %>%
         filter(!grepl("^White", ethnicity))        %>% 
         ggplot(aes(y = ethnicity, x = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_x_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Percent") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8)) +
         geom_text(aes(label = percent(per, accuracy = 1)), hjust = -0.5,
                   position = position_dodge2(width = 0.9, preserve = "single"), size = 2, colour = "black") +
         scale_fill_brewer(palette = "Set1", name = "Career stage")

```
or using a tile diagram:

```{r ethnicity_career_tile}

data %>% select(ethnicity = Q22, career = Q20)    %>%
         filter(!is.na(ethnicity) & !is.na(career)) %>% 
         mutate(N = n())                            %>%
         group_by(ethnicity, career)                %>% 
         mutate(n = n())                            %>% 
         mutate(per = percent(n/N, accuracy = 1))   %>% 
         distinct(ethnicity, career, per, n)        %>% 
         ggplot(aes(y = ethnicity, x = career, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Career stage") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8), legend.position = "none") +
         geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7") 

```
### Ethnicity and gender

```{r ethnicity_gender}

data %>% select(ethnicity = Q22, gender = Q21)    %>%
         group_by(gender)                           %>%
         mutate(N = n())                            %>%
         group_by(ethnicity, gender)                %>% 
         ggplot(aes(y = reorder(ethnicity, -N), fill = gender)) +
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Numbers") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8)) +
         geom_text(aes(label = ..count..), stat = "count", 
                   position = position_stack(vjust = 0.5), size = 2, colour = "white") +
         scale_fill_brewer(palette = "Set2", name = "Gender")

```
or as a tile diagram

```{r ethnicity_gender_tile}

data %>% select(ethnicity = Q22, gender = Q21)    %>%
         filter(!is.na(ethnicity) & !is.na(gender)) %>% 
         mutate(N = n())                            %>%
         group_by(ethnicity, gender)                %>% 
         mutate(n = n())                            %>% 
         mutate(per = percent(n/N, accuracy = 1))   %>% 
         distinct(ethnicity, gender, per, n)        %>% 
         ggplot(aes(y = ethnicity, x = gender, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Gender") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8), legend.position = "none") +
         geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7") 

```

### Ethnicity by Institution

Only showing instances where the count is greater than 3.

```{r ethnicity_institution}

data %>% select(ethnicity = Q22, Institution = CleanLocs) %>%
         group_by(ethnicity, Institution)                 %>%
         filter(!is.na(ethnicity) & !is.na(Institution))  %>% 
         mutate(N = n())                                  %>%
         filter(N > 3)                                    %>% 
         ggplot(aes(y = ethnicity, x = Institution, size = N)) +
         geom_point(alpha = 0.25, na.rm = TRUE) +
         theme_bw() +
         xlab("Institution") + ylab("Ethnicity") +
         scale_x_discrete(labels = abbreviate) + 
         scale_y_discrete(labels = abbreviate) + 
         theme(axis.text = element_text(size = 6)) +
         geom_text(aes(x = Institution, y = ethnicity, label = N), na.rm = TRUE,
                   vjust = 4, size = 2, colour = "black") +
         theme(axis.text.x = element_text(angle = -90, vjust = 0.5, hjust=0)) 

```

Can try to use a tile diagram but this is a bit busy.

```{r ethnicity_institution_tile}

data %>% select(ethnicity = Q22, institution = CleanLocs)    %>%
         filter(!is.na(ethnicity) & !is.na(institution))     %>% 
         mutate(N = n())                                     %>%
         group_by(ethnicity, institution)                    %>% 
         mutate(n = n())                                     %>% 
         mutate(per = percent(n/N, accuracy = 1))            %>% 
         distinct(ethnicity, institution, per, n)            %>% 
         ggplot(aes(y = ethnicity, x = institution, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Institution") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8), 
               axis.text.x = element_text(size = 6, angle = -90, vjust = 0.15, hjust=0),
               legend.position = "none") +
         #geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         geom_text(aes(label = n), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7") 

```

Zooming in to the non-white component (to make the diagram lss busy).

```{r ethnicity_institution_nonwhite_tile}

data %>% select(ethnicity = Q22, institution = CleanLocs)    %>%
         filter(!is.na(ethnicity) & !is.na(institution))     %>% 
         mutate(N = n())                                     %>%
         group_by(ethnicity, institution)                    %>% 
         mutate(n = n())                                     %>% 
         mutate(per = percent(n/N, accuracy = 1))            %>% 
         filter(!grepl("^White", ethnicity))                 %>% 
         distinct(ethnicity, institution, per, n)            %>% 
         ggplot(aes(y = ethnicity, x = institution, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Institution") + ylab("Ethnicity") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8), 
               axis.text.x = element_text(size = 6, angle = -90, vjust = 0.15, hjust=0),
               legend.position = "none") +
         #geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         geom_text(aes(label = n), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7") 

```

### Other ethnicity

```{r OtherEthnicity, results='asis'}

listOther("Q22_a")

```

## Q23 Disability

Do you consider yourself to have a disability

### Disability

```{r dissability}

data %>% select(dis = "Q23")                      %>% 
         mutate(N = n())                          %>% 
         group_by(dis)                            %>% 
         mutate(n = n())                          %>% 
         mutate(per = percent(n/N, accuracy = 1)) %>% 
         ggplot(aes(x = reorder(dis, -n), fill = dis)) +
         geom_bar(colour = "black") +
         theme_bw() +
         geom_text(aes(label = paste0(n, " (", per, ")")), stat = "count", vjust = -0.5, size = 3) +
         xlab("Disability") + ylab("Numbers")  + theme(legend.position = "None") +
         scale_fill_brewer(palette = "Set3", name = "Disability")
```

### Disability by career stage

```{r disability_career}

data %>% select(dis = Q23, career = Q20) %>% 
         group_by(dis)                   %>% 
         mutate(n = n())                 %>% 
         group_by(dis, career)           %>% 
         ggplot(aes(x = reorder(dis, -n), fill = career)) +
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Disability") + ylab("Numbers") +
         geom_text(aes(x = dis, label = ..count..),
                   position = position_stack(vjust = 0.5), stat = "count", colour = "black", size = 3) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

As a tile diagram of the percentage of the whole population:

```{r disability_career_tile}

data %>% select(dis = Q23, career = Q20)           %>% 
         mutate(N = n())                           %>% 
         group_by(dis, career)                     %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>% 
         ggplot(aes(x = dis, y = career, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Disability") + ylab("Career stage") +
         geom_text(aes(label = n), colour = "black", size = 3) +
         theme(legend.position = "None") +
         geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         #geom_text(aes(label = n), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")

```

### Disability as % of career stage

```{r disability_career_per}

data %>% select(dis = Q23, career = Q20)    %>% 
         group_by(career)                   %>% 
         mutate(N = n())                    %>% 
         group_by(dis, career)              %>% 
         mutate(per = n()/N)                %>% 
         distinct(career, dis, per)         %>% 
         ggplot(aes(x = dis, y = per, fill = career)) +
         geom_col(position = position_dodge2(width = 0.9, preserve = "single"), colour = "black") +
         theme_bw() +
         scale_y_continuous(labels = percent_format(accuracy = 1)) +
         xlab("Disability") + ylab("Percent") +
         geom_text(aes(x = dis, label = percent(per, accuracy = 1)),
                   position = position_dodge2(width = 0.9, preserve = "single"), colour = "black", size = 2, vjust = -0.5) +
         scale_fill_brewer(palette = "Set1", name = "Career stage")
```

As a tile diagram with percentages in relation to each career stage population.

```{r disability_career_tile2}

data %>% select(dis = Q23, career = Q20)           %>% 
         group_by(career)                          %>% 
         mutate(N = n())                           %>% 
         group_by(dis, career)                     %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>% 
         ggplot(aes(x = dis, y = career, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Disability") + ylab("Career stage") +
         geom_text(aes(label = n), colour = "black", size = 3) +
         theme(legend.position = "None") +
         geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         #geom_text(aes(label = n), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")

```
### Disability by gender

```{r disability_gender}

data %>% select(dis = Q23, gender = Q21) %>% 
         group_by(dis)                   %>% 
         mutate(n = n())                 %>% 
         group_by(dis, gender)           %>% 
         ggplot(aes(x = reorder(dis, -n), fill = gender)) +
         geom_bar(colour = "black") +
         theme_bw() +
         xlab("Disability") + ylab("Numbers") +
         geom_text(aes(x = dis, label = ..count..),
                   position = position_stack(vjust = 0.5), stat = "count", colour = "black", size = 3) +
         scale_fill_brewer(palette = "Set2", name = "Gender")
```

As a tile diagram with percentages as a fraction of the entire population:

```{r disability_gender_tile}

data %>% select(dis = Q23, gender = Q21)           %>% 
         mutate(N = n())                           %>% 
         group_by(dis, gender)                     %>% 
         mutate(n = n())                           %>% 
         mutate(per = percent(n/N, accuracy = 1))  %>% 
         ggplot(aes(x = dis, y = gender, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Disability") + ylab("Gender") +
         geom_text(aes(label = n), colour = "black", size = 3) +
         theme(legend.position = "None") +
         geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         #geom_text(aes(label = n), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")

```

### Disability vs Institution

```{r disability_institution_tile}

data %>% select(dis = Q23, institution = CleanLocs)    %>%
         filter(!is.na(dis) & !is.na(institution))     %>% 
         mutate(N = n())                               %>%
         group_by(dis, institution)                    %>% 
         mutate(n = n())                               %>% 
         mutate(per = percent(n/N, accuracy = 1))      %>% 
         distinct(dis, institution, per, n)            %>% 
         ggplot(aes(y = dis, x = institution, fill = n)) +
         geom_tile(colour = "black") +
         theme_bw() +
         xlab("Institution") + ylab("Disability") +
         scale_y_discrete(expand = expansion(add = 0.75), 
                          labels = function(x) stringr::str_wrap(x, width = 35)) + 
         theme(axis.text.y = element_text(size = 8), 
               axis.text.x = element_text(size = 6, angle = -90, vjust = 0.15, hjust=0),
               legend.position = "none") +
         #geom_text(aes(label = paste0(n," (", per,")")), colour = "white", size = 3) +
         geom_text(aes(label = n), colour = "white", size = 3) +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7") 
```

### Disability by discipline

```{r research_dis_tile}
data %>%  select(dis = Q23, num_range("Q19_", 1:22))      %>%
          pivot_longer(cols = num_range("Q19_", 1:22),
                       names_to = NULL,
                      values_to = "disciplines")          %>%
          filter(disciplines != 0)                        %>%
          mutate(N = n())                                 %>% 
          group_by(dis, disciplines)                      %>% 
          mutate(n = n())                                 %>% 
          mutate(per = percent(n/N, accuracy = 1))        %>% 
          ggplot(aes(x = reorder(disciplines, -n), y = dis)) +
          geom_tile(aes(fill = n), colour = "black") +
          theme_bw() +
          xlab("Discipline") + ylab("Disability") +
          #geom_text(aes(label = paste0(n, " (",per,")")), colour = "white", size = 2) +
          geom_text(aes(label = n), colour = "white", size = 2) +
          theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust=0),
                legend.position = "None")  +
         scale_fill_continuous(high = "#132B43", low = "#56B1F7")
```

## Q24-Q27 Not relevant

These questions asked about inclusion in prize draw and volunteering for
interviews.

## Q28 Comments about the survey

Do you have any other comments about this survey?

### List comments

```{r survey_comments, results = 'asis'}

listOther("Q28")

```
